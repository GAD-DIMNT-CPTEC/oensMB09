#!/bin/ksh -x
#help#
#*******************************************************************#
#                                                                   #
#      Name:           week_mean_prec.scr                           #
#                                                                   #
#      Function:       This script produces week mean               #
#                      precipitation figures                        #
#                                                                   #
#      Date:           March 15th, 2005.                            #
#      Last change:    March 15th, 2005.                            #
#                                                                   #
#      Valid Arguments for week_mean_prec.scr                       #
#                                                                   #
#      First  : TRC    : three-digit triangular truncation          #
#      Second : LV     : two-digit number of vertical sigma-layers  #
#      Third  : LABELI : initial forecasting label                  #
#      Fourth : NFDAYS : number of forecasting days                 #
#      Fifth  : EXP    : experiment number                          #
#                                                                   #
#              LABELx : yyyymmddhh                                  #
#                       yyyy = two digit year                       #
#                       mm   = two digit month                      #
#                       dd   = two digit day                        #
#                       hh   = two digit hour                       #
#                                                                   #
#*******************************************************************#
#help#
#
#       Help:
#

echo "INICIANDO... \(set \-x\)"
set -x

. ../../include/config.sx6

LABELI=$1
if [ -s $LABELI ]; then
      echo "ERRO: FALTA PARAMETRO.\nrunmodgmpi.sx6 YYYYMMDDHH"
      exit 1
else
      if [ ${#LABELI} -lt 10 ]; then
            echo "ERRO: PARAMETRO INCORRETO.\nrunmodgmpi.sx6 YYYYMMDDHH"
            exit 2
      else
            YYYY=`echo $LABELI |cut -c 1-4`
            MM=`echo $LABELI |cut -c 5-6`
            DD=`echo $LABELI |cut -c 7-8`
            HH=`echo $LABELI |cut -c 9-10`

            LABELF=`date -d "${NFDAYS} day ${YYYY}${MM}${DD}" +"%Y%m%d${HH}"`
            YYYYF=`echo $LABELF |cut -c 1-4`
            MMF=`echo $LABELF |cut -c 5-6`
            DDF=`echo $LABELF |cut -c 7-8`
            HHF=`echo $LABELF |cut -c 9-10`
      fi
fi

PREFX=$2

if [ -s $PREFX ]; then
      echo "ERRO - PARAMETRO PERT\nFORMATO: runrectigge.sx6 yyyymmddhh 01N"
      exit 2
fi
NFCTDY=${FSCT}
NMDAYS=${FSCT}
#NMEMBR=`echo "${NPERT}*2+1" | bc -l`
NMEMBR=`echo "${NPERT}*2+1" | bc -l` # +1 para ler enmrmv
OUT=out
NPROC=1
RESOL=T${TRC}

RESOL=T${TRC}L${LV}
resol=t${TRC}l${LV}
TRC=T${TRC}

#
# Set TERM
#
TERM=vt100; export TERM

#
# Grads
#
export GADDIR=/usr/local/grads/dat
export GASCRP="/usr/local/grads/lib ${HOME}/users/christopher/GrADS/lib"
export GAUDFT=/usr/local/grads/udf/udft

#
#   Set LABELF
#
LABELF=`${HOME}/bin/caldate.3.0.1 ${LABELI} + ${NFDAYS}d yyyymmddhh`

#
#   Set Horizontal Truncation (TRUNC) and Vertical Layers (LEV)
#
RESOL=${TRC}
NIVEL=L${LV}
CASE=$RESOL$NIVEL
MODELID=cptec002

#
# Set directories
#
#   DIRSCR: is the directory of the scripts which grib model data
#
yydir=`awk 'BEGIN {print substr("'${LABELI}'",1,4)}'`
mmdir=`awk 'BEGIN {print substr("'${LABELI}'",5,2)}'`
dddir=`awk 'BEGIN {print substr("'${LABELI}'",7,2)}'`
resol=`awk 'BEGIN {print tolower("'${RESOL}'")}'`
nivel=`awk 'BEGIN {print tolower("'${NIVEL}'")}'`
echo "resol="$resol
echo "nivel="$nivel

DIRSCR=${OPERM}/prcmed
DIRGIF=${ROPERM}/prcmed/gif
DIRBIA=${OPERM}/prcmed
DIRBANG=${ROPERM}/prcmed/dataout/T126L28
DIRINP=${ROPERM}/prcmed/dataout/T126L28
dirgrb=${ROPERM}/prcmed/dataout/T126L28/grib
mkdir -p ${ROPERM}/prcmed/gif ${ROPERM}/prcmed/dataout/T126L28/grib
cd $DIRSCR
#
#   Set prefix of files
#
GPOS=GPRCENM
LSTFILE=`ls $DIRBANG/*${LABELI}*.lst`
ls $DIRBANG/${GPOS}${LABELI}*ctl > $LSTFILE

#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Remove old files 
#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

cd ${DIRSCR}
#
#   function calday
#
calday ()
{
yi=`awk 'BEGIN {print substr("'${LABELI}'",1,4)}'`
mi=`awk 'BEGIN {print substr("'${LABELI}'",5,2)}'`
di=`awk 'BEGIN {print substr("'${LABELI}'",7,2)}'`
hi=`awk 'BEGIN {print substr("'${LABELI}'",9,2)}'`
#
let ybi=${yi}%4
if [ ${ybi} = 0 ]
then
set -A md 31 29 31 30 31 30 31 31 30 31 30 31
else
set -A md 31 28 31 30 31 30 31 31 30 31 30 31
fi
let dr=${di}-${nrdays}
let mr=${mi}
let yr=${yi}
let hr=${hi}
if [ dr -le 0 ]
then
let nr=${mi}-2
if [ nr -lt 0 ]
then let nr=11
fi
let dr=dr+md[${nr}]
let mr=${mi}-1
fi
if [ mr -le 0 ]
then
let mr=12
let yr=yr-1
fi
if [ dr -lt 10 ]
then DR=0${dr}
else DR=${dr}
fi
if [ mr -lt 10 ]
then MR=0${mr}
else MR=${mr}
fi
YR=${yr}
if [ hr -lt 10 ]
then HR=0${hr}
else HR=${hr}
fi
let str=${MR}-1
LSTD=${md[${str}]}
}

for nrdays in 2 3 4 5 6
do
  calday
  LABELR=${YR}${MR}${DR}${HR}
  LASTDAY=${LSTD}
  yydirold=${YR}
  mmdirold=${MR}
  dddirold=${DR}
  echo "LABELR  = ${LABELR}"

  DIRSFCREC=${DIRBANG}/PRECMED/$yydirold/$mmdirold/$dddirold

#  echo "rm -f ${DIRSFCREC}/${GPOS}*${LABELR}*"
#AMM   rm -f ${DIRSFCREC}/${GPOS}*${LABELR}*
      
#  echo "rmdir ${DIRSFCREC}"
#AMM   rmdir ${DIRSFCREC}
#  if [ ${dddirold} -eq ${LASTDAY} ]
#  then
#     echo "rmdir ${DIRBANG}/PRECMED/$yydirold/$mmdirold"
#AMM      rmdir ${DIRBANG}/PRECMED/$yydirold/$mmdirold
#     if [ ${mmdirold} -eq 12 ]
#     then
#        echo "rmdir ${DIRBANG}/PRECMED/$yydirold"
#AMM         rmdir ${DIRBANG}/PRECMED/$yydirold
#     fi
#  fi

done
# End of remove old files +++++++++++++++++++++++++++++++++++++++++++

#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Grib the files
#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

#
# Set characteristics of the product
#
tit='CPTEC GLOBAL ENSEMBLE WEEK MEAN PRECIPITATION '$CASE'  COLD' 

#
# Get the list of files to be gribed
#

#echo "rm -f ${dirgrb}/${GPOS}${LABELI}*"
#rm -f ${dirgrb}/${GPOS}${LABELI}*

for arq in `ls ${DIRINP}/${GPOS}${LABELI}*P.fct.$CASE.ctl`
do
arq1=`basename $arq`
arqout=`awk 'BEGIN { print substr("'$arq1'",1,40) }'`

op="-i ${DIRINP}/${arq1} -o ${dirgrb}/${arqout} -center $MODELID -format grads_grib -ftype ctl -table ${OPERM}/prcmed/scripts/cptec.table -v -title ${tit}"
echo "lats4d $op"
${GRADSB}/lats4d $op

subup=${arqout}
sublo=`awk 'BEGIN {print tolower("'$subup'")}'`
cat $dirgrb/$sublo.ctl | sed "s/$sublo/$subup/g" > $dirgrb/ctl.tmp
mv  $dirgrb/ctl.tmp $dirgrb/$sublo.ctl

mv $dirgrb/$sublo.ctl $dirgrb/$subup.ctl
mv $dirgrb/$sublo.gmp $dirgrb/$subup.gmp
mv $dirgrb/$sublo.grb $dirgrb/$subup.grb
head -3 $dirgrb/$subup.ctl>$dirgrb/$subup.ctl.tmp
let l=`wc -l $dirgrb/$subup.ctl|awk '{print $1}'`-3
tail -$l $dirgrb/$subup.ctl>>$dirgrb/$subup.ctl.tmp
mv -f $dirgrb/$subup.ctl.tmp $dirgrb/$subup.ctl

echo "$DIRINP/$subup.ctl" >> $dirgrb/${GPOS}${LABELI}${LABELF}P.fct.$CASE.lst
echo "$DIRINP/$subup.gmp" >> $dirgrb/${GPOS}${LABELI}${LABELF}P.fct.$CASE.lst
echo "$DIRINP/$subup.grb" >> $dirgrb/${GPOS}${LABELI}${LABELF}P.fct.$CASE.lst
done

#
# Move grib files to archive directory
#

#echo "rm -f $DIRINP/${GPOS}${LABELI}*"
#      rm -f $DIRINP/${GPOS}${LABELI}*
echo "mv -f $dirgrb/${GPOS}${LABELI}* $DIRINP"
      mv -f $dirgrb/${GPOS}${LABELI}* $DIRINP
#
# End of grib +++++++++++++++++++++++++++++++++++++++++++


#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Generate the week mean climatological precipitation files
#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

#rm -f filefct${LABELI}.${RESOL}
#rm -f fileclm${LABELI}.${RESOL}
cd ${OPERM}/prcmed/scripts
# First week
LABELWI=`${HOME}/bin/caldate.3.0.1 ${LABELI} +  1d yyyymmddhh`
LABELWF=`${HOME}/bin/caldate.3.0.1 ${LABELI} +  7d yyyymmddhh`
dayint_mod_medw.exe ${LABELI} ${LABELWI} ${LABELWF}
prec_clim_inmet.exe ${LABELI} ${LABELWI} ${LABELWF}
tmed_clim_inmet.exe ${LABELI} ${LABELWI} ${LABELWF}

echo "${DIRINP}/${GPOS}${LABELI}${LABELWF}P.fct.${CASE}.ctl" >> filefct${LABELI}.${RESOL}
echo "cprec${LABELI}${LABELWF}.ctl" >> fileclm${LABELI}.${RESOL}

# Second week
LABELWI=`${HOME}/bin/caldate.3.0.1 ${LABELI} +  8d yyyymmddhh`
LABELWF=`${HOME}/bin/caldate.3.0.1 ${LABELI} + 14d yyyymmddhh`
dayint_mod_medw.exe ${LABELI} ${LABELWI} ${LABELWF}
prec_clim_inmet.exe ${LABELI} ${LABELWI} ${LABELWF}
tmed_clim_inmet.exe ${LABELI} ${LABELWI} ${LABELWF}

echo "${DIRINP}/${GPOS}${LABELI}${LABELWF}P.fct.${CASE}.ctl" >> filefct${LABELI}.${RESOL}
echo "cprec${LABELI}${LABELWF}.ctl" >> fileclm${LABELI}.${RESOL}

# End of generation the week mean climatological precipitation ++++++

yyyy=`echo ${LABELI}$ | cut -c 1-4`
mm=`echo ${LABELI}$ | cut -c 5-6`
dd=`echo ${LABELI}$ | cut -c 7-8`
#AAF cp -rpf cpr*${LABELI}* ${BANGU}/produtos/prcmed/${yyyy}/${mm}/${dd}/

#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Produce the graphics
#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

#NWK -> number of weeks to be plotted
NWK=2
/usr/local/grads/bin/gradsc -lb << EOT
run plot_wmp.gs
${LABELI} ${NWK} ${CASE} ${DIRGIF} ${DIRBIA}
${RESOL} ${NWK} ${LABELI}
EOT

/usr/local/grads/bin/gradsc -lb << EOT
run plot_wmp_as.gs
${LABELI} ${NWK} ${CASE} ${DIRGIF} ${DIRBIA}
${RESOL} ${NWK} ${LABELI}
EOT

#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Remove temporary files
#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

yyyy=`echo $LABELI | cut -c 1-4`
mm=`echo $LABELI | cut -c 5-6`
dd=`echo $LABELI | cut -c 7-8`
#AAF cp -rpf cpr*${LABELI}* ${BANGU}/produtos/prcmed/${yyyy}/${mm}/${dd}/
#AAF cp -rpf bia*${LABELI}* ${BANGU}/produtos/prcmed/${yyyy}/${mm}/${dd}/

#rm -f cprec${LABELI}*
rm -f fileclm${LABELI}.${RESOL}
rm -f filefct${LABELI}.${RESOL}

exit



#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Put figures at external machine
#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

#AMM nrdays=4
#AMM calday
#AMM labelr4=${YR}${MR}${DR}${HR}
#AMM nrdays=3
#AMM calday
#AMM labelr3=${YR}${MR}${DR}${HR}
#AMM nrdays=2
#AMM calday
#AMM labelr2=${YR}${MR}${DR}${HR}
#AMM rm -f putrec.${date}.${CASE}
#AMM cat << EOT > putrec.${date}.${CASE}
#AMM user pnt &arun/a*
#AMM bin 
#AMM cd ${DIRGPRC}
#AMM mdelete ${GPOS}${stt}${labelr4}*
#AMM mdelete ${GPOS}${stt}${labelr3}*
#AMM mdelete ${GPOS}${stt}${labelr2}*
#AMM lcd ${DIROUT}
#AMM mput ${GPOS}${stt}${LABELI}*
#AMM EOT
#AMM ftp -in tucupi < putrec.${date}.${CASE}
#AMM rm -f putrec.${date}.${CASE}

exit

