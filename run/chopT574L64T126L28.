#!/bin/ksh
#
#
#*************************************************************#
#                                                             #
#     Name:        chopT574L64T126L28.                       #
#                                                             #
#     Function:    This script file is used to set the        #
#                  environmental variables and submit the     #
#                  initial condition chooping script.         #
#                  It generates a new initial condition       #
#                  in a new given resolution.                 #
#                                                             #
#*************************************************************#
#
# Set date (year,month,day) and hour (hour:minute) 
#
#PBS -l cpunum_prc=1
#PBS -l tasknum_prc=1
#PBS -l cputim_job=1000.0
#PBS -l memsz_job=32GB
#PBS -o :/gfs/home3/modoper/tempo/global/oens/run/setout/chopT574L64T126L28..2012021404:23:52.out.%s
#PBS -j o
#PBS -N CHOPT126
#
# DATE=yyyymmdd
# HOUR=hh:mn
#
DATE=20120214
HOUR=04:23
EXT=out
echo 'Date: '${DATE}
echo 'Hour: '${HOUR}
echo 'Case: '${EXT}
export DATE HOUR EXT
#
# Set labels (date, UTC hour, ...)
#
# LABELI = yyyymmddhh
# LABELI = initial condition label
#
LABELI=2012021400
export LABELI
echo ${LABELI}
#
# Prefix names for the FORTRAN files
#
# NAMEI - Input Initial Condition file's prefix
# NAMEO - Output Initial Condition file's prefix
# NAMSG - New Delta Sigma file's prefix
# NAMTP - New Topography file's prefix
# NAMGD - NCEP GDAS Initial Condition file's prefix
# NAMZI - Input Ozone file's prefix
# NAMZO - Output Ozone file's prefix
# NAMTI - Input Tracers file's prefix
# NAMTO - Output Tracers file's prefix
#
NAMEI=GANLAVN
NAMEO=GANLAVN
NAMSG=Delta_Sigma
if [ "NO" = "YES" ]
then
  NAMTP=Topography
else
  rm -f TopoFake.T126
  NAMTP=TopoFake
fi
if [ "AVN" = "AVN" ]
then
  NAMGD=gblav
else
  NAMGD=gdas1
fi
NAMZI=OZONAVN
NAMZO=OZONAVN
NAMTI=TRACAVN
NAMTO=TRACAVN
export NAMEI NAMEO NAMSG NAMTP NAMGD NAMZI NAMZO NAMTI NAMTO
#
# Suffixes names for the initial condition files
#
# EXTI - Input Initial Condition file's extension
# EXTO - Output Initial Condition file's extension
# EXZT - Output Ozone and Tracers file's extension
# EXTG - NCEP GDAS Initial Condition file's extension
#
EXTI=S.unf.
EXTO=S.unf.
EXZT=S.grd.
typeset -Z2 hi
hi=00
EXTG=.T${hi}Z.SAnl.
export EXTI EXTO EXZT EXTG
#
# Set directories
#
# SRCNAME:     name of main program source.
# SRCSUBDIR:   subdirectory for sources.
# SRCMAINDIR:  directory for sources, scripts and printouts.
# DATAMAINDIR: directory for input and output files.
# GDASDIR:     directory for NCEP initial condition
# GRADSDIR:    directory for GrADS output
#
SRCNAME=Chopping
SRCSUBDIR=Chopping
SRCMAINDIR=/gfs/home3/modoper/tempo/global/oens
DATAMAINDIR=/gfs/dk22/modoper/tempo/global/oens
GDASDIR=/gfs/dk22/modoper/tempo/global/oens/model/datain
GRADSDIR=/gfs/home3/modoper/tempo/global/oens/Chopping/dataout
export SRCNAME SRCSUBDIR SRCMAINDIR DATAMAINDIR GDASDIR GRADSDIR
echo ${SRCNAME}
echo ${SRCSUBDIR}
echo ${SRCMAINDIR}
echo ${DATAMAINDIR}
echo ${GDASDIR}
echo ${GRADSDIR}
#
cd ${SRCMAINDIR}/run
#
# Set Horizontal Truncation and Vertical Layers
#
TRUNCI=T574
LEVI=L64
TRUNCO=T126
LEVO=L28
export TRUNCI LEVI TRUNCO LEVO
#
# Set machine
#
MACH=
export MACH
#
# Set option for compiling or not the source codes.
#
# If COMPILE=make then only the modified sources will be compiled.
# If COMPILE=clean then the touch files will be removed and 
#            all sources will be compiled.
#           =run for run with no compilation
#
# If COMPILE is make or clean then the script generates the binary file 
#            and exits;
#            if it is run then the script runs the existent binary file.
#
COMPILE=run
export COMPILE
echo ${COMPILE}
#
#   Set envoirement variables for output time diagnostics
#
#   F_PROGINF gives the elapsed, user, system and vector instruction
#             execution time, and execution count of all instructions
#             and number of vector instruction executions.
#   F_FILEINF gives informations about I/O operations.
#
F_PROGINF=DETAIL
export F_PROGINF
#F_FILEINF=DETAIL
#export F_FILEINF
#
# Set FORTRAN compilation flags
#
# -pvctl noaltcode either scalar or vector code is generated at compilation
# -O nodiv         division may not be changed to reciprocal multiplication
# -O nomove        not move invariant expression outside the loop
# -float0          floating-point data format IEEE is enabled
# -ew              sets the basic numeric size to 8 bytes
#
FTNFLAG=' -float0 -ew -w -Wf" -pvctl noaltcode noassume vwork=stack -O nodiv nomove " '
#export FTNFLAG
#
# Set FORTRAN compiler name
#
FTN=
#export FTN
#
# Set environmental variables to binary conversion
#
F_UFMTIEEE=10,15,20,25,30,35,40,45,50,55,60,65,70,75
#export F_UFMTIEEE
F_UFMTADJUST10=TYPE2
F_UFMTADJUST15=TYPE2
F_UFMTADJUST20=TYPE2
F_UFMTADJUST25=TYPE2
F_UFMTADJUST30=TYPE2
F_UFMTADJUST35=TYPE2
F_UFMTADJUST40=TYPE2
F_UFMTADJUST45=TYPE2
F_UFMTADJUST50=TYPE2
F_UFMTADJUST55=TYPE2
F_UFMTADJUST60=TYPE2
F_UFMTADJUST65=TYPE2
F_UFMTADJUST70=TYPE2
F_UFMTADJUST75=TYPE2
#export F_UFMTADJUST10 F_UFMTADJUST15 F_UFMTADJUST20 F_UFMTADJUST25 F_UFMTADJUST30
#export F_UFMTADJUST35 F_UFMTADJUST40 F_UFMTADJUST45 F_UFMTADJUST50 F_UFMTADJUST55
#export F_UFMTADJUST60 F_UFMTADJUST65 F_UFMTADJUST70 F_UFMTADJUST75
#
F_SETBUF=4096
#export F_SETBUF
#echo " F_SETBUF = ${F_SETBUF}"
#
# Set Source and Namelist Directories
#
SRC=${SRCMAINDIR}/${SRCSUBDIR}/source
NML=${SRCMAINDIR}/${SRCSUBDIR}/bin
export SRC NML
echo ${SRC}
echo ${NML}
#
# Include File
#
  if [ "${COMPILE}" != "run" ]
  then
#
cd ${SRC}
#
cat <<EOT > m_Parameters.n

! SELECTED_INT_KIND(R):
!   The value of the result is the kind type parameter value 
!   of the integer type that can represent all integer values 
!   n in the range -10**R < n < 10**R
!   R must be a scalar of integer type (Ri4, Ri8).

! SELECTED_REAL_KIND(P,R):
!   The value of the result is the kind type parameter value 
!   of the real type that has a decimal precision greater than 
!   or equal to P digits as returned by the function PRECISION 
!   and a decimal exponent range greater than or equal to R 
!   as returned by the function RANGE.
!   P (optional) must be a scalar of integer type (Pr4, Pr8). 
!   R (optional) must be a scalar of integer type (Rr4, Rr8).

INTEGER, PARAMETER :: Ri4=9,  Ri8=15, &
                      Pr4=6,  Rr4=37, &
                      Pr8=15, Rr8=307

INTEGER, PARAMETER, PUBLIC :: ki4=SELECTED_INT_KIND(Ri4)
INTEGER, PARAMETER, PUBLIC :: ki8=SELECTED_INT_KIND(Ri8)
INTEGER, PARAMETER, PUBLIC :: kr4=SELECTED_REAL_KIND(Pr4,Rr4)
INTEGER, PARAMETER, PUBLIC :: kr8=SELECTED_REAL_KIND(Pr8,Rr8)

EOT
if (diff m_Parameters.n m_Parameters.h > /dev/null)
then
    echo "m_Parameters.n and m_Parameters.h are the same"
    rm -f m_Parameters.n
else
    echo "m_Parameters.n and m_Parameters.h are different"
    mv m_Parameters.n m_Parameters.h
fi
#
  fi
#
# Namelist File
#
  if [ "${COMPILE}" = "run" ]
  then
#
ganl=${DATAMAINDIR}/${SRCSUBDIR}/datain/${NAMEI}${LABELI}${EXTI}${TRUNCI}${LEVI}
if [ -s ${ganl} ]
then
  ls -o ${ganl}
else
  echo "rm -f ${ganl}"
  rm -f ${ganl}
fi
#
rm -f ${NML}/${SRCNAME}.nml
cat <<EOT > ${NML}/${SRCNAME}.nml
 &ChopNML
  MendInp=574,         ! Spectral Horizontal Resolution of Input Data
  KmaxInp=64,         ! Number of Layers of Input Data
  MendOut=126,         ! Spectral Horizontal Resolution of Output Data
  KmaxOut=28,         ! Number of Layers of Output Data
  MendCut=126,             ! Spectral Resolution Cut Off for Topography Smoothing
  Iter=10,            ! Number of Iteractions in Topography Smoothing
  SmthPerCut=0.12,    ! Percentage for Topography Smoothing
  GetOzone=T,             ! Flag to Produce Ozone Files
  GetTracers=F,           ! Flag to Produce Tracers Files
  GrADS=F,                ! Flag to Produce GrADS Files
  GrADSOnly=F,            ! Flag to Only Produce GrADS Files (Do Not Produce Inputs for Model)
  GDASOnly=F,             ! Flag to Only Produce Input CPTEC Analysis File
  SmoothTopo=T,           ! Flag to Performe Topography Smoothing
  RmGANL=T,               ! Flag to Remove GANL File if Desired
  Linear=F,               ! Flag to Set Linear or Quadratic Gaussian Grid
  DateLabel='${LABELI}', ! Date Label: yyyymmddhh or DateLabel='          '
                          !       If Year (yyyy), Month (mm) and Day (dd) Are Unknown
  UTC='00',            ! UTC Hour: hh, Must Be Given if Label='          ', else UTC=' '
  NCEPName='gblav.T00Z.SAnl.${LABELI} ',  ! NCEP Analysis Preffix for Input File Name

  DirMain='/ '      ! Main User Data Directory
  DGDInp='${GDASDIR}/ ',
  DirInp='${DATAMAINDIR}/model/datain/ ',
  DirOut='${DATAMAINDIR}/model/datain/ ',
  DirTop='${DATAMAINDIR}/${SRCSUBDIR}/datain/ ',
  DirSig='${DATAMAINDIR}/${SRCSUBDIR}/datain/ ',
  DirGrd='${GRADSDIR}/ ',
  DirHome='/ ',      ! Home User Source Directory
  Pref='AVN'
 /
EOT
#
# Delta Sigma File
#
rm -f ${NML}/${NAMSG}.L*
    if [ "YES" = "YES" ]
    then
case ${LEVO} in
L09)
cat <<EOT >> ${NML}/${NAMSG}.L09
  0.10000000E-01  0.17000000E-01  0.25000000E-01  0.14800000E+00  0.20000000E+00
  0.30000000E+00  0.20000000E+00  0.20000000E-01  0.80000000E-01
EOT
;;
#L18)
# NCEP Pre 1993
#cat <<EOT >> ${NML}/${NAMSG}.L18
#  0.10000000E-01  0.17000000E-01  0.25000000E-01  0.55000000E-01  0.73000000E-01
#  0.85000000E-01  0.93000000E-01  0.96000000E-01  0.96000000E-01  0.50000000E-01
#  0.50000000E-01  0.50000000E-01  0.50000000E-01  0.50000000E-01  0.50000000E-01
#  0.50000000E-01  0.50000000E-01  0.50000000E-01
#EOT
#;;
# CPTEC Pos 2003
L18)
cat <<EOT >> ${NML}/${NAMSG}.L18
  0.10000000E-01  0.17000000E-01  0.25000000E-01  0.43000000E-01  0.63000000E-01
  0.80000000E-01  0.91000000E-01  0.97000000E-01  0.98000000E-01  0.96000000E-01
  0.92000000E-01  0.83000000E-01  0.74000000E-01  0.63000000E-01  0.37000000E-01
  0.15000000E-01  0.90000000E-02  0.70000000E-02
EOT
;;
L28)
cat <<EOT >> ${NML}/${NAMSG}.L28
  0.10000000E-01  0.15820000E-01  0.19590000E-01  0.24050000E-01  0.29190000E-01
  0.34930000E-01  0.41150000E-01  0.47540000E-01  0.53720000E-01  0.59190000E-01
  0.63470000E-01  0.66060000E-01  0.66690000E-01  0.65260000E-01  0.61970000E-01
  0.57160000E-01  0.51350000E-01  0.45030000E-01  0.38670000E-01  0.32620000E-01
  0.27090000E-01  0.22220000E-01  0.18030000E-01  0.14510000E-01  0.11600000E-01
  0.92300000E-02  0.72900000E-02  0.65700000E-02
EOT
;;
L42)
cat <<EOT >> ${NML}/${NAMSG}.L42
  0.80300000E-02  0.92300000E-02  0.10580000E-01  0.12100000E-01  0.13800000E-01
  0.15650000E-01  0.17680000E-01  0.19870000E-01  0.22200000E-01  0.24660000E-01
  0.27170000E-01  0.29720000E-01  0.32230000E-01  0.34620000E-01  0.36810000E-01
  0.38740000E-01  0.40300000E-01  0.41450000E-01  0.42110000E-01  0.42280000E-01
  0.41910000E-01  0.41060000E-01  0.39750000E-01  0.38040000E-01  0.36000000E-01
  0.33720000E-01  0.31280000E-01  0.28750000E-01  0.26200000E-01  0.23700000E-01
  0.21300000E-01  0.19010000E-01  0.16890000E-01  0.14920000E-01  0.13120000E-01
  0.11500000E-01  0.10050000E-01  0.87500000E-02  0.76000000E-02  0.65900000E-02
  0.57100000E-02  0.49200000E-02
EOT
;;
# Valores do NCEP e T170L64 e acima do CPTEC
L64)
cat <<EOT >> ${NML}/${NAMSG}.L64
  0.53290000E-02  0.60390000E-02  0.68320000E-02  0.77170000E-02  0.86980000E-02
  0.97820000E-02  0.10972000E-01  0.12271000E-01  0.13682000E-01  0.15198000E-01
  0.16817000E-01  0.18524000E-01  0.20309000E-01  0.22145000E-01  0.24008000E-01
  0.25866000E-01  0.27678000E-01  0.29404000E-01  0.30998000E-01  0.32415000E-01
  0.33611000E-01  0.34545000E-01  0.35186000E-01  0.35511000E-01  0.35508000E-01
  0.35177000E-01  0.34529000E-01  0.33590000E-01  0.32390000E-01  0.30969000E-01
  0.29372000E-01  0.27644000E-01  0.25830000E-01  0.23972000E-01  0.22110000E-01
  0.20273000E-01  0.18491000E-01  0.16785000E-01  0.15168000E-01  0.13653000E-01
  0.12246000E-01  0.10948000E-01  0.97590000E-02  0.86790000E-02  0.76990000E-02
  0.68160000E-02  0.60240000E-02  0.53160000E-02  0.46850000E-02  0.41220000E-02
  0.36240000E-02  0.31830000E-02  0.27940000E-02  0.24490000E-02  0.21470000E-02
  0.18800000E-02  0.16460000E-02  0.14410000E-02  0.12600000E-02  0.11010000E-02
  0.96300000E-03  0.84200000E-03  0.73600000E-03  0.64200000E-03
EOT
# CPTEC teste modelo acoplado T062L28 (3 primeiros = L42)
#L64)
#cat <<EOT >> ${NML}/${NAMSG}.L64
#  0.80300000E-02  0.92300000E-02  0.10580000E-01  0.11187000E-01  0.12037000E-01
#  0.12974000E-01  0.14003000E-01  0.15124000E-01  0.16339000E-01  0.17644000E-01
#  0.19033000E-01  0.20496000E-01  0.22018000E-01  0.23580000E-01  0.25158000E-01
#  0.26721000E-01  0.28235000E-01  0.29663000E-01  0.30964000E-01  0.32098000E-01
#  0.33026000E-01  0.33714000E-01  0.34133000E-01  0.34264000E-01  0.34099000E-01
#  0.33638000E-01  0.32894000E-01  0.31890000E-01  0.30656000E-01  0.29229000E-01
#  0.27649000E-01  0.25959000E-01  0.24199000E-01  0.22408000E-01  0.20620000E-01
#  0.18865000E-01  0.17168000E-01  0.15545000E-01  0.14013000E-01  0.12578000E-01
#  0.11248000E-01  0.10022000E-01  0.89020000E-02  0.78820000E-02  0.69600000E-02
#  0.61300000E-02  0.53850000E-02  0.47190000E-02  0.41250000E-02  0.35970000E-02
#  0.31290000E-02  0.27150000E-02  0.23490000E-02  0.20270000E-02  0.17420000E-02
#  0.14920000E-02  0.12730000E-02  0.10800000E-02  0.91000000E-03  0.76200000E-03
#  0.63200000E-03  0.51800000E-03  0.41500000E-03  0.32500000E-03
#EOT
;;
*) echo "Wrong request for vertical resolution: ${LEVO}" ; exit 1 ;;
esac
#
    fi
#
  fi
#
cd ${SRCMAINDIR}/run
#
# Run Initial Condition Chopping
#
${SRC}/${SRCNAME}.scr
#

cd /gfs/home3/modoper/tempo/global/oens/run
echo "runsstw1. run 126 28 ${LABELI}"
runsstw1.sx6 run 126 28 ${LABELI}
echo "runsnow1. run 126 ${LABELI}"
runsnow1.sx6 run 126 ${LABELI}
#
