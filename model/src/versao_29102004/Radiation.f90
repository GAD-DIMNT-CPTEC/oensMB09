!
!  $Author: alexalm $
!  $Date: 2005/10/17 14:25:38 $
!  $Revision: 1.1.1.1 $
!
MODULE Radiation

  ! InitRadiation
  ! InitSpmrad
  ! InitRadtim
  ! InitGetoz
  !
  ! spmrad ------| radtim
  !              !
  !              ! getoz
  !              !
  !              ! cldgen
  !              !
  !              ! cldgn2
  !              !
  !              ! swrad   ------| setsw ------| clear
  !              !                             |
  !              !                             | cloudy
  !              !
  !              ! lwrad   ------| lwflux -----| crunch
  !                              !
  !                              ! cldslw
  !
  ! radtim
  !
  ! rqvirt

  USE Utils, ONLY: &
       tmstmp2

  USE Diagnostics, ONLY: &
       updia,          &
       ndo3

  USE Constants, ONLY :     &
       delq,           &
       qmin,           &
       hl,             &
       gasr,           &
       rmwmd,          &
       rmwmdi,         &
       e0c,            &
       pai,            &
       cp,             &
       grav,           &
       solcon

  USE Options, ONLY :     &
       tbase   
  IMPLICIT NONE

  PRIVATE

  PUBLIC :: InitRadiation
  PUBLIC :: InitSpmrad
  PUBLIC :: InitRadtim
  PUBLIC :: InitGetoz
  PUBLIC :: spmrad
  PUBLIC :: radtim
  PUBLIC :: rqvirt
  PUBLIC :: COSZMED

  REAL :: b2502 (32)
  REAL :: b2501 (32)
  REAL :: blkwin(32)
  REAL :: blkco2(32)
  INTEGER, PARAMETER :: nlm_getoz=18
  REAL, ALLOCATABLE :: ozone(:,:,:)
  LOGICAL :: first_getoz
  INTEGER :: mon_getoz
  REAL    :: year_getoz
  LOGICAL :: inter_getoz
  REAL    :: pai12
  REAL    :: pai2i
  REAL    :: fim24
  INTEGER :: monday(12)
  REAL    :: ozsig(18)    !ozsig(nlm_getoz)

CONTAINS




  SUBROUTINE InitRadiation()

    INTEGER, PARAMETER :: nl=37
    INTEGER, PARAMETER :: ns=4

    b2501(:) = (/ &
         16.280e0, 17.471e0, 18.701e0, 19.974e0, 21.292e0, &
         22.661e0, 24.086e0, 25.575e0, 27.135e0, 28.775e0, &
         30.506e0, 32.339e0, 34.286e0, 36.361e0, 38.578e0, &
         40.954e0, 43.505e0, 46.248e0, 49.203e0, 52.388e0, &
         55.824e0, 59.532e0, 63.533e0, 67.849e0, 72.502e0, &
         77.516e0, 82.913e0, 88.717e0, 94.952e0, 101.64e0, &
         108.806e0,116.472e0 /)
    b2502(:) = (/ &
         16.379e0, 18.744e0, 21.345e0, 24.195e0,  27.311e0, &
         30.708e0, 34.405e0, 38.417e0, 42.763e0,  47.461e0, &
         52.529e0, 57.985e0, 63.850e0, 70.141e0,  76.880e0, &
         84.088e0, 91.784e0,  99.99e0,108.726e0, 118.016e0, &
         127.881e0,138.344e0,149.429e0,161.160e0, 173.561e0, &
         186.659e0,200.478e0,215.046e0,230.390e0, 246.539e0, &
         263.523e0,281.368e0 /)
    blkwin(:) = (/ &
         0.593e0, 0.774e0, 0.993e0, 1.258e0, 1.573e0, &
         1.944e0, 2.377e0, 2.877e0, 3.450e0, 4.102e0, &
         4.838e0, 5.664e0, 6.585e0, 7.606e0, 8.733e0, &
         9.969e0,11.320e0,12.788e0,14.380e0,16.097e0, &
         17.944e0,19.923e0,22.038e0,24.292e0,26.685e0, &
         29.221e0,31.902e0,34.729e0,37.703e0,40.825e0, &
         44.097e0,47.520e0   /)
    blkco2(:) = (/ &
         8.789e0, 10.385e0, 12.159e0, 14.117e0, 16.264e0, &
         18.606e0, 21.145e0, 23.884e0, 26.826e0, 29.973e0, &
         33.325e0, 36.883e0, 40.647e0, 44.617e0, 48.792e0, &
         53.170e0, 57.750e0, 62.530e0, 67.509e0, 72.683e0, &
         78.050e0, 83.609e0, 89.354e0, 95.285e0,101.397e0, &
         107.688e0,114.155e0,120.794e0,127.601e0,134.574e0, &
         141.710e0,149.004e0 /)

    ALLOCATE(ozone(nlm_getoz,nl,ns))

    !     
    !     four season climatological ozone data in nmc sigma layers
    !     
    !     for seasonal variation
    !     season=1 - winter          season=2 - spring
    !     season=3 - summer          season=4 - fall
    !     unit of ozone mixing ratio is in ( 10**-4 g/g ).  the data is
    !     in 18 sigma layers from top to bottom.  for every layer, there
    !     are 37 latitudes at 5 degree interval from north pole to south
    !     pole.
    !     mrf86 18 layers
    !
    !     
    !     1. winter
    !     
    !     wint1(18,6)
    !
    ozone(1:18, 1:6, 1) = RESHAPE( (/ &
         .068467e0,.052815e0,.035175e0,.022334e0,.013676e0,.007363e0, &
         .003633e0,.001582e0,.001111e0,.000713e0,.000517e0,.000441e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .069523e0,.052249e0,.034255e0,.021379e0,.012306e0,.006727e0, &
         .003415e0,.001578e0,.001072e0,.000681e0,.000517e0,.000441e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .070579e0,.051684e0,.033335e0,.020423e0,.010935e0,.006091e0, &
         .003197e0,.001573e0,.001034e0,.000650e0,.000517e0,.000441e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .074885e0,.049987e0,.030140e0,.017894e0,.009881e0,.005543e0, &
         .002907e0,.001379e0,.000961e0,.000644e0,.000512e0,.000463e0, &
         .000451e0,.000408e0,.000385e0,.000361e0,.000351e0,.000349e0, &
         .079190e0,.048290e0,.026945e0,.015366e0,.008826e0,.004995e0, &
         .002616e0,.001184e0,.000887e0,.000637e0,.000508e0,.000486e0, &
         .000501e0,.000459e0,.000436e0,.000416e0,.000406e0,.000395e0, &
         .082443e0,.047591e0,.025358e0,.014294e0,.008233e0,.004664e0, &
         .002430e0,.001068e0,.000851e0,.000644e0,.000508e0,.000474e0, &
         .000501e0,.000459e0,.000436e0,.000416e0,.000406e0,.000395e0/), &
         (/18,6/))
    !
    !     wint2(18,6)
    !
    ozone(1:18, 7:12, 1) = RESHAPE( (/ &
         .085695e0,.046892e0,.023772e0,.013223e0,.007640e0,.004333e0, &
         .002244e0,.000951e0,.000815e0,.000650e0,.000508e0,.000463e0, &
         .000501e0,.000459e0,.000436e0,.000416e0,.000406e0,.000395e0, &
         .089618e0,.042869e0,.019963e0,.010502e0,.005966e0,.003525e0, &
         .001936e0,.000906e0,.000769e0,.000625e0,.000508e0,.000452e0, &
         .000451e0,.000408e0,.000385e0,.000361e0,.000351e0,.000349e0, &
         .093540e0,.038846e0,.016155e0,.007781e0,.004292e0,.002716e0, &
         .001628e0,.000862e0,.000724e0,.000600e0,.000508e0,.000441e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .097097e0,.034916e0,.012983e0,.006240e0,.003666e0,.002259e0, &
         .001336e0,.000730e0,.000629e0,.000549e0,.000499e0,.000441e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .100654e0,.030986e0,.009812e0,.004698e0,.003041e0,.001803e0, &
         .001044e0,.000599e0,.000533e0,.000499e0,.000491e0,.000441e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .101724e0,.026500e0,.007228e0,.003391e0,.002058e0,.001285e0, &
         .000811e0,.000531e0,.000478e0,.000449e0,.000440e0,.000421e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0/), &
         (/18,6/))
    !
    !     wint3(18,6)
    !
    ozone(1:18, 13:18, 1) = RESHAPE( (/ &
         .102794e0,.022015e0,.004645e0,.002084e0,.001076e0,.000767e0, &
         .000577e0,.000463e0,.000423e0,.000399e0,.000389e0,.000401e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .103456e0,.018235e0,.003195e0,.001379e0,.000771e0,.000585e0, &
         .000474e0,.000411e0,.000380e0,.000362e0,.000343e0,.000348e0, &
         .000346e0,.000328e0,.000317e0,.000305e0,.000302e0,.000302e0, &
         .104118e0,.014455e0,.001745e0,.000674e0,.000467e0,.000403e0, &
         .000370e0,.000359e0,.000337e0,.000325e0,.000296e0,.000294e0, &
         .000293e0,.000302e0,.000306e0,.000302e0,.000302e0,.000302e0, &
         .104106e0,.012997e0,.001479e0,.000639e0,.000468e0,.000422e0, &
         .000392e0,.000372e0,.000342e0,.000325e0,.000296e0,.000294e0, &
         .000293e0,.000302e0,.000306e0,.000302e0,.000302e0,.000302e0, &
         .104093e0,.011539e0,.001213e0,.000604e0,.000468e0,.000442e0, &
         .000414e0,.000385e0,.000347e0,.000325e0,.000296e0,.000294e0, &
         .000293e0,.000302e0,.000306e0,.000302e0,.000302e0,.000302e0, &
         .104087e0,.010726e0,.000971e0,.000538e0,.000440e0,.000434e0, &
         .000418e0,.000397e0,.000375e0,.000343e0,.000296e0,.000294e0, &
         .000293e0,.000302e0,.000306e0,.000302e0,.000302e0,.000302e0/), &
         (/18,6/))
    !
    !     wint4(18,6)
    !
    ozone(1:18, 19:24, 1) = RESHAPE( (/ &
         .102665e0,.010977e0,.001237e0,.000590e0,.000498e0,.000479e0, &
         .000458e0,.000436e0,.000421e0,.000387e0,.000326e0,.000298e0, &
         .000246e0,.000227e0,.000211e0,.000200e0,.000194e0,.000186e0, &
         .100892e0,.012873e0,.001886e0,.000785e0,.000643e0,.000568e0, &
         .000519e0,.000487e0,.000471e0,.000437e0,.000368e0,.000305e0, &
         .000201e0,.000151e0,.000117e0,.000098e0,.000090e0,.000093e0, &
         .100534e0,.013704e0,.002028e0,.000861e0,.000701e0,.000604e0, &
         .000546e0,.000513e0,.000504e0,.000462e0,.000381e0,.000307e0, &
         .000201e0,.000151e0,.000117e0,.000098e0,.000090e0,.000093e0, &
         .100218e0,.015035e0,.002537e0,.001037e0,.000790e0,.000726e0, &
         .000673e0,.000628e0,.000579e0,.000512e0,.000440e0,.000374e0, &
         .000307e0,.000253e0,.000227e0,.000208e0,.000194e0,.000186e0, &
         .099903e0,.016365e0,.003045e0,.001214e0,.000879e0,.000848e0, &
         .000801e0,.000744e0,.000654e0,.000562e0,.000499e0,.000441e0, &
         .000410e0,.000358e0,.000342e0,.000322e0,.000302e0,.000302e0, &
         .099547e0,.017725e0,.003693e0,.001578e0,.001125e0,.000985e0, &
         .000879e0,.000795e0,.000712e0,.000643e0,.000584e0,.000521e0, &
         .000482e0,.000384e0,.000351e0,.000322e0,.000302e0,.000302e0/), &
         (/18,6/))
    !
    !     wint5(18,6)
    !
    ozone(1:18, 25:30, 1) = RESHAPE( (/ &
         .099191e0,.019085e0,.004340e0,.001943e0,.001371e0,.001122e0, &
         .000957e0,.000847e0,.000770e0,.000724e0,.000669e0,.000601e0, &
         .000557e0,.000412e0,.000362e0,.000326e0,.000309e0,.000302e0, &
         .098107e0,.020617e0,.004758e0,.002137e0,.001516e0,.001211e0, &
         .000999e0,.000848e0,.000778e0,.000730e0,.000677e0,.000603e0, &
         .000557e0,.000412e0,.000362e0,.000326e0,.000309e0,.000302e0, &
         .097023e0,.022148e0,.005177e0,.002332e0,.001660e0,.001300e0, &
         .001041e0,.000849e0,.000786e0,.000737e0,.000686e0,.000606e0, &
         .000557e0,.000412e0,.000362e0,.000326e0,.000309e0,.000302e0, &
         .093464e0,.026177e0,.008525e0,.003892e0,.002452e0,.001609e0, &
         .001116e0,.000851e0,.000809e0,.000762e0,.000690e0,.000606e0, &
         .000557e0,.000412e0,.000362e0,.000326e0,.000309e0,.000302e0, &
         .089906e0,.030206e0,.011873e0,.005453e0,.003244e0,.001918e0, &
         .001192e0,.000852e0,.000832e0,.000787e0,.000694e0,.000606e0, &
         .000557e0,.000412e0,.000362e0,.000326e0,.000309e0,.000302e0, &
         .080939e0,.032414e0,.014163e0,.007241e0,.004328e0,.002522e0, &
         .001481e0,.000934e0,.000861e0,.000787e0,.000694e0,.000606e0, &
         .000557e0,.000412e0,.000362e0,.000326e0,.000309e0,.000302e0/), &
         (/18,6/))
    !
    !     wint6(18,6)
    !
    ozone(1:18, 31:36, 1) = RESHAPE( (/ &
         .071972e0,.034622e0,.016453e0,.009029e0,.005413e0,.003127e0, &
         .001770e0,.001015e0,.000890e0,.000787e0,.000694e0,.000606e0, &
         .000557e0,.000412e0,.000362e0,.000326e0,.000309e0,.000302e0, &
         .069820e0,.035028e0,.016929e0,.009389e0,.005645e0,.003260e0, &
         .001843e0,.001055e0,.000905e0,.000787e0,.000694e0,.000606e0, &
         .000557e0,.000412e0,.000362e0,.000326e0,.000309e0,.000302e0, &
         .067669e0,.035434e0,.017406e0,.009749e0,.005876e0,.003393e0, &
         .001916e0,.001094e0,.000920e0,.000787e0,.000694e0,.000606e0, &
         .000557e0,.000412e0,.000362e0,.000326e0,.000309e0,.000302e0, &
         .065518e0,.035975e0,.017854e0,.010100e0,.006534e0,.003985e0, &
         .002321e0,.001240e0,.000966e0,.000774e0,.000640e0,.000548e0, &
         .000479e0,.000384e0,.000346e0,.000316e0,.000302e0,.000302e0, &
         .063367e0,.036516e0,.018302e0,.010452e0,.007192e0,.004577e0, &
         .002727e0,.001387e0,.001012e0,.000762e0,.000585e0,.000490e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .061216e0,.037359e0,.019151e0,.010633e0,.006845e0,.004382e0, &
         .002691e0,.001511e0,.001061e0,.000749e0,.000568e0,.000465e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0/), &
         (/18,6/))
    !
    !     wint7(18)
    !
    ozone(1:18, 37, 1) = (/ &
         .059066e0,.038201e0,.019999e0,.010813e0,.006498e0,.004188e0, &
         .002656e0,.001636e0,.001110e0,.000737e0,.000551e0,.000441e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0/)
    !     
    !     2. spring
    !     
    ozone(1:18, 1:6, 2) = RESHAPE( (/ &
         .074229e0,.050084e0,.030930e0,.018676e0,.011965e0,.008165e0, &
         .005428e0,.003399e0,.002098e0,.001138e0,.000780e0,.000632e0, &
         .000603e0,.000559e0,.000538e0,.000574e0,.000614e0,.000515e0, &
         .074927e0,.049459e0,.029215e0,.018025e0,.011754e0,.007786e0, &
         .004972e0,.002926e0,.001817e0,.001025e0,.000758e0,.000632e0, &
         .000603e0,.000559e0,.000538e0,.000574e0,.000614e0,.000515e0, &
         .075625e0,.048835e0,.027500e0,.017375e0,.011544e0,.007407e0, &
         .004516e0,.002453e0,.001536e0,.000912e0,.000737e0,.000632e0, &
         .000603e0,.000559e0,.000538e0,.000574e0,.000614e0,.000515e0, &
         .077409e0,.048159e0,.026661e0,.016596e0,.010962e0,.006972e0, &
         .004160e0,.002132e0,.001391e0,.000868e0,.000686e0,.000601e0, &
         .000603e0,.000559e0,.000538e0,.000574e0,.000614e0,.000515e0, &
         .079194e0,.047483e0,.025822e0,.015818e0,.010380e0,.006537e0, &
         .003804e0,.001811e0,.001245e0,.000825e0,.000635e0,.000570e0, &
         .000603e0,.000559e0,.000538e0,.000574e0,.000614e0,.000515e0, &
         .084591e0,.046553e0,.025037e0,.015156e0,.009841e0,.006124e0, &
         .003534e0,.001693e0,.001170e0,.000793e0,.000631e0,.000537e0, &
         .000551e0,.000509e0,.000486e0,.000516e0,.000548e0,.000446e0/), &
         (/18,6/))
    ozone(1:18, 7:12, 2) = RESHAPE( (/ &
         .089988e0,.045622e0,.024253e0,.014495e0,.009303e0,.005711e0, &
         .003264e0,.001574e0,.001096e0,.000762e0,.000627e0,.000503e0, &
         .000501e0,.000459e0,.000436e0,.000460e0,.000486e0,.000398e0, &
         .092863e0,.042419e0,.020704e0,.012034e0,.007417e0,.004504e0, &
         .002590e0,.001334e0,.000977e0,.000731e0,.000622e0,.000503e0, &
         .000501e0,.000459e0,.000436e0,.000460e0,.000486e0,.000398e0, &
         .095737e0,.039215e0,.017155e0,.009572e0,.005532e0,.003296e0, &
         .001916e0,.001094e0,.000858e0,.000699e0,.000618e0,.000503e0, &
         .000501e0,.000459e0,.000436e0,.000460e0,.000486e0,.000398e0, &
         .097501e0,.035382e0,.014856e0,.008207e0,.004619e0,.002720e0, &
         .001610e0,.001012e0,.000829e0,.000687e0,.000610e0,.000503e0, &
         .000501e0,.000459e0,.000436e0,.000460e0,.000486e0,.000398e0, &
         .099264e0,.031548e0,.012557e0,.006841e0,.003705e0,.002144e0, &
         .001304e0,.000930e0,.000799e0,.000675e0,.000601e0,.000503e0, &
         .000501e0,.000459e0,.000436e0,.000460e0,.000486e0,.000398e0, &
         .101718e0,.026523e0,.008473e0,.004382e0,.002392e0,.001505e0, &
         .001036e0,.000836e0,.000727e0,.000618e0,.000550e0,.000494e0, &
         .000501e0,.000479e0,.000473e0,.000509e0,.000541e0,.000445e0/), &
         (/18,6/))
    ozone(1:18, 13:18, 2) = RESHAPE( (/ &
         .104172e0,.021499e0,.004389e0,.001922e0,.001078e0,.000865e0, &
         .000767e0,.000743e0,.000654e0,.000562e0,.000499e0,.000486e0, &
         .000501e0,.000502e0,.000509e0,.000561e0,.000607e0,.000515e0, &
         .104145e0,.018082e0,.003274e0,.001493e0,.000919e0,.000762e0, &
         .000678e0,.000641e0,.000584e0,.000531e0,.000495e0,.000486e0, &
         .000501e0,.000502e0,.000509e0,.000561e0,.000607e0,.000515e0, &
         .104118e0,.014665e0,.002159e0,.001063e0,.000759e0,.000659e0, &
         .000589e0,.000539e0,.000514e0,.000499e0,.000491e0,.000486e0, &
         .000501e0,.000502e0,.000509e0,.000561e0,.000607e0,.000515e0, &
         .107719e0,.013052e0,.001822e0,.000953e0,.000701e0,.000604e0, &
         .000551e0,.000525e0,.000509e0,.000499e0,.000491e0,.000486e0, &
         .000501e0,.000502e0,.000509e0,.000561e0,.000607e0,.000515e0, &
         .111320e0,.011439e0,.001485e0,.000843e0,.000642e0,.000549e0, &
         .000512e0,.000512e0,.000504e0,.000499e0,.000491e0,.000486e0, &
         .000501e0,.000502e0,.000509e0,.000561e0,.000607e0,.000515e0, &
         .112375e0,.011255e0,.001357e0,.000744e0,.000585e0,.000533e0, &
         .000512e0,.000512e0,.000504e0,.000499e0,.000491e0,.000486e0, &
         .000501e0,.000502e0,.000509e0,.000561e0,.000607e0,.000515e0/), &
         (/18,6/))
    ozone(1:18, 19:24, 2) = RESHAPE( (/ &
         .109850e0,.010424e0,.001079e0,.000567e0,.000498e0,.000479e0, &
         .000463e0,.000448e0,.000418e0,.000399e0,.000389e0,.000367e0, &
         .000351e0,.000328e0,.000320e0,.000337e0,.000355e0,.000304e0, &
         .107002e0,.009961e0,.001025e0,.000533e0,.000497e0,.000460e0, &
         .000422e0,.000385e0,.000332e0,.000300e0,.000288e0,.000249e0, &
         .000202e0,.000158e0,.000132e0,.000114e0,.000104e0,.000093e0, &
         .107735e0,.010146e0,.001120e0,.000576e0,.000526e0,.000477e0, &
         .000430e0,.000385e0,.000332e0,.000300e0,.000288e0,.000249e0, &
         .000202e0,.000158e0,.000132e0,.000114e0,.000104e0,.000093e0, &
         .107021e0,.012233e0,.001533e0,.000643e0,.000556e0,.000505e0, &
         .000471e0,.000448e0,.000403e0,.000362e0,.000355e0,.000296e0, &
         .000251e0,.000207e0,.000180e0,.000161e0,.000152e0,.000140e0, &
         .106308e0,.014320e0,.001946e0,.000709e0,.000585e0,.000533e0, &
         .000512e0,.000512e0,.000473e0,.000425e0,.000423e0,.000342e0, &
         .000301e0,.000257e0,.000232e0,.000212e0,.000205e0,.000209e0, &
         .100592e0,.015718e0,.002411e0,.001007e0,.000802e0,.000642e0, &
         .000559e0,.000526e0,.000501e0,.000474e0,.000470e0,.000439e0, &
         .000430e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0/), &
         (/18,6/))
    ozone(1:18, 25:30, 2) = RESHAPE( (/ &
         .094877e0,.017116e0,.002877e0,.001305e0,.001018e0,.000751e0, &
         .000606e0,.000539e0,.000529e0,.000524e0,.000516e0,.000535e0, &
         .000558e0,.000459e0,.000436e0,.000416e0,.000406e0,.000395e0, &
         .094163e0,.020198e0,.004594e0,.001772e0,.001077e0,.000806e0, &
         .000649e0,.000565e0,.000547e0,.000537e0,.000521e0,.000535e0, &
         .000558e0,.000459e0,.000436e0,.000416e0,.000406e0,.000395e0, &
         .093449e0,.023279e0,.006312e0,.002240e0,.001135e0,.000862e0, &
         .000692e0,.000591e0,.000564e0,.000549e0,.000525e0,.000535e0, &
         .000558e0,.000459e0,.000436e0,.000416e0,.000406e0,.000395e0, &
         .089886e0,.026029e0,.008558e0,.003312e0,.001655e0,.001124e0, &
         .000807e0,.000631e0,.000602e0,.000568e0,.000525e0,.000535e0, &
         .000558e0,.000459e0,.000436e0,.000416e0,.000406e0,.000395e0, &
         .086323e0,.028778e0,.010805e0,.004383e0,.002175e0,.001386e0, &
         .000923e0,.000671e0,.000640e0,.000587e0,.000525e0,.000535e0, &
         .000558e0,.000459e0,.000436e0,.000416e0,.000406e0,.000395e0, &
         .082715e0,.031096e0,.013350e0,.006131e0,.003205e0,.002043e0, &
         .001304e0,.000842e0,.000734e0,.000631e0,.000555e0,.000494e0, &
         .000480e0,.000408e0,.000385e0,.000361e0,.000351e0,.000349e0/), &
         (/18,6/))
    ozone(1:18, 31:36, 2) = RESHAPE( (/ &
         .079108e0,.033415e0,.015895e0,.007878e0,.004234e0,.002700e0, &
         .001686e0,.001014e0,.000829e0,.000675e0,.000584e0,.000454e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .074807e0,.034651e0,.017056e0,.008574e0,.004769e0,.002986e0, &
         .001827e0,.001079e0,.000853e0,.000675e0,.000584e0,.000454e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .070506e0,.035887e0,.018218e0,.009270e0,.005304e0,.003271e0, &
         .001969e0,.001145e0,.000878e0,.000675e0,.000584e0,.000454e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .067669e0,.037799e0,.019680e0,.009612e0,.005481e0,.003476e0, &
         .002093e0,.001123e0,.000837e0,.000631e0,.000546e0,.000447e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .064832e0,.039712e0,.021142e0,.009954e0,.005658e0,.003681e0, &
         .002218e0,.001100e0,.000796e0,.000587e0,.000508e0,.000441e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .063734e0,.039842e0,.022004e0,.010859e0,.005712e0,.003589e0, &
         .002155e0,.001174e0,.000856e0,.000612e0,.000508e0,.000441e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0/), &
         (/18,6/))
    ozone(1:18, 37, 2) = (/ &
         .062636e0,.039972e0,.022867e0,.011765e0,.005766e0,.003498e0, &
         .002092e0,.001248e0,.000917e0,.000637e0,.000508e0,.000441e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0/)
    !     
    !     3. summer
    !     
    ozone(1:18, 1:6, 3) = RESHAPE( (/ &
         .059066e0,.038201e0,.019999e0,.010813e0,.006498e0,.004188e0, &
         .002656e0,.001636e0,.001110e0,.000737e0,.000551e0,.000441e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .061216e0,.037359e0,.019151e0,.010633e0,.006845e0,.004382e0, &
         .002691e0,.001511e0,.001061e0,.000749e0,.000568e0,.000465e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .063367e0,.036516e0,.018302e0,.010452e0,.007192e0,.004577e0, &
         .002727e0,.001387e0,.001012e0,.000762e0,.000585e0,.000490e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .065518e0,.035975e0,.017854e0,.010100e0,.006534e0,.003985e0, &
         .002321e0,.001240e0,.000966e0,.000774e0,.000640e0,.000548e0, &
         .000479e0,.000384e0,.000346e0,.000316e0,.000302e0,.000302e0, &
         .067669e0,.035434e0,.017406e0,.009749e0,.005876e0,.003393e0, &
         .001916e0,.001094e0,.000920e0,.000787e0,.000694e0,.000606e0, &
         .000557e0,.000412e0,.000362e0,.000326e0,.000309e0,.000302e0, &
         .069820e0,.035028e0,.016929e0,.009389e0,.005645e0,.003260e0, &
         .001843e0,.001055e0,.000905e0,.000787e0,.000694e0,.000606e0, &
         .000557e0,.000412e0,.000362e0,.000326e0,.000309e0,.000302e0/), &
         (/18,6/))
    ozone(1:18, 7:12, 3) = RESHAPE( (/ &
         .071972e0,.034622e0,.016453e0,.009029e0,.005413e0,.003127e0, &
         .001770e0,.001015e0,.000890e0,.000787e0,.000694e0,.000606e0, &
         .000557e0,.000412e0,.000362e0,.000326e0,.000309e0,.000302e0, &
         .080939e0,.032414e0,.014163e0,.007241e0,.004328e0,.002522e0, &
         .001481e0,.000934e0,.000861e0,.000787e0,.000694e0,.000606e0, &
         .000557e0,.000412e0,.000362e0,.000326e0,.000309e0,.000302e0, &
         .089906e0,.030206e0,.011873e0,.005453e0,.003244e0,.001918e0, &
         .001192e0,.000852e0,.000832e0,.000787e0,.000694e0,.000606e0, &
         .000557e0,.000412e0,.000362e0,.000326e0,.000309e0,.000302e0, &
         .093464e0,.026177e0,.008525e0,.003892e0,.002452e0,.001609e0, &
         .001116e0,.000851e0,.000809e0,.000762e0,.000690e0,.000606e0, &
         .000557e0,.000412e0,.000362e0,.000326e0,.000309e0,.000302e0, &
         .097023e0,.022148e0,.005177e0,.002332e0,.001660e0,.001300e0, &
         .001041e0,.000849e0,.000786e0,.000737e0,.000686e0,.000606e0, &
         .000557e0,.000412e0,.000362e0,.000326e0,.000309e0,.000302e0, &
         .098107e0,.020617e0,.004758e0,.002137e0,.001516e0,.001211e0, &
         .000999e0,.000848e0,.000778e0,.000730e0,.000677e0,.000603e0, &
         .000557e0,.000412e0,.000362e0,.000326e0,.000309e0,.000302e0/), &
         (/18,6/))
    ozone(1:18, 13:18, 3) = RESHAPE( (/ &
         .099191e0,.019085e0,.004340e0,.001943e0,.001371e0,.001122e0, &
         .000957e0,.000847e0,.000770e0,.000724e0,.000669e0,.000601e0, &
         .000557e0,.000412e0,.000362e0,.000326e0,.000309e0,.000302e0, &
         .099547e0,.017725e0,.003693e0,.001578e0,.001125e0,.000985e0, &
         .000879e0,.000795e0,.000712e0,.000643e0,.000584e0,.000521e0, &
         .000482e0,.000384e0,.000351e0,.000322e0,.000302e0,.000302e0, &
         .099903e0,.016365e0,.003045e0,.001214e0,.000879e0,.000848e0, &
         .000801e0,.000744e0,.000654e0,.000562e0,.000499e0,.000441e0, &
         .000410e0,.000358e0,.000342e0,.000322e0,.000302e0,.000302e0, &
         .100218e0,.015035e0,.002537e0,.001037e0,.000790e0,.000726e0, &
         .000673e0,.000628e0,.000579e0,.000512e0,.000440e0,.000374e0, &
         .000307e0,.000253e0,.000227e0,.000208e0,.000194e0,.000186e0, &
         .100534e0,.013704e0,.002028e0,.000861e0,.000701e0,.000604e0, &
         .000546e0,.000513e0,.000504e0,.000462e0,.000381e0,.000307e0, &
         .000201e0,.000151e0,.000117e0,.000098e0,.000090e0,.000093e0, &
         .100892e0,.012873e0,.001886e0,.000785e0,.000643e0,.000568e0, &
         .000519e0,.000487e0,.000471e0,.000437e0,.000368e0,.000305e0, &
         .000201e0,.000151e0,.000117e0,.000098e0,.000090e0,.000093e0/), &
         (/18,6/))
    ozone(1:18, 19:24, 3) = RESHAPE( (/ &
         .102665e0,.010977e0,.001237e0,.000590e0,.000498e0,.000479e0, &
         .000458e0,.000436e0,.000421e0,.000387e0,.000326e0,.000298e0, &
         .000246e0,.000227e0,.000211e0,.000200e0,.000194e0,.000186e0, &
         .104087e0,.010726e0,.000971e0,.000538e0,.000440e0,.000434e0, &
         .000418e0,.000397e0,.000375e0,.000343e0,.000296e0,.000294e0, &
         .000293e0,.000302e0,.000306e0,.000302e0,.000302e0,.000302e0, &
         .104093e0,.011539e0,.001213e0,.000604e0,.000468e0,.000442e0, &
         .000414e0,.000385e0,.000347e0,.000325e0,.000296e0,.000294e0, &
         .000293e0,.000302e0,.000306e0,.000302e0,.000302e0,.000302e0, &
         .104106e0,.012997e0,.001479e0,.000639e0,.000468e0,.000422e0, &
         .000392e0,.000372e0,.000342e0,.000325e0,.000296e0,.000294e0, &
         .000293e0,.000302e0,.000306e0,.000302e0,.000302e0,.000302e0, &
         .104118e0,.014455e0,.001745e0,.000674e0,.000467e0,.000403e0, &
         .000370e0,.000359e0,.000337e0,.000325e0,.000296e0,.000294e0, &
         .000293e0,.000302e0,.000306e0,.000302e0,.000302e0,.000302e0, &
         .103456e0,.018235e0,.003195e0,.001379e0,.000771e0,.000585e0, &
         .000474e0,.000411e0,.000380e0,.000362e0,.000343e0,.000348e0, &
         .000346e0,.000328e0,.000317e0,.000305e0,.000302e0,.000302e0/), &
         (/18,6/))
    ozone(1:18, 25:30, 3) = RESHAPE( (/ &
         .102794e0,.022015e0,.004645e0,.002084e0,.001076e0,.000767e0, &
         .000577e0,.000463e0,.000423e0,.000399e0,.000389e0,.000401e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .101724e0,.026500e0,.007228e0,.003391e0,.002058e0,.001285e0, &
         .000811e0,.000531e0,.000478e0,.000449e0,.000440e0,.000421e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .100654e0,.030986e0,.009812e0,.004698e0,.003041e0,.001803e0, &
         .001044e0,.000599e0,.000533e0,.000499e0,.000491e0,.000441e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .097097e0,.034916e0,.012983e0,.006240e0,.003666e0,.002259e0, &
         .001336e0,.000730e0,.000629e0,.000549e0,.000499e0,.000441e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .093540e0,.038846e0,.016155e0,.007781e0,.004292e0,.002716e0, &
         .001628e0,.000862e0,.000724e0,.000600e0,.000508e0,.000441e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .089618e0,.042869e0,.019963e0,.010502e0,.005966e0,.003525e0, &
         .001936e0,.000906e0,.000769e0,.000625e0,.000508e0,.000452e0, &
         .000451e0,.000408e0,.000385e0,.000361e0,.000351e0,.000349e0/), &
         (/18,6/))
    ozone(1:18, 31:36, 3) = RESHAPE( (/ &
         .085695e0,.046892e0,.023772e0,.013223e0,.007640e0,.004333e0, &
         .002244e0,.000951e0,.000815e0,.000650e0,.000508e0,.000463e0, &
         .000501e0,.000459e0,.000436e0,.000416e0,.000406e0,.000395e0, &
         .082443e0,.047591e0,.025358e0,.014294e0,.008233e0,.004664e0, &
         .002430e0,.001068e0,.000851e0,.000644e0,.000508e0,.000474e0, &
         .000501e0,.000459e0,.000436e0,.000416e0,.000406e0,.000395e0, &
         .079190e0,.048290e0,.026945e0,.015366e0,.008826e0,.004995e0, &
         .002616e0,.001184e0,.000887e0,.000637e0,.000508e0,.000486e0, &
         .000501e0,.000459e0,.000436e0,.000416e0,.000406e0,.000395e0, &
         .074885e0,.049987e0,.030140e0,.017894e0,.009881e0,.005543e0, &
         .002907e0,.001379e0,.000961e0,.000644e0,.000512e0,.000463e0, &
         .000451e0,.000408e0,.000385e0,.000361e0,.000351e0,.000349e0, &
         .070579e0,.051684e0,.033335e0,.020423e0,.010935e0,.006091e0, &
         .003197e0,.001573e0,.001034e0,.000650e0,.000517e0,.000441e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .069523e0,.052249e0,.034255e0,.021379e0,.012306e0,.006727e0, &
         .003415e0,.001578e0,.001072e0,.000681e0,.000517e0,.000441e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0/), &
         (/18,6/))
    ozone(1:18, 37, 3) = (/ &
         .068467e0,.052815e0,.035175e0,.022334e0,.013676e0,.007363e0, &
         .003633e0,.001582e0,.001111e0,.000713e0,.000517e0,.000441e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0/)
    !     
    !     4. fall
    !     
    ozone(1:18, 1:6, 4) = RESHAPE( (/ &
         .062636e0,.039972e0,.022867e0,.011765e0,.005766e0,.003498e0, &
         .002092e0,.001248e0,.000917e0,.000637e0,.000508e0,.000441e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .063734e0,.039842e0,.022004e0,.010859e0,.005712e0,.003589e0, &
         .002155e0,.001174e0,.000856e0,.000612e0,.000508e0,.000441e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .064832e0,.039712e0,.021142e0,.009954e0,.005658e0,.003681e0, &
         .002218e0,.001100e0,.000796e0,.000587e0,.000508e0,.000441e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .067669e0,.037799e0,.019680e0,.009612e0,.005481e0,.003476e0, &
         .002093e0,.001123e0,.000837e0,.000631e0,.000546e0,.000447e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .070506e0,.035887e0,.018218e0,.009270e0,.005304e0,.003271e0, &
         .001969e0,.001145e0,.000878e0,.000675e0,.000584e0,.000454e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .074807e0,.034651e0,.017056e0,.008574e0,.004769e0,.002986e0, &
         .001827e0,.001079e0,.000853e0,.000675e0,.000584e0,.000454e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0/), &
         (/18,6/))
    ozone(1:18, 7:12, 4) = RESHAPE( (/ &
         .079108e0,.033415e0,.015895e0,.007878e0,.004234e0,.002700e0, &
         .001686e0,.001014e0,.000829e0,.000675e0,.000584e0,.000454e0, &
         .000401e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .082715e0,.031096e0,.013350e0,.006131e0,.003205e0,.002043e0, &
         .001304e0,.000842e0,.000734e0,.000631e0,.000555e0,.000494e0, &
         .000480e0,.000408e0,.000385e0,.000361e0,.000351e0,.000349e0, &
         .086323e0,.028778e0,.010805e0,.004383e0,.002175e0,.001386e0, &
         .000923e0,.000671e0,.000640e0,.000587e0,.000525e0,.000535e0, &
         .000558e0,.000459e0,.000436e0,.000416e0,.000406e0,.000395e0, &
         .089886e0,.026029e0,.008558e0,.003312e0,.001655e0,.001124e0, &
         .000807e0,.000631e0,.000602e0,.000568e0,.000525e0,.000535e0, &
         .000558e0,.000459e0,.000436e0,.000416e0,.000406e0,.000395e0, &
         .093449e0,.023279e0,.006312e0,.002240e0,.001135e0,.000862e0, &
         .000692e0,.000591e0,.000564e0,.000549e0,.000525e0,.000535e0, &
         .000558e0,.000459e0,.000436e0,.000416e0,.000406e0,.000395e0, &
         .094163e0,.020198e0,.004594e0,.001772e0,.001077e0,.000806e0, &
         .000649e0,.000565e0,.000547e0,.000537e0,.000521e0,.000535e0, &
         .000558e0,.000459e0,.000436e0,.000416e0,.000406e0,.000395e0/), &
         (/18,6/))
    ozone(1:18, 13:18, 4) = RESHAPE( (/ &
         .094877e0,.017116e0,.002877e0,.001305e0,.001018e0,.000751e0, &
         .000606e0,.000539e0,.000529e0,.000524e0,.000516e0,.000535e0, &
         .000558e0,.000459e0,.000436e0,.000416e0,.000406e0,.000395e0, &
         .100592e0,.015718e0,.002411e0,.001007e0,.000802e0,.000642e0, &
         .000559e0,.000526e0,.000501e0,.000474e0,.000470e0,.000439e0, &
         .000430e0,.000358e0,.000333e0,.000311e0,.000302e0,.000302e0, &
         .106308e0,.014320e0,.001946e0,.000709e0,.000585e0,.000533e0, &
         .000512e0,.000512e0,.000473e0,.000425e0,.000423e0,.000342e0, &
         .000301e0,.000257e0,.000232e0,.000212e0,.000205e0,.000209e0, &
         .107021e0,.012233e0,.001533e0,.000643e0,.000556e0,.000505e0, &
         .000471e0,.000448e0,.000403e0,.000362e0,.000355e0,.000296e0, &
         .000251e0,.000207e0,.000180e0,.000161e0,.000152e0,.000140e0, &
         .107735e0,.010146e0,.001120e0,.000576e0,.000526e0,.000477e0, &
         .000430e0,.000385e0,.000332e0,.000300e0,.000288e0,.000249e0, &
         .000202e0,.000158e0,.000132e0,.000114e0,.000104e0,.000093e0, &
         .107002e0,.009961e0,.001025e0,.000533e0,.000497e0,.000460e0, &
         .000422e0,.000385e0,.000332e0,.000300e0,.000288e0,.000249e0, &
         .000202e0,.000158e0,.000132e0,.000114e0,.000104e0,.000093e0/), &
         (/18,6/))
    ozone(1:18, 19:24, 4) = RESHAPE( (/ &
         .109850e0,.010424e0,.001079e0,.000567e0,.000498e0,.000479e0, &
         .000463e0,.000448e0,.000418e0,.000399e0,.000389e0,.000367e0, &
         .000351e0,.000328e0,.000320e0,.000337e0,.000355e0,.000304e0, &
         .112375e0,.011255e0,.001357e0,.000744e0,.000585e0,.000533e0, &
         .000512e0,.000512e0,.000504e0,.000499e0,.000491e0,.000486e0, &
         .000501e0,.000502e0,.000509e0,.000561e0,.000607e0,.000515e0, &
         .111320e0,.011439e0,.001485e0,.000843e0,.000642e0,.000549e0, &
         .000512e0,.000512e0,.000504e0,.000499e0,.000491e0,.000486e0, &
         .000501e0,.000502e0,.000509e0,.000561e0,.000607e0,.000515e0, &
         .107719e0,.013052e0,.001822e0,.000953e0,.000701e0,.000604e0, &
         .000551e0,.000525e0,.000509e0,.000499e0,.000491e0,.000486e0, &
         .000501e0,.000502e0,.000509e0,.000561e0,.000607e0,.000515e0, &
         .104118e0,.014665e0,.002159e0,.001063e0,.000759e0,.000659e0, &
         .000589e0,.000539e0,.000514e0,.000499e0,.000491e0,.000486e0, &
         .000501e0,.000502e0,.000509e0,.000561e0,.000607e0,.000515e0, &
         .104145e0,.018082e0,.003274e0,.001493e0,.000919e0,.000762e0, &
         .000678e0,.000641e0,.000584e0,.000531e0,.000495e0,.000486e0, &
         .000501e0,.000502e0,.000509e0,.000561e0,.000607e0,.000515e0/), &
         (/18,6/))
    ozone(1:18, 25:30, 4) = RESHAPE( (/ &
         .104172e0,.021499e0,.004389e0,.001922e0,.001078e0,.000865e0, &
         .000767e0,.000743e0,.000654e0,.000562e0,.000499e0,.000486e0, &
         .000501e0,.000502e0,.000509e0,.000561e0,.000607e0,.000515e0, &
         .101718e0,.026523e0,.008473e0,.004382e0,.002392e0,.001505e0, &
         .001036e0,.000836e0,.000727e0,.000618e0,.000550e0,.000494e0, &
         .000501e0,.000479e0,.000473e0,.000509e0,.000541e0,.000445e0, &
         .099264e0,.031548e0,.012557e0,.006841e0,.003705e0,.002144e0, &
         .001304e0,.000930e0,.000799e0,.000675e0,.000601e0,.000503e0, &
         .000501e0,.000459e0,.000436e0,.000460e0,.000486e0,.000398e0, &
         .097501e0,.035382e0,.014856e0,.008207e0,.004619e0,.002720e0, &
         .001610e0,.001012e0,.000829e0,.000687e0,.000610e0,.000503e0, &
         .000501e0,.000459e0,.000436e0,.000460e0,.000486e0,.000398e0, &
         .095737e0,.039215e0,.017155e0,.009572e0,.005532e0,.003296e0, &
         .001916e0,.001094e0,.000858e0,.000699e0,.000618e0,.000503e0, &
         .000501e0,.000459e0,.000436e0,.000460e0,.000486e0,.000398e0, &
         .092863e0,.042419e0,.020704e0,.012034e0,.007417e0,.004504e0, &
         .002590e0,.001334e0,.000977e0,.000731e0,.000622e0,.000503e0, &
         .000501e0,.000459e0,.000436e0,.000460e0,.000486e0,.000398e0/), &
         (/18,6/))
    ozone(1:18, 31:36, 4) = RESHAPE( (/ &
         .089988e0,.045622e0,.024253e0,.014495e0,.009303e0,.005711e0, &
         .003264e0,.001574e0,.001096e0,.000762e0,.000627e0,.000503e0, &
         .000501e0,.000459e0,.000436e0,.000460e0,.000486e0,.000398e0, &
         .084591e0,.046553e0,.025037e0,.015156e0,.009841e0,.006124e0, &
         .003534e0,.001693e0,.001170e0,.000793e0,.000631e0,.000537e0, &
         .000551e0,.000509e0,.000486e0,.000516e0,.000548e0,.000446e0, &
         .079194e0,.047483e0,.025822e0,.015818e0,.010380e0,.006537e0, &
         .003804e0,.001811e0,.001245e0,.000825e0,.000635e0,.000570e0, &
         .000603e0,.000559e0,.000538e0,.000574e0,.000614e0,.000515e0, &
         .077409e0,.048159e0,.026661e0,.016596e0,.010962e0,.006972e0, &
         .004160e0,.002132e0,.001391e0,.000868e0,.000686e0,.000601e0, &
         .000603e0,.000559e0,.000538e0,.000574e0,.000614e0,.000515e0, &
         .075625e0,.048835e0,.027500e0,.017375e0,.011544e0,.007407e0, &
         .004516e0,.002453e0,.001536e0,.000912e0,.000737e0,.000632e0, &
         .000603e0,.000559e0,.000538e0,.000574e0,.000614e0,.000515e0, &
         .074927e0,.049459e0,.029215e0,.018025e0,.011754e0,.007786e0, &
         .004972e0,.002926e0,.001817e0,.001025e0,.000758e0,.000632e0, &
         .000603e0,.000559e0,.000538e0,.000574e0,.000614e0,.000515e0/), &
         (/18,6/))
    ozone(1:18, 37, 4) = (/ &
         .074229e0,.050084e0,.030930e0,.018676e0,.011965e0,.008165e0, &
         .005428e0,.003399e0,.002098e0,.001138e0,.000780e0,.000632e0, &
         .000603e0,.000559e0,.000538e0,.000574e0,.000614e0,.000515e0/)

    ozsig(:) = (/ &
         .020747,.073986,.124402,.174576,.224668,.274735, &
         .324767,.374806,.424818,.497450,.593540,.688125, &
         .777224,.856317,.920400,.960480,.981488,.995004/)


    first_getoz=.TRUE.

  END SUBROUTINE InitRadiation

  SUBROUTINE InitSpmrad
    pai12      = pai/12.e0
    pai2i      = 1.0e0/(2.0e0*pai)
    fim24      = 24.0e0/360.0e0
  END SUBROUTINE InitSpmrad

  SUBROUTINE InitRadtim(monl)
    INTEGER, INTENT(in ) :: monl(12)
    INTEGER              :: m
    monday(1)=0
    DO m=2,12
       monday(m)=monday(m-1)+monl(m-1)
    END DO
  END SUBROUTINE InitRadtim
  SUBROUTINE InitGetoz(yrl,kmax,sl)
    IMPLICIT NONE  
    REAL,    INTENT(IN   ) :: yrl       
    INTEGER, INTENT(IN   ) :: kmax
    REAL,    INTENT(in   ) :: sl (kmax)
    INTEGER                :: l, ll

    IF(first_getoz)THEN
       mon_getoz=yrl/12.
       year_getoz=yrl
       IF(nlm_getoz.NE.kmax)THEN
          inter_getoz=.TRUE.
       ELSE
          inter_getoz=.FALSE.
          DO l=1,nlm_getoz
             ll=nlm_getoz-l+1
             IF(ABS(ozsig(l)-sl(ll)).GT..0001)inter_getoz=.TRUE.
          END DO
       ENDIF
       first_getoz=.FALSE.
    ENDIF
  END SUBROUTINE InitGetoz

  SUBROUTINE COSZMED(idatec,tod,nfprt,nferr,yrl,colrad,lonrad,cos2,ncols)
    IMPLICIT NONE
    INTEGER, INTENT(IN   )  :: ncols
    INTEGER, INTENT(IN   )  :: idatec(4)
    REAL   , INTENT(IN   )  :: tod
    INTEGER, INTENT(IN   )  :: nfprt
    INTEGER, INTENT(IN   )  :: nferr
    REAL   , INTENT(IN   )  :: yrl
    REAL   , INTENT(IN   )  :: colrad (ncols)
    REAL   , INTENT(in   )  :: lonrad (ncols)
    REAL   , INTENT(OUT  )  :: cos2   (ncols)

    REAL                    :: sindel 
    REAL                    :: cosdel   
    REAL                    :: cosmax 
    REAL                    :: ctime 
    REAL                    :: frh 
    REAL                    :: btime 
    REAL                    :: atime  
    REAL                    :: zenith1 (ncols) 
    REAL                    :: zenith2 (ncols)
    REAL                    :: zenith  (ncols)
    REAL                    :: f3600 =3.6e3  
    INTEGER                 :: ncount                  
    REAL                    :: alon=0.0
    REAL              :: sdelt
    REAL              :: ratio
    REAL              :: etime
    REAL              :: xday
    INTEGER                 :: i
    CALL radtim(idatec,sdelt ,ratio ,etime ,tod   ,xday  ,nfprt , &
         nferr ,yrl)

    sindel = SIN(sdelt)
    cosdel = COS(sdelt)
    ctime  = alon/15.0e0
    cos2   = 0.0e0
    cosmax = 0.0e0
    btime  = 0.0e0
    atime  = 0.0e0
    DO i=1,ncols
       zenith1(i)  = sindel*COS(colrad(i))
    ENDDO
    frh=( MOD(tod+0.03125,f3600)-0.03125)/f3600
    ncount =0
    DO i=1,ncols
       btime       = fim24*lonrad(i)+ctime
       atime       = etime+pai12*(12.0-idatec(1)-frh-btime)
       zenith2(i)  = cosdel*SIN(colrad(i))*COS(atime)
       zenith(i)   = zenith1(i) + zenith2(i)
       IF(zenith(i).GT.0.0e0) THEN
          ncount   =ncount+1
          cosmax     =cosmax+zenith(i)
       END IF
    END DO
    IF(ncount.EQ.0) ncount=1
    cos2=cosmax/float(ncount)
  END SUBROUTINE COSZMED

  ! crunch: Computation of the gaseous transmission functions




  SUBROUTINE crunch(indx1 ,indx2 ,ncols ,kmax  ,h0p   ,h1p   ,ozone ,txuf  , &
       tv1   ,tv2   ,tui   ,tui2  ,x1    ,x2    ,cc    ,rawi  , &
       x3    ,x4    ,ch    ,css   ,ccu   ,shi   ,shu   ,wdel  , &
       fw    ,pai   ,tai   ,ozai  ,ubar  ,vbar  ,wbar  ,ubarm , &
       vbarm ,wbarm ,fluxu ,fluxd )
    !
    !
    !  Input formal parameters :: index1, index2
    !  parameters used to calculate trnasmission functions
    !  From one level to another
    !==========================================================================
    ! ncols......Number of grid points on a gaussian latitude circle
    ! kmax......Number of grid points at vertical
    ! indx1.....parameters used to calculate trnasmission functions
    ! indx2.....parameters used to calculate trnasmission functions
    ! h0p.......constant h0p = 0.0e0 fac converts to degrees / time step
    ! h1p.......constant h1p = 1.0e0 fac converts to degrees / time step
    ! ozone.....set ozone logical variable  ozone = (.NOT. noz)
    ! txuf......1.used as matrix of g-functions for paths from each level
    !             to all other layers.
    !           2.used for transmission in co2 band.
    !           3.used for transmission in ozone band.
    !           4.in cldslw used for probability of clear line-of-sight
    !             from each level to all other layers for max overlap.
    ! tv1.......Working dimension   
    ! tv2 ......Working dimension  
    ! tui.......Working dimension   
    ! tui2......Working dimension  
    ! x1........path water vapor(e-type) and working dimension	 
    ! x2........path water vapor(band-center) and working dimension	 
    ! cc........planck function at level temperature for co2 bands.	 
    ! rawi......water vapor amount in layer.  
    ! x3........path water vapor (band-wings) and working dimension   	 
    ! x4........Working dimension	 
    ! ch........Probability of clear line-of-sight from level to top of
    !           the atmosphere.	 
    ! css.......Large scale cloud amount and working dimension   
    ! ccu.......Cumulus cloud amount and working dimension   
    ! shi.......Total transmission function (water vapor + CO2 + ozone)
    !           g-function for a path from level to top of atmosphere.   
    ! shu.......Total transmission function (water vapor + CO2 + ozone)
    !           g-function for a path from level  of atmosphere to surface   
    ! wdel......Ozone path, water vapor (e-TYPE) transmission function in 
    !           9.6 mcm band  
    ! fw........Ozone path multiplied bye pressure	 
    ! pai.......Pressure at middle of layer  
    ! tai.......Temperature at middle of layer  
    ! ozai......ozone amount in layer. 
    ! ubar......scaled water vapor path length in window. 
    ! vbar......scaled water vapor path length in center. 
    ! wbar......scaled water vapor path length in wing. 
    ! ubarm.....ubarm(i,2) = (ubar(i,2) + ubar(i,1)) * hp5
    ! vbarm.... planck function at level temperature for ozone band.
    ! wbarm.... ubarm(i,2) = (ubar(i,2) + ubar(i,1)) * hp5
    ! fluxu.....Ozone path
    ! fluxd.....Ozone path mutiplicated by pressure
    !
    !==========================================================================
    INTEGER, INTENT(IN   ) :: ncols
    INTEGER, INTENT(IN   ) :: kmax                       
    INTEGER, INTENT(IN   ) :: indx1
    INTEGER, INTENT(IN   ) :: indx2
    REAL,    INTENT(IN   ) :: h0p                        
    REAL,    INTENT(IN   ) :: h1p                        
    LOGICAL, INTENT(IN   ) :: ozone                      
    REAL,    INTENT(OUT  ) :: txuf  (ncols,kmax+2,kmax+2) 
    REAL,    INTENT(IN   ) :: tv1   (ncols,kmax+3) 
    REAL,    INTENT(IN   ) :: tv2   (ncols,kmax+3) 
    REAL,    INTENT(IN   ) :: tui   (ncols,kmax+3) 
    REAL,    INTENT(IN   ) :: tui2  (ncols,kmax+3) 
    REAL,    INTENT(OUT  ) :: x1    (ncols,kmax+3) 
    REAL,    INTENT(OUT  ) :: x2    (ncols,kmax+3) 
    REAL,    INTENT(IN   ) :: cc    (ncols,kmax+3) 
    REAL,    INTENT(IN   ) :: rawi  (ncols,kmax+3) 
    REAL,    INTENT(OUT  ) :: x3    (ncols,kmax+2) 
    REAL,    INTENT(OUT  ) :: x4    (ncols,kmax+2) 
    REAL,    INTENT(IN   ) :: ch    (ncols,kmax+2) 
    REAL,    INTENT(IN   ) :: css   (ncols,kmax+2) 
    REAL,    INTENT(IN   ) :: ccu   (ncols,kmax+2) 
    REAL,    INTENT(OUT  ) :: shi   (ncols,kmax+2) 
    REAL,    INTENT(OUT  ) :: shu   (ncols,kmax+1) 
    REAL,    INTENT(OUT  ) :: wdel  (ncols,kmax+1) 
    REAL,    INTENT(OUT  ) :: fw    (ncols,kmax+1) 

    ! Local Variables --->> Global Variables

    REAL,    INTENT(IN   ) :: pai  (ncols,kmax+2)
    REAL,    INTENT(IN   ) :: tai  (ncols,kmax+2)
    REAL,    INTENT(IN   ) :: ozai (ncols,kmax+2)
    REAL,    INTENT(IN   ) :: ubar (ncols,kmax+2)
    REAL,    INTENT(IN   ) :: vbar (ncols,kmax+2)
    REAL,    INTENT(IN   ) :: wbar (ncols,kmax+2)
    REAL,    INTENT(IN   ) :: ubarm(ncols,kmax+2)
    REAL,    INTENT(IN   ) :: vbarm(ncols,kmax+2)
    REAL,    INTENT(IN   ) :: wbarm(ncols,kmax+2)
    REAL,    INTENT(IN   ) :: fluxu(ncols,kmax+2)
    REAL,    INTENT(IN   ) :: fluxd(ncols,kmax+2)

    REAL                   :: adel  (ncols,kmax+1)        
    REAL                   :: bdel  (ncols,kmax+1)        
    REAL                   :: yv    (ncols,kmax+1)        
    REAL                   :: zv    (ncols,kmax+1)        
    REAL                   :: wv    (ncols,kmax+1)        
    REAL                   :: fu    (ncols,kmax+1)        
    REAL                   :: yw    (ncols,kmax+1)        
    REAL                   :: zw    (ncols,kmax+1)        
    REAL                   :: ww    (ncols,kmax+1)        

    !  Local Parameter

    REAL, PARAMETER        :: h9p8  = -9.79e0
    REAL, PARAMETER        :: h27p  = -27.0e0
    REAL, PARAMETER        :: hp61  = 6.15384615e-1
    REAL, PARAMETER        :: h15p1 = 15.1e0
    REAL, PARAMETER        :: h3p1  = -3.1e0
    REAL, PARAMETER        :: hp9   = 0.9e0
    REAL, PARAMETER        :: hp04  = -0.04e0
    REAL, PARAMETER        :: h16p  = 16.0e0
    REAL, PARAMETER        :: h6p7  = -6.7e0
    REAL, PARAMETER        :: h1013 = 1013.25e0
    REAL, PARAMETER        :: h1381 = 1381.12e0
    REAL, PARAMETER        :: hp88  = 0.8796e0
    REAL, PARAMETER        :: hp677 = 6.7675e-1
    REAL, PARAMETER        :: h4p4  = -4.398e0
    REAL, PARAMETER        :: hp38  = 3.84615384e-1

    INTEGER                :: ip 
    !INTEGER                :: ix 
    INTEGER                :: i  ! loop indices 
    INTEGER                :: k  ! loop indices
    !INTEGER                :: isub
    !INTEGER                :: ksub
    !INTEGER                :: imtn 
    INTEGER                :: ip1 
    INTEGER                ::  n 
    INTEGER                :: i0 
    INTEGER                :: i1 
    INTEGER                :: i2
    
    REAL                   :: x1_s
    REAL                   :: x2_s
    REAL                   :: x3_s
    REAL                   :: adel_s
    REAL                   :: bdel_s
    REAL                   :: wdel_s
    REAL                   :: fw_s
    REAL                   :: fu_s
    REAL                   :: yw_s
    REAL                   :: ww_s
    REAL                   :: yv_s
    REAL                   :: wv_s
    REAL                   :: zv_s
    REAL                   :: zw_s

    IF (ozone) THEN
       IF (indx1 == indx2) THEN
             IF (indx2 == 1) THEN
        	DO k = 1, kMax+1
        	   DO i = 1, ncols
        	      x1(i,k) = ABS(ubar(i,k+1))
        	      x2(i,k) = ABS(vbar(i,k+1))
        	      x3(i,k) = ABS(wbar(i,k+1))
        	      adel(i,k) = ABS(tai(i,k+1))
        	      bdel(i,k) = ABS(ch(i,k+1))
        	   END DO
        	END DO
             ELSE
        	DO k = 1, kmax+1
        	   DO i = 1, ncols
        	      x1(i,k)   = ubar(i,kmax+2) - ubar(i,k)
        	      x2(i,k)   = vbar(i,kmax+2) - vbar(i,k)
        	      x3(i,k)   = wbar(i,kmax+2) - wbar(i,k)
        	      adel(i,k) = tai(i,kmax+2)  - tai(i,k)
        	      bdel(i,k) = ch(i,kmax+2)   - ch(i,k)
        	      wdel(i,k) = fluxu(i,kmax+2) - fluxu(i,k)
        	      fw(i,k)	= fluxd(i,kmax+2) - fluxd(i,k)
        	      x1(i,k) = ABS(x1(i,k))
        	      x2(i,k) = ABS(x2(i,k))
        	      x3(i,k) = ABS(x3(i,k))
        	      adel(i,k) = ABS(adel(i,k))
        	      bdel(i,k) = ABS(bdel(i,k))
        	      wdel(i,k) = ABS(wdel(i,k))
        	      fw  (i,k) = ABS(fw  (i,k))
        	   END DO
        	END DO
             END IF
	     
             DO k=1,kmax+1
        	DO i = 1, ncols	 
        	   fu_s = h9p8 * x1(i,k)
        	   yw_s = EXP(LOG(x1(i,k) + 1.0e-100)*.83)
        	   ww_s = EXP(LOG(x3(i,k) + 1.0e-100)*.6)
        	   ww_s = h1p + h16p  * ww_s
        	   ww_s = h6p7 * x3(i,k) / ww_s
        	   ww_s = h27p * yw_s + ww_s
        	   yw_s = EXP(LOG(adel(i,k) + 1.0e-100)*.56)
        	   yw_s = h1p  + h15p1     * yw_s
        	   yv_s = h3p1 * adel(i,k) / yw_s
        	   yv_s = yv_s	      + ww_s
        	   yw_s = EXP(LOG(bdel(i,k) + 1.0e-100)*.57)
        	   yw_s = h1p  + hp9       * yw_s
        	   wv_s = hp04 * bdel(i,k) / yw_s
        	   wv_s = wv_s + ww_s
           	   fw_s   = fw(i,k)/ (wdel(i,k) * h1013)
           	   zv_s   = h1381	* wdel(i,k)  / (hp88 * fw_s)
           	   adel_s = h1p	+ zv_s
             	   adel_s = SQRT(adel_s)
        	   adel_s = h4p4 * fw_s * (adel_s - h1p)
          	   zv_s = EXP(adel_s)
        	   fw_s = h1p - hp677 * (h1p - zv_s)
        	   adel_s = EXP(yv_s)
        	   bdel_s = EXP(wv_s)
        	   wdel_s = EXP(fu_s)
        	   yw_s = SQRT(x2(i,k))
        	   zw_s = SQRT(x3(i,k))
        	   ww_s = ((h1p	  + 32.2095e0	 * x1(i,k)) &
        		/  (h1p        + 52.85e0      * x1(i,k)) &
        		+  (0.534874e0 + 199.0e0      * x1(i,k) &
        		-  1990.63e0   * x1(i,k)      * x1(i,k)) &
        		*  zw_s &
        		/ (h1p         + 333.244e0    * x1(i,k))) &
        		/ ((h1p        + 74.144e0     * x1(i,k)) &
        		/ (0.43368e0   + 24.7442e0    * x1(i,k)) &
        		* zw_s      + h1p)
        	   wv_s = (h1p	  + 9.22411e0	 * yw_s &
        		+ 33.1236e0    * x2(i,k) &
        		+ 176.396e0    * x2(i,k)      * x2(i,k))
        	   wv_s = h1p	  / wv_s
        	   ww_s = MAX(ww_s, h0p)
        	   wv_s = MAX(wv_s, h0p)
        	   x1_s = MIN(x1(i,k), 0.06e0)
        	   x2_s = MIN(x2(i,k), 2.0e0)
        	   x3_s = MIN(x3(i,k), 8.0e0)
        	   yw_s = SQRT(x2_s)
        	   zw_s = SQRT(x3_s)
        	   fu_s = x1_s * x1_s
        	   yv_s = (0.0851069e0 * yw_s	       &
        		- 0.187096e0   * x2_s  * yw_s &
        		+ 0.323105e0   * x2_s) * 0.1e0
        	   zv_s = 0.239186e0   * x2_s	       &
        		- 0.0922289e0  * x2_s  * yw_s &
        		- 0.0167413e0  * x2_s  * x2_s	   
        	   zv_s = zv_s * 1.0e-3	       
        	   yw_s = (5.6383e-4    + 1.05173e0  * x1_s &
        		- 39.0722e0	* fu_s) &
        		/ (h1p  	+ 202.357e0  * x1_s) &
        		+ (0.0779555e0  + 4.40720e0  * x1_s &
        		+ 3.15851e0	* fu_s)   * zw_s &
        		/ (h1p  	+ 40.2298e0  * x1_s) &
        		+ (-0.0381305e0 - 3.63684e0  * x1_s &
        		+ 7.98951e0	* fu_s)   * x3_s &
        		/ (h1p  	+ 62.5692e0  * x1_s) &
        		+ (6.21039e-3	+ 0.710061e0 * x1_s &
        		- 2.85241e0	* fu_s)   * x3_s &
        		/ (h1p  	+ 70.2912e0  * x1_s) &
        		* zw_s
        	   yw_s = 0.1e0	   * yw_s 
        	   zw_s = (-2.99542e-4 + 0.238219e0 * x1_s &
        		+ 0.519264e0   * fu_s) &
        		/ (h1p         + 10.7775e0  * x1_s) &
        		+ (-2.91325e-2 - 2.30007e0  * x1_s &
        		+ 10.946e0     * fu_s)   * zw_s &
        		/ (h1p         + 63.519e0   * x1_s) &
        		+ (1.43812e-2  + 1.80265e0  * x1_s &
        		- 10.1311e0    * fu_s)   * x3_s &
        		/ (h1p         + 98.4758e0  * x1_s) &
        		+ (-2.39016e-3 - 3.71427e-1 * x1_s &
        		+ 2.35443e0    * fu_s)   * x3_s &
        		/ (h1p         + 120.228e0  * x1_s) &
        		* zw_s
        	   zw_s = 1.0e-3	  * zw_s	     
        	   adel_s = hp38 * adel_s + hp61 * bdel_s
        	   fw_s   = fw_s * wdel_s
		   !
		   yw(i,k) = yw_s
		   ww(i,k) = ww_s
		   yv(i,k) = yv_s
		   wv(i,k) = wv_s
		   fw(i,k) = fw_s
		   zv(i,k) = zv_s
		   adel(i,k)= adel_s
		   zw(i,k) = zw_s
		   x1(i,k) = x1_s
		   x2(i,k) = x2_s
		   x3(i,k) = x3_s
        	END DO
             END DO

             IF (indx2 == 1) THEN
        	DO k = 2, kmax+2
        	   DO i = 1, ncols
        	      x1(i,k)   = wv(i,k-1)	* tv1(i,1)
        	      x2(i,k)   = yv(i,k-1)	* tui(i,1) + h1p &
        		   + zv(i,k-1)   * tui2(i,1)
        	      x3(i,k)   = ww(i,k-1)	* tv2(i,1)
        	      x4(i,k)   = yw(i,k-1)	* tui(i,1) + h1p &
        		   + zw(i,k-1)   * tui2(i,1)
        	      fw(i,k-1) = adel(i,k-1) * cc(i,1) &
        		   + fw(i,k-1)   * rawi(i,1)
        	   END DO
        	END DO

        	DO k = 2, kmax+2
        	   DO i = 1, ncols
        	      shi(i,k) = x1(i,k)*x2(i,k) + x3(i,k)*x4(i,k) + fw(i,k-1)
        	   END DO
        	END DO

             ELSE

        	DO k = 1, kmax+1
        	   DO i = 1, ncols
        	      x1(i,k) =  wv(i,k) * tv1(i,(kmax+3)) &
        		   * (yv(i,k) * tui(i,(kmax+3))  + h1p &
        		   + zv(i,k)  * tui2(i,(kmax+3)))
        	      x2(i,k) = ww(i,k)  * tv2(i,(kmax+3)) &
        		   * (yw(i,k) * tui(i,(kmax+3))  + h1p &
        		   +  zw(i,k) * tui2(i,(kmax+3)))
        	      x3(i,k) =  wv(i,k) * tv1(i,(kmax+2)) &
        		   * (yv(i,k) * tui(i,(kmax+2))    + h1p &
        		   + zv(i,k)  * tui2(i,(kmax+2)))
        	      x4(i,k) = ww(i,k)  * tv2(i,(kmax+2)) &
        		   * (yw(i,k) * tui(i,(kmax+2))    + h1p &
        		   +  zw(i,k) * tui2(i,(kmax+2)))
        	      shu(i,k) = (cc(i,(kmax+3))-cc(i,(kmax+2)))*adel(i,k) &
        		   + (rawi(i,(kmax+3)) - rawi(i,(kmax+2))) * fw(i,k)
        	      shu(i,k) = x1(i,k) + x2(i,k) - x3(i,k) - x4(i,k) &
        		   + shu(i,k)
        	   END DO
        	END DO

             END IF
       ELSE
          IF (indx2 == (kmax+2)) THEN
           DO ip = indx1, indx2  
              DO k = indx1, ip
                 DO i = 1, (ncols)
                    x1(i,k-1)   = ubar(i,ip) - ubarm(i,k)
                    x2(i,k-1)   = vbar(i,ip) - vbarm(i,k)
                    x3(i,k-1)   = wbar(i,ip) - wbarm(i,k)
                    adel(i,k-1) = tai(i,ip)  - css(i,k)
                    bdel(i,k-1) = ch(i,ip)   - ccu(i,k)
                    wdel(i,k-1) = fluxu(i,ip) - ozai(i,k)
                    fw(i,k-1)   = fluxd(i,ip) - pai(i,k)
                 END DO
              END DO
              DO k = 1, ip-1
                 DO i  = 1, ncols
                    x1_s = ABS(x1(i,k))
                    x2_s = ABS(x2(i,k))
                    x3_s = ABS(x3(i,k))
                    adel_s = ABS(adel(i,k))
                    bdel_s = ABS(bdel(i,k))
                    wdel_s = ABS(wdel(i,k))
                    fw_s = ABS(fw(i,k))
                    fu_s = h9p8 * x1_s
                    yw_s = EXP(LOG(x1_s + 1.0e-100)*.83)
                    ww_s = EXP(LOG(x3_s + 1.0e-100)*.6)
                    ww_s = h1p + h16p  * ww_s
                    ww_s = h6p7 * x3_s / ww_s
                    ww_s = h27p * yw_s + ww_s
                    yw_s = EXP(LOG(adel_s + 1.0e-100)*.56)
                    yw_s = h1p  + h15p1     * yw_s
                    yv_s = h3p1 * adel_s / yw_s
                    yv_s = yv_s	      + ww_s
                    yw_s = EXP(LOG(bdel_s + 1.0e-100)*.57)
                    yw_s = h1p  + hp9       * yw_s
                    wv_s = hp04 * bdel_s / yw_s
                    wv_s = wv_s + ww_s
                    fw_s	= fw_s / (wdel_s * h1013)
                    zv_s	= h1381   * wdel_s  / (hp88 * fw_s)
                    adel_s = h1p	  + zv_s
                    adel_s = SQRT(adel_s)
                    adel_s = h4p4 * fw_s * (adel_s - h1p)
                    zv_s = EXP(adel_s)
                    fw_s = h1p - hp677 * (h1p - zv_s)
                    adel_s = EXP(yv_s)
                    bdel_s = EXP(wv_s)
                    wdel_s = EXP(fu_s)
                    yw_s = SQRT(x2_s)
                    zw_s = SQRT(x3_s)
                    ww_s = ((h1p	  + 32.2095e0	 * x1_s) &
                         /  (h1p        + 52.85e0      * x1_s) &
                         +  (0.534874e0 + 199.0e0      * x1_s  &
                         -  1990.63e0   * x1_s      * x1_s) &
                         *  zw_s				 &
                         / (h1p         + 333.244e0    * x1_s))&
                         / ((h1p        + 74.144e0     * x1_s) &
                         / (0.43368e0   + 24.7442e0    * x1_s) &
                         * zw_s      + h1p)
                    wv_s = (h1p	  + 9.22411e0	 * yw_s  &
                         + 33.1236e0    * x2_s		 &
                         + 176.396e0    * x2_s      * x2_s)
                    wv_s = h1p	  / wv_s
                    ww_s = MAX(ww_s, h0p)
                    wv_s = MAX(wv_s, h0p)
                    x1_s = MIN(x1_s, 0.06e0)
                    x2_s = MIN(x2_s, 2.0e0)
                    x3_s = MIN(x3_s, 8.0e0)
                    yw_s = SQRT(x2_s)
                    zw_s = SQRT(x3_s)
                    fu_s = x1_s * x1_s
                    yv_s = (0.0851069e0  * yw_s &
                         -  0.187096e0	* x2_s  * yw_s &
                         +  0.323105e0	* x2_s) * 0.1e0
                    zv_s =  0.239186e0   * x2_s &
                         -  0.0922289e0  * x2_s  * yw_s &
                         -  0.0167413e0  * x2_s  * x2_s
                    zv_s =  zv_s * 1.0e-3
                    yw_s = (5.6383e-4    + 1.05173e0  * x1_s &
                         - 39.0722e0	* fu_s) &
                         / (h1p  	+ 202.357e0  * x1_s) &
                         + (0.0779555e0  + 4.40720e0  * x1_s  &
                         + 3.15851e0	* fu_s)   * zw_s  &
                         / (h1p  	+ 40.2298e0  * x1_s) &
                         + (-0.0381305e0 - 3.63684e0  * x1_s  &
                         + 7.98951e0	* fu_s)   * x3_s  &
                         / (h1p  	+ 62.5692e0  * x1_s) &
                         + (6.21039e-3	+ 0.710061e0 * x1_s  &
                         - 2.85241e0	* fu_s)   * x3_s  &
                         / (h1p  	+ 70.2912e0  * x1_s) &
                         * zw_s	 
                    yw_s = 0.1e0	   * yw_s
                    zw_s = (-2.99542e-4 + 0.238219e0 * x1_s &
                         + 0.519264e0   * fu_s) &
                         / (h1p         + 10.7775e0  * x1_s) &
                         + (-2.91325e-2 - 2.30007e0  * x1_s &
                         + 10.946e0     * fu_s)   * zw_s &
                         / (h1p         + 63.519e0   * x1_s) &
                         + (1.43812e-2  + 1.80265e0  * x1_s &
                         - 10.1311e0    * fu_s)   * x3_s &
                         / (h1p         + 98.4758e0  * x1_s) &
                         + (-2.39016e-3 - 3.71427e-1 * x1_s &
                         + 2.35443e0    * fu_s)   * x3_s &
                         / (h1p         + 120.228e0  * x1_s) &
                         * zw_s
                    zw_s = 1.0e-3	  * zw_s
		    !
		    adel(i,k) = adel_s
		    bdel(i,k) = bdel_s
		    wdel(i,k) = wdel_s
		    fw(i,k)   = fw_s
		    !
		    ! fu(i,k) nao usa depois
		    yw(i,k)   = yw_s
		    ww(i,k)   = ww_s
		    yv(i,k)   = yv_s
		    wv(i,k)   = wv_s
		    zv(i,k)   = zv_s
		    zw(i,k)   = zw_s
                 END DO
              END DO
              DO k = 1, ip-1
                 DO i = 1, ncols
                    x1_s =  wv(i,k)  * tv1 (i,k) &
                         * (yv(i,k)  * tui (i,k)    + h1p &
                         +  zv(i,k)  * tui2(i,k)) 
                    x2_s =  ww(i,k)  * tv2 (i,k) &
                         * (yw(i,k)  * tui (i,k)    + h1p &
                         +  zw(i,k)  * tui2(i,k))
                    x3_s =  wv(i,k)  * tv1 (i,2+k-1) &
                         * (yv(i,k)  * tui (i,2+k-1) + h1p &
                         +  zv(i,k)  * tui2(i,2+k-1))     
                    x4(i,k) =  ww(i,k)  * tv2 (i,2+k-1) &
                         * (yw(i,k)  * tui (i,2+k-1)   + h1p &
                         +  zw(i,k)  * tui2(i,2+k-1))
                    txuf(i,k,ip) =  x1_s		+ x2_s &
                         -  x3_s	     - x4(i,k) &
                         + (cc(i,1+k-1)    - cc(i,2+k-1)) &
                         * (hp38 	     * adel(i,k) &
                         +  hp61 	     * bdel(i,k)) &
                         + (rawi(i,1+k-1)  - rawi(i,2+k-1)) &
                         *  fw(i,k)	     * wdel(i,k)
	            !
		    x1(i,k) = x1_s
		    x2(i,k) = x2_s
		    x3(i,k) = x3_s
                 END DO
              END DO
           END DO
	  END IF


          IF (indx2 /= (kmax+2)) THEN
             DO ip = indx1, indx2
             	DO k = indx1, (kmax+2)-ip
        	   DO i = 1, (ncols)
        	      x1(i,k-0)   = ubar(i,ip) - ubarm(i,k+ip)
        	      x2(i,k-0)   = vbar(i,ip) - vbarm(i,k+ip)
        	      x3(i,k-0)   = wbar(i,ip) - wbarm(i,k+ip)
        	      adel(i,k-0) = tai(i,ip)  - css(i,k+ip)
        	      bdel(i,k-0) = ch(i,ip)	- ccu(i,k+ip)
        	      wdel(i,k-0) = fluxu(i,ip) - ozai(i,k+ip)
        	      fw(i,k-0)   = fluxd(i,ip) - pai(i,k+ip)
        	   END DO
             	END DO

             	DO k = 1, (kmax+2)-ip
        	   DO i  = 1, ncols
        	      x1(i,k) = ABS(x1(i,k))
        	      x2(i,k) = ABS(x2(i,k))
        	      x3(i,k) = ABS(x3(i,k))
        	      adel(i,k) = ABS(adel(i,k))
        	      bdel(i,k) = ABS(bdel(i,k))
        	      wdel(i,k) = ABS(wdel(i,k))
        	      fw(i,k) = ABS(fw(i,k))
        	      fu(i,k) = h9p8 * x1(i,k)
        	      yw(i,k) = EXP(LOG(x1(i,k) + 1.0e-100)*.83)
        	      ww(i,k) = EXP(LOG(x3(i,k) + 1.0e-100)*.6)
        	      ww(i,k) = h1p + h16p  * ww(i,k)
        	      ww(i,k) = h6p7 * x3(i,k) / ww(i,k)
        	      ww(i,k) = h27p * yw(i,k) + ww(i,k)
        	      yw(i,k) = EXP(LOG(adel(i,k) + 1.0e-100)*.56)
        	      yw(i,k) = h1p  + h15p1	 * yw(i,k)
        	      yv(i,k) = h3p1 * adel(i,k) / yw(i,k)
        	      yv(i,k) = yv(i,k) 	 + ww(i,k)
        	      yw(i,k) = EXP(LOG(bdel(i,k) + 1.0e-100)*.57)
        	      yw(i,k) = h1p  + hp9	 * yw(i,k)
        	      wv(i,k) = hp04 * bdel(i,k) / yw(i,k)
        	      wv(i,k) = wv(i,k) + ww(i,k)
        	      fw(i,k)	   = fw(i,k) / (wdel(i,k) * h1013)
        	      zv(i,k)	   = h1381   * wdel(i,k)  / (hp88 * fw(i,k))
        	      adel(i,k) = h1p	     + zv(i,k)
        	      adel(i,k) = SQRT(adel(i,k))
        	      adel(i,k) = h4p4 * fw(i,k) * (adel(i,k) - h1p)
        	      zv(i,k) = EXP(adel(i,k))
        	      fw(i,k) = h1p - hp677 * (h1p - zv(i,k))
        	      adel(i,k) = EXP(yv(i,k))
        	      bdel(i,k) = EXP(wv(i,k))
        	      wdel(i,k) = EXP(fu(i,k))
        	      yw(i,k) = SQRT(x2(i,k))
        	      zw(i,k) = SQRT(x3(i,k))
        	      ww(i,k) = ((h1p	     + 32.2095e0    * x1(i,k)) &
        		   /  (h1p	  + 52.85e0	 * x1(i,k)) &
        		   +  (0.534874e0 + 199.0e0	 * x1(i,k)  &
        		   -  1990.63e0   * x1(i,k)	 * x1(i,k)) &
        		   *  zw(i,k)				    &
        		   / (h1p	  + 333.244e0	 * x1(i,k)))&
        		   / ((h1p	  + 74.144e0	 * x1(i,k)) &
        		   / (0.43368e0   + 24.7442e0	 * x1(i,k)) &
        		   * zw(i,k)	  + h1p)
        	      wv(i,k) = (h1p	     + 9.22411e0    * yw(i,k)  &
        		   + 33.1236e0    * x2(i,k)		    &
        		   + 176.396e0    * x2(i,k)	 * x2(i,k))
        	      wv(i,k) = h1p	     / wv(i,k)
        	      ww(i,k) = MAX(ww(i,k), h0p)
        	      wv(i,k) = MAX(wv(i,k), h0p)
        	      x1(i,k) = MIN(x1(i,k), 0.06e0)
        	      x2(i,k) = MIN(x2(i,k), 2.0e0)
        	      x3(i,k) = MIN(x3(i,k), 8.0e0)
        	      yw(i,k) = SQRT(x2(i,k))
        	      zw(i,k) = SQRT(x3(i,k))
        	      fu(i,k) = x1(i,k) * x1(i,k)
        	      yv(i,k) = (0.0851069e0  * yw(i,k) &
        		   -  0.187096e0   * x2(i,k)  * yw(i,k) &
        		   +  0.323105e0   * x2(i,k)) * 0.1e0
        	      zv(i,k) =  0.239186e0   * x2(i,k) &
        		   -  0.0922289e0  * x2(i,k)  * yw(i,k) &
        		   -  0.0167413e0  * x2(i,k)  * x2(i,k)
        	      zv(i,k) =  zv(i,k) * 1.0e-3

        	      yw(i,k) = (5.6383e-4    + 1.05173e0  * x1(i,k) &
        		   - 39.0722e0     * fu(i,k)) &
        		   / (h1p	   + 202.357e0  * x1(i,k)) &
        		   + (0.0779555e0  + 4.40720e0  * x1(i,k)  &
        		   + 3.15851e0     * fu(i,k))	* zw(i,k)  &
        		   / (h1p	   + 40.2298e0  * x1(i,k)) &
        		   + (-0.0381305e0 - 3.63684e0  * x1(i,k)  &
        		   + 7.98951e0     * fu(i,k))	* x3(i,k)  &
        		   / (h1p	   + 62.5692e0  * x1(i,k)) &
        		   + (6.21039e-3   + 0.710061e0 * x1(i,k)  &
        		   - 2.85241e0     * fu(i,k))	* x3(i,k)  &
        		   / (h1p	   + 70.2912e0  * x1(i,k)) &
        		   * zw(i,k)	    
        	      yw(i,k) = 0.1e0	      * yw(i,k)
        	      zw(i,k) = (-2.99542e-4 + 0.238219e0 * x1(i,k) &
        		   + 0.519264e0   * fu(i,k)) &
        		   / (h1p	  + 10.7775e0  * x1(i,k)) &
        		   + (-2.91325e-2 - 2.30007e0  * x1(i,k) &
        		   + 10.946e0	  * fu(i,k))   * zw(i,k) &
        		   / (h1p	  + 63.519e0   * x1(i,k)) &
        		   + (1.43812e-2  + 1.80265e0  * x1(i,k) &
        		   - 10.1311e0    * fu(i,k))   * x3(i,k) &
        		   / (h1p	  + 98.4758e0  * x1(i,k)) &
        		   + (-2.39016e-3 - 3.71427e-1 * x1(i,k) &
        		   + 2.35443e0    * fu(i,k))   * x3(i,k) &
        		   / (h1p	  + 120.228e0  * x1(i,k)) &
        		   * zw(i,k)
        	      zw(i,k) = 1.0e-3       * zw(i,k)
        	   END DO
             	END DO

             	DO k = 1, (kmax+2)-ip
        	   DO i = 1, ncols
        	      x1(i,k) =  wv(i,k)  * tv1 (i,ip+k) &
        		   * (yv(i,k)  * tui (i,ip+k)	 + h1p &
        		   +  zv(i,k)  * tui2(i,ip+k)) 
        	      x2(i,k) =  ww(i,k)  * tv2 (i,ip+k) &
        		   * (yw(i,k)  * tui (i,ip+k)	 + h1p &
        		   +  zw(i,k)  * tui2(i,ip+k))
        	      x3(i,k) =  wv(i,k)  * tv1 (i,ip+0+k-1) &
        		   * (yv(i,k)  * tui (i,ip+0+k-1) + h1p &
        		   +  zv(i,k)  * tui2(i,ip+0+k-1))     
        	      x4(i,k) =  ww(i,k)  * tv2 (i,ip+0+k-1) &
        		   * (yw(i,k)  * tui (i,ip+0+k-1)   + h1p &
        		   +  zw(i,k)  * tui2(i,ip+0+k-1))
        	      txuf(i,ip+k,ip) =  x1(i,k)	   + x2(i,k) &
        		   -  x3(i,k)		- x4(i,k) &
        		   + (cc(i,ip+1+k-1)	- cc(i,ip+0+k-1)) &
        		   * (hp38		* adel(i,k) &
        		   +  hp61		* bdel(i,k)) &
        		   + (rawi(i,ip+1+k-1)  - rawi(i,ip+0+k-1)) &
        		   *  fw(i,k)		* wdel(i,k)
        	   END DO
             	END DO
             END DO
	  END IF
       
       END IF
    ENDIF

    IF (.not.ozone) THEN
       IF (indx1 == indx2) THEN
             IF (indx2 == 1) THEN
        	DO k = 1, kMax+1
        	   DO i = 1, ncols
        	      x1(i,k) = ABS(ubar(i,k+1))
        	      x2(i,k) = ABS(vbar(i,k+1))
        	      x3(i,k) = ABS(wbar(i,k+1))
        	      adel(i,k) = ABS(tai(i,k+1))
        	      bdel(i,k) = ABS(ch(i,k+1))
        	   END DO
        	END DO
             ELSE
        	DO k = 1, kmax+1
        	   DO i = 1, ncols
        	      x1(i,k)   = ubar(i,kmax+2) - ubar(i,k)
        	      x2(i,k)   = vbar(i,kmax+2) - vbar(i,k)
        	      x3(i,k)   = wbar(i,kmax+2) - wbar(i,k)
        	      adel(i,k) = tai(i,kmax+2)  - tai(i,k)
        	      bdel(i,k) = ch(i,kmax+2)   - ch(i,k)
        	   END DO
        	END DO

        	DO k = 1, kMax+1
        	   DO i = 1, ncols
        	      x1(i,k) = ABS(x1(i,k))
        	      x2(i,k) = ABS(x2(i,k))
        	      x3(i,k) = ABS(x3(i,k))
        	      adel(i,k) = ABS(adel(i,k))
        	      bdel(i,k) = ABS(bdel(i,k))
        	   END DO
        	END DO


             END IF
             DO k=1,(kmax+1)
        	DO i = 1, (ncols)	 
        	   fu(i,k) = h9p8 * x1(i,k)
        	   yw(i,k) = EXP(LOG(x1(i,k) + 1.0e-100)*.83)
        	   ww(i,k) = EXP(LOG(x3(i,k) + 1.0e-100)*.6)
        	   ww(i,k) = h1p + h16p  * ww(i,k)
        	   ww(i,k) = h6p7 * x3(i,k) / ww(i,k)
        	   ww(i,k) = h27p * yw(i,k) + ww(i,k)
        	   yw(i,k) = EXP(LOG(adel(i,k) + 1.0e-100)*.56)
        	   yw(i,k) = h1p  + h15p1     * yw(i,k)
        	   yv(i,k) = h3p1 * adel(i,k) / yw(i,k)
        	   yv(i,k) = yv(i,k)	      + ww(i,k)
        	   yw(i,k) = EXP(LOG(bdel(i,k) + 1.0e-100)*.57)
        	   yw(i,k) = h1p  + hp9       * yw(i,k)
        	   wv(i,k) = hp04 * bdel(i,k) / yw(i,k)
        	   wv(i,k) = wv(i,k) + ww(i,k)
        	END DO
             END DO

             DO k=1,(kmax+1)
        	DO i = 1, (ncols)
        	   fw(i,k) = h1p
        	END DO
             END DO


             DO k = 1, kMax+1
        	DO i = 1, ncols
        	   adel(i,k) = EXP(yv(i,k))
        	   bdel(i,k) = EXP(wv(i,k))
        	   wdel(i,k) = EXP(fu(i,k))
        	END DO
             END DO

             DO k = 1, kMax+1
        	DO i = 1, ncols
        	   yw(i,k) = SQRT(x2(i,k))
        	   zw(i,k) = SQRT(x3(i,k))
        	END DO
             END DO

             DO k=1,(kmax+1)
        	DO i = 1, (ncols)
        	   ww(i,k) = ((h1p	  + 32.2095e0	 * x1(i,k)) &
        		/  (h1p        + 52.85e0      * x1(i,k)) &
        		+  (0.534874e0 + 199.0e0      * x1(i,k) &
        		-  1990.63e0   * x1(i,k)      * x1(i,k)) &
        		*  zw(i,k) &
        		/ (h1p         + 333.244e0    * x1(i,k))) &
        		/ ((h1p        + 74.144e0     * x1(i,k)) &
        		/ (0.43368e0   + 24.7442e0    * x1(i,k)) &
        		* zw(i,k)      + h1p)
        	   wv(i,k) = (h1p	  + 9.22411e0	 * yw(i,k) &
        		+ 33.1236e0    * x2(i,k) &
        		+ 176.396e0    * x2(i,k)      * x2(i,k))
        	   wv(i,k) = h1p	  / wv(i,k)
        	END DO
             END DO

             DO k = 1, kMax+1
        	DO i = 1, ncols
        	   ww(i,k) = MAX(ww(i,k), h0p)
        	   wv(i,k) = MAX(wv(i,k), h0p)
        	   x1(i,k) = MIN(x1(i,k), 0.06e0)
        	   x2(i,k) = MIN(x2(i,k), 2.0e0)
        	   x3(i,k) = MIN(x3(i,k), 8.0e0)
        	   yw(i,k) = SQRT(x2(i,k))
        	   zw(i,k) = SQRT(x3(i,k))
        	END DO
             END DO
             DO k=1,(kmax+1)
        	DO i = 1, (ncols)
        	   fu(i,k) = x1(i,k) * x1(i,k)
        	   yv(i,k) = (0.0851069e0 * yw(i,k)	       &
        		- 0.187096e0   * x2(i,k)  * yw(i,k) &
        		+ 0.323105e0   * x2(i,k)) * 0.1e0
        	   zv(i,k) = 0.239186e0   * x2(i,k)	       &
        		- 0.0922289e0  * x2(i,k)  * yw(i,k) &
        		- 0.0167413e0  * x2(i,k)  * x2(i,k)	   
        	   zv(i,k) = zv(i,k) * 1.0e-3	       
        	   yw(i,k) = (5.6383e-4    + 1.05173e0  * x1(i,k) &
        		- 39.0722e0	* fu(i,k)) &
        		/ (h1p  	+ 202.357e0  * x1(i,k)) &
        		+ (0.0779555e0  + 4.40720e0  * x1(i,k) &
        		+ 3.15851e0	* fu(i,k))   * zw(i,k) &
        		/ (h1p  	+ 40.2298e0  * x1(i,k)) &
        		+ (-0.0381305e0 - 3.63684e0  * x1(i,k) &
        		+ 7.98951e0	* fu(i,k))   * x3(i,k) &
        		/ (h1p  	+ 62.5692e0  * x1(i,k)) &
        		+ (6.21039e-3	+ 0.710061e0 * x1(i,k) &
        		- 2.85241e0	* fu(i,k))   * x3(i,k) &
        		/ (h1p  	+ 70.2912e0  * x1(i,k)) &
        		* zw(i,k)
        	   yw(i,k) = 0.1e0	   * yw(i,k) 
        	   zw(i,k) = (-2.99542e-4 + 0.238219e0 * x1(i,k) &
        		+ 0.519264e0   * fu(i,k)) &
        		/ (h1p         + 10.7775e0  * x1(i,k)) &
        		+ (-2.91325e-2 - 2.30007e0  * x1(i,k) &
        		+ 10.946e0     * fu(i,k))   * zw(i,k) &
        		/ (h1p         + 63.519e0   * x1(i,k)) &
        		+ (1.43812e-2  + 1.80265e0  * x1(i,k) &
        		- 10.1311e0    * fu(i,k))   * x3(i,k) &
        		/ (h1p         + 98.4758e0  * x1(i,k)) &
        		+ (-2.39016e-3 - 3.71427e-1 * x1(i,k) &
        		+ 2.35443e0    * fu(i,k))   * x3(i,k) &
        		/ (h1p         + 120.228e0  * x1(i,k)) &
        		* zw(i,k)
        	   zw(i,k) = 1.0e-3	  * zw(i,k)	     
        	END DO
             END DO
             DO k=1,(kmax+1)
        	DO i = 1, (ncols)
        	   adel(i,k) = hp38 * adel(i,k) + hp61 * bdel(i,k)
        	   fw(i,k)   = fw(i,k) * wdel(i,k)
        	END DO
             END DO

             IF (indx2 == 1) THEN

        	DO k = 2, (kmax+2)
        	   DO i = 1, (ncols)
        	      x1(i,k)   = wv(i,k-1)	* tv1(i,1)
        	      x2(i,k)   = yv(i,k-1)	* tui(i,1) + h1p &
        		   + zv(i,k-1)   * tui2(i,1)
        	      x3(i,k)   = ww(i,k-1)	* tv2(i,1)
        	      x4(i,k)   = yw(i,k-1)	* tui(i,1) + h1p &
        		   + zw(i,k-1)   * tui2(i,1)
        	      fw(i,k-1) = adel(i,k-1) * cc(i,1) &
        		   + fw(i,k-1)   * rawi(i,1)
        	   END DO
        	END DO

        	DO k = 2, (kmax+2)
        	   DO i = 1, (ncols)
        	      shi(i,k) = x1(i,k)*x2(i,k) + x3(i,k)*x4(i,k) + fw(i,k-1)
        	   END DO
        	END DO

             ELSE

        	DO k = 1, (kmax+1)
        	   DO i = 1, (ncols)
        	      x1(i,k) =  wv(i,k) * tv1(i,(kmax+3)) &
        		   * (yv(i,k) * tui(i,(kmax+3))  + h1p &
        		   + zv(i,k)  * tui2(i,(kmax+3)))
        	      x2(i,k) = ww(i,k)  * tv2(i,(kmax+3)) &
        		   * (yw(i,k) * tui(i,(kmax+3))  + h1p &
        		   +  zw(i,k) * tui2(i,(kmax+3)))
        	      x3(i,k) =  wv(i,k) * tv1(i,(kmax+2)) &
        		   * (yv(i,k) * tui(i,(kmax+2))    + h1p &
        		   + zv(i,k)  * tui2(i,(kmax+2)))
        	      x4(i,k) = ww(i,k)  * tv2(i,(kmax+2)) &
        		   * (yw(i,k) * tui(i,(kmax+2))    + h1p &
        		   +  zw(i,k) * tui2(i,(kmax+2)))
        	      shu(i,k) = (cc(i,(kmax+3))-cc(i,(kmax+2)))*adel(i,k) &
        		   + (rawi(i,(kmax+3)) - rawi(i,(kmax+2))) * fw(i,k)
        	   END DO
        	END DO
        	DO k=1,(kmax+1)
        	   DO i = 1, (ncols)
        	      shu(i,k) = x1(i,k) + x2(i,k) - x3(i,k) - x4(i,k) &
        		   + shu(i,k)
        	   END DO
        	END DO

             END IF
       ELSE
          DO ip = indx1, indx2

             IF (indx2 == (kmax+2)) THEN
        	ip1 = ip
        	n   = ip - 1
        	i0  = 0
        	i1  = 1
        	i2  = 2
             ELSE
        	ip1 = (kmax+2) - ip
        	n   = ip1
        	i0  = ip
        	i1  = 0
        	i2  = 0
             END IF

             DO k = indx1, ip1
        	DO i = 1, (ncols)
        	   x1(i,k-i1)   = ubar(i,ip) - ubarm(i,k+i0)
        	   x2(i,k-i1)   = vbar(i,ip) - vbarm(i,k+i0)
        	   x3(i,k-i1)   = wbar(i,ip) - wbarm(i,k+i0)
        	   adel(i,k-i1) = tai(i,ip)  - css(i,k+i0)
        	   bdel(i,k-i1) = ch(i,ip)   - ccu(i,k+i0)
        	END DO
             END DO


             DO k = 1, n
        	DO i  = 1, ncols
        	   x1(i,k) = ABS(x1(i,k))
        	   x2(i,k) = ABS(x2(i,k))
        	   x3(i,k) = ABS(x3(i,k))
        	   adel(i,k) = ABS(adel(i,k))
        	   bdel(i,k) = ABS(bdel(i,k))
        	END DO
             END DO

             DO k= 1, n
        	DO i= 1, ncols
        	   fu(i,k) = h9p8 * x1(i,k)
        	   yw(i,k) = EXP(LOG(x1(i,k) + 1.0e-100)*.83)
        	   ww(i,k) = EXP(LOG(x3(i,k) + 1.0e-100)*.6)
        	   ww(i,k) = h1p + h16p  * ww(i,k)
        	   ww(i,k) = h6p7 * x3(i,k) / ww(i,k)
        	   ww(i,k) = h27p * yw(i,k) + ww(i,k)
        	   yw(i,k) = EXP(LOG(adel(i,k) + 1.0e-100)*.56)
        	   yw(i,k) = h1p  + h15p1     * yw(i,k)
        	   yv(i,k) = h3p1 * adel(i,k) / yw(i,k)
        	   yv(i,k) = yv(i,k)	      + ww(i,k)
        	   yw(i,k) = EXP(LOG(bdel(i,k) + 1.0e-100)*.57)
        	   yw(i,k) = h1p  + hp9       * yw(i,k)
        	   wv(i,k) = hp04 * bdel(i,k) / yw(i,k)
        	   wv(i,k) = wv(i,k) + ww(i,k)
        	END DO
             END DO


             DO k=1, n
             	DO i = 1, ncols
             	   fw(i,k) = h1p
             	END DO
             END DO

             DO k = 1, n
        	DO i = 1, ncols
        	   adel(i,k) = EXP(yv(i,k))
        	   bdel(i,k) = EXP(wv(i,k))
        	   wdel(i,k) = EXP(fu(i,k))
        	END DO
             END DO
             DO k = 1, n
        	DO i = 1, ncols
        	   yw(i,k) = SQRT(x2(i,k))
        	   zw(i,k) = SQRT(x3(i,k))
        	END DO
             END DO

             DO k = 1, n
        	DO i = 1, ncols
        	   ww(i,k) = ((h1p	  + 32.2095e0	 * x1(i,k)) &
        		/  (h1p        + 52.85e0      * x1(i,k)) &
        		+  (0.534874e0 + 199.0e0      * x1(i,k)  &
        		-  1990.63e0   * x1(i,k)      * x1(i,k)) &
        		*  zw(i,k)				 &
        		/ (h1p         + 333.244e0    * x1(i,k)))&
        		/ ((h1p        + 74.144e0     * x1(i,k)) &
        		/ (0.43368e0   + 24.7442e0    * x1(i,k)) &
        		* zw(i,k)      + h1p)
        	   wv(i,k) = (h1p	  + 9.22411e0	 * yw(i,k)  &
        		+ 33.1236e0    * x2(i,k)		 &
        		+ 176.396e0    * x2(i,k)      * x2(i,k))
        	   wv(i,k) = h1p	  / wv(i,k)
        	END DO
             END DO

             DO k = 1, n
        	DO i = 1, ncols
        	   ww(i,k) = MAX(ww(i,k), h0p)
        	   wv(i,k) = MAX(wv(i,k), h0p)
        	   x1(i,k) = MIN(x1(i,k), 0.06e0)
        	   x2(i,k) = MIN(x2(i,k), 2.0e0)
        	   x3(i,k) = MIN(x3(i,k), 8.0e0)
        	   yw(i,k) = SQRT(x2(i,k))
        	   zw(i,k) = SQRT(x3(i,k))
        	END DO
             END DO

             DO k =1, n      
        	DO i = 1, ncols
        	   fu(i,k) = x1(i,k) * x1(i,k)
        	   yv(i,k) = (0.0851069e0  * yw(i,k) &
        		-  0.187096e0	* x2(i,k)  * yw(i,k) &
        		+  0.323105e0	* x2(i,k)) * 0.1e0
        	   zv(i,k) =  0.239186e0   * x2(i,k) &
        		-  0.0922289e0  * x2(i,k)  * yw(i,k) &
        		-  0.0167413e0  * x2(i,k)  * x2(i,k)
        	   zv(i,k) =  zv(i,k) * 1.0e-3

        	   yw(i,k) = (5.6383e-4    + 1.05173e0  * x1(i,k) &
        		- 39.0722e0	* fu(i,k)) &
        		/ (h1p  	+ 202.357e0  * x1(i,k)) &
        		+ (0.0779555e0  + 4.40720e0  * x1(i,k)  &
        		+ 3.15851e0	* fu(i,k))   * zw(i,k)  &
        		/ (h1p  	+ 40.2298e0  * x1(i,k)) &
        		+ (-0.0381305e0 - 3.63684e0  * x1(i,k)  &
        		+ 7.98951e0	* fu(i,k))   * x3(i,k)  &
        		/ (h1p  	+ 62.5692e0  * x1(i,k)) &
        		+ (6.21039e-3	+ 0.710061e0 * x1(i,k)  &
        		- 2.85241e0	* fu(i,k))   * x3(i,k)  &
        		/ (h1p  	+ 70.2912e0  * x1(i,k)) &
        		* zw(i,k)	 
        	   yw(i,k) = 0.1e0	   * yw(i,k)
        	   zw(i,k) = (-2.99542e-4 + 0.238219e0 * x1(i,k) &
        		+ 0.519264e0   * fu(i,k)) &
        		/ (h1p         + 10.7775e0  * x1(i,k)) &
        		+ (-2.91325e-2 - 2.30007e0  * x1(i,k) &
        		+ 10.946e0     * fu(i,k))   * zw(i,k) &
        		/ (h1p         + 63.519e0   * x1(i,k)) &
        		+ (1.43812e-2  + 1.80265e0  * x1(i,k) &
        		- 10.1311e0    * fu(i,k))   * x3(i,k) &
        		/ (h1p         + 98.4758e0  * x1(i,k)) &
        		+ (-2.39016e-3 - 3.71427e-1 * x1(i,k) &
        		+ 2.35443e0    * fu(i,k))   * x3(i,k) &
        		/ (h1p         + 120.228e0  * x1(i,k)) &
        		* zw(i,k)
        	   zw(i,k) = 1.0e-3	  * zw(i,k)
        	END DO
             END DO

             DO k = 1, n
        	DO i = 1, ncols
        	   x1(i,k) =  wv(i,k)  * tv1 (i,i0+k) &
        		* (yv(i,k)  * tui (i,i0+k)    + h1p &
        		+  zv(i,k)  * tui2(i,i0+k)) 
        	   x2(i,k) =  ww(i,k)  * tv2 (i,i0+k) &
        		* (yw(i,k)  * tui (i,i0+k)    + h1p &
        		+  zw(i,k)  * tui2(i,i0+k))
        	   x3(i,k) =  wv(i,k)  * tv1 (i,i0+i2+k-1) &
        		* (yv(i,k)  * tui (i,i0+i2+k-1) + h1p &
        		+  zv(i,k)  * tui2(i,i0+i2+k-1))     
        	   x4(i,k) =  ww(i,k)  * tv2 (i,i0+i2+k-1) &
        		* (yw(i,k)  * tui (i,i0+i2+k-1)   + h1p &
        		+  zw(i,k)  * tui2(i,i0+i2+k-1))
        	   txuf(i,i0+k,ip) =  x1(i,k)		+ x2(i,k) &
        		-  x3(i,k)	     - x4(i,k) &
        		+ (cc(i,i0+1+k-1)    - cc(i,i0+i2+k-1)) &
        		* (hp38 	     * adel(i,k) &
        		+  hp61 	     * bdel(i,k)) &
        		+ (rawi(i,i0+1+k-1)  - rawi(i,i0+i2+k-1)) &
        		*  fw(i,k)	     * wdel(i,k)
        	END DO
             END DO
          END DO
       END IF
    END IF
  END SUBROUTINE crunch




  ! lwflux :computes carbon dioxide and ozone fluxes and upward and downward
  !         fluxes txuf for water vapor; the transmittances are also
  !         calculated.



  SUBROUTINE lwflux(pai   ,tai   ,ozai  ,ubar  ,vbar  ,wbar  ,ubarm ,vbarm , &
       wbarm ,fluxu ,fluxd ,txuf  ,tv1   ,tv2   ,tui   ,x1    , &
       x2    ,cc    ,rawi  ,x3    ,x4    ,ch    ,dp    ,css   , &
       ccu   ,shi   ,shh   ,shu   ,sumsav,h0p   ,h1p   ,h1p5  , &
       hp5   ,dtb   ,dtbinv,pr    ,ntm1  ,ozone ,co2val, &
       ncols ,kmax  )
    !
    !==========================================================================
    !
    !   ncols......Number of grid points on a gaussian latitude circle         
    !   kmax......Number of grid points at vertical      
    !   co2val....co2val is wgne standard value in ppm "co2val = /345.0/   
    !   h0p.......constant h0p = 0.0e0 fac converts to degrees / time step      
    !   h1p.......constant h1p = 1.0e0 fac converts to degrees / time step      
    !   h1p5......Fact converts absorption to rate in degrees/ time step
    !             constant h1p5   = 1.5e0     
    !   hp5.......constant hp5    = 0.5e0      
    !   dtb.......temperature increment in b250.  Constant dtb  = 5.0e0     
    !   dtbinv....constant dtbinv = h1p / dtb      
    !   pr(1).....constant pr(1)  = h1p / 3.0e01
    !   pr(1).....constant pr(2)  = h1p / 3.0e02      
    !   ntm1......number of rows in b250 - 1. constant  ntm1   = 31      
    !   ozone.....set ozone logical variable  ozone = (.NOT. noz)
    !             true if there is ozone  absorption computation       
    !   txuf......1.used as matrix of g-functions for paths from each level
    !               to all other layers.
    !             2.used for transmission in co2 band.
    !             3.used for transmission in ozone band.
    !             4.in cldslw used for probability of clear line-of-sight
    !               from each level to all other layers for max overlap.  
    !   tv1.......Working dimension   
    !   tv2 ......Working dimension  
    !   tui.......Working dimension   
    !   x1........path water vapor(e-type) and working dimension     
    !   x2........path water vapor(band-center) and working dimension    
    !   cc........planck function at level temperature for co2 bands.       
    !   rawi......water vapor amount in layer  
    !   x3........path water vapor (band-wings) and working dimension   
    !   x4........Working dimension  
    !   ch........Probability of clear line-of-sight from level to top of
    !             the atmosphere.       
    !   dp........Pressure difference between levels      
    !   css.......Large scale cloud amount and working dimension   
    !   ccu.......Cumulus cloud amount and working dimension   
    !   shi.......Total transmission function (water vapor + CO2 + ozone)
    !             g-function for a path from level to top of atmosphere.    
    !   shh.......planck function at level temperature for water vapor
    !              bands.     
    !   shu.......Total transmission function (water vapor + CO2 + ozone)
    !             g-function for a path from level  of atmosphere to surface   
    !   sumsav....
    !   pai.......Pressure at middle of layer  
    !   tai.......Temperature at middle of layer  
    !   ozai......ozone amount in layer. 
    !   ubar......scaled water vapor path length in window. 
    !   vbar......scaled water vapor path length in center. 
    !   wbar......scaled water vapor path length in wing. 
    !   ubarm.....ubarm(i,2) = (ubar(i,2) + ubar(i,1)) * hp5
    !   vbarm.... planck function at level temperature for ozone band.
    !   wbarm.... ubarm(i,2) = (ubar(i,2) + ubar(i,1)) * hp5
    !   fluxu.....Ozone path
    !   fluxd.....Ozone path mutiplicated by pressure
    !
    !==========================================================================
    INTEGER, INTENT(in   ) :: ncols 
    INTEGER, INTENT(in   ) :: kmax 
    REAL,    INTENT(in   ) :: co2val  
    REAL,    INTENT(in   ) :: h0p   
    REAL,    INTENT(in   ) :: h1p   
    REAL,    INTENT(in   ) :: h1p5  
    REAL,    INTENT(in   ) :: hp5   
    REAL,    INTENT(in   ) :: dtb   
    REAL,    INTENT(in   ) :: dtbinv  
    REAL,    INTENT(in   ) :: pr(2)  
    INTEGER, INTENT(in   ) :: ntm1  
    LOGICAL, INTENT(in   ) :: ozone  
    REAL,    INTENT(out  ) :: txuf  (ncols,kmax+2,kmax+2)
    REAL,    INTENT(out  ) :: tv1   (ncols,kmax+3)       
    REAL,    INTENT(out  ) :: tv2   (ncols,kmax+3)       
    REAL,    INTENT(inout) :: tui   (ncols,kmax+3) 
    REAL,    INTENT(out  ) :: x1    (ncols,kmax+3) 
    REAL,    INTENT(out  ) :: x2    (ncols,kmax+3) 
    REAL,    INTENT(out  ) :: cc    (ncols,kmax+3) 
    REAL,    INTENT(out  ) :: rawi  (ncols,kmax+3)       
    REAL,    INTENT(out  ) :: x3    (ncols,kmax+2) 
    REAL,    INTENT(out  ) :: x4    (ncols,kmax+2) 
    REAL,    INTENT(out  ) :: ch    (ncols,kmax+2) 
    REAL,    INTENT(in   ) :: dp    (ncols,kmax+2) 
    REAL,    INTENT(out  ) :: css   (ncols,kmax+2)       
    REAL,    INTENT(out  ) :: ccu   (ncols,kmax+2)       
    REAL,    INTENT(out  ) :: shi   (ncols,kmax+2)       
    REAL,    INTENT(out  ) :: shh   (ncols,kmax+2)       
    REAL,    INTENT(out  ) :: shu   (ncols,kmax+1)       
    REAL,    INTENT(out  ) :: sumsav(ncols)        

    REAL,    INTENT(INOUT) :: pai   (ncols,kmax+2)
    REAL,    INTENT(INOUT) :: tai   (ncols,kmax+2)
    REAL,    INTENT(INOUT) :: ozai  (ncols,kmax+2)
    REAL,    INTENT(IN   ) :: ubar  (ncols,kmax+2)
    REAL,    INTENT(IN   ) :: vbar  (ncols,kmax+2)
    REAL,    INTENT(IN   ) :: wbar  (ncols,kmax+2)
    REAL,    INTENT(IN   ) :: ubarm (ncols,kmax+2)
    REAL,    INTENT(IN   ) :: vbarm (ncols,kmax+2)
    REAL,    INTENT(IN   ) :: wbarm (ncols,kmax+2)
    REAL,    INTENT(INOUT) :: fluxu (ncols,kmax+2)
    REAL,    INTENT(INOUT) :: fluxd (ncols,kmax+2)



    REAL                   :: tui2  (ncols,kmax+3)        
    REAL                   :: wdel  (ncols,kmax+1)        
    REAL                   :: fw   (ncols,kmax+1)        
    INTEGER                :: it    (ncols,kmax+3)        


    INTEGER :: idmy(1)
    REAL    :: dmy(1)

    !     
    !     real constants
    !     
    REAL, PARAMETER :: hp25=0.26
    REAL, PARAMETER :: temp1=165.0
    REAL, PARAMETER :: h250p=250.0
    REAL, PARAMETER :: pp=1.0

    INTEGER :: i 
    INTEGER :: j
    INTEGER :: k
    INTEGER :: ix 
    INTEGER :: ip 
    INTEGER :: indx1 
    INTEGER :: indx2

    DO i = 1, ncols
       shi(i,1) = h0p
    END DO

    DO k=1,(kmax+2)
       DO j=1,(kmax+2)
          DO i = 1, ncols
             txuf(i,j,k) = h0p
          END DO
       END DO
    END DO

    DO k=1,kmax+3
       DO i = 1, ncols
          rawi(i,k) = (tui(i,k) - temp1) * dtbinv + h1p5
          it(i,k)   = rawi(i,k)
       END DO
    END DO

    idmy(1)=ntm1

    CALL vimin(idmy,1,it,(ncols*(kmax+3)))

    idmy(1)=1
    CALL vimax(idmy,1,it,(ncols*(kmax+3)))

    DO k=1,(kmax+3)
       DO i = 1, (ncols)
          rawi(i,k) = it  (i,k)  -  h1p
          rawi(i,k) = tui (i,k)  - (temp1 + rawi(i,k) * dtb)
          rawi(i,k) = rawi(i,k)  *  dtbinv
       END DO
    END DO

    CALL r8vgat(b2501,ntm1,it,x1,(ncols*(kmax+3)))
    CALL r8vgat(b2501(2),ntm1,it,x2,(ncols*(kmax+3)))

    DO k=1,(kmax+3)
       DO i = 1, (ncols)
          tv1(i,k) = x1(i,k) + (x2(i,k) - x1(i,k)) * rawi(i,k)
       END DO
    END DO

    CALL r8vgat(b2502(2),ntm1,it,x2,(ncols*(kmax+3)))
    CALL r8vgat(b2502,ntm1,it,x1,(ncols*(kmax+3)))

    DO k=1,(kmax+3)
       DO i = 1, (ncols)
          tv2(i,k) = x1(i,k) + (x2(i,k) - x1(i,k)) * rawi(i,k)
       END DO
    END DO

    DO k=1,(kmax+2)
       DO i = 1, (ncols)
          shh(i,k) = tv1(i,k) + tv2(i,k)
       END DO
    END DO

    DO i = 1, ncols
       sumsav(i) = tv1(i,(kmax+3)) + tv2(i,(kmax+3))
    END DO

    DO k=1,(kmax+3)
       DO i = 1, (ncols)
          tui (i,k)  = tui(i,k) - h250p
          tui2(i,k)  = tui(i,k) * tui(i,k)
       END DO
    END DO
    !     
    !     carbon dioxide and ozone fluxes are calculated here.
    !     
    CALL r8vgat(blkco2(2),ntm1,it,x1,(ncols*(kmax+3)))
    CALL r8vgat(blkco2,ntm1,it,x2,(ncols*(kmax+3)))

    DO k=1,(kmax+3)
       DO i = 1, (ncols)
          cc(i,k) = x2(i,k) + (x1(i,k) - x2(i,k)) * rawi(i,k)
       ENDDO
    END DO

    CALL r8vgat(blkwin,ntm1,it,x2,(ncols*(kmax+3)))
    CALL r8vgat(blkwin(2),ntm1,it,x1,(ncols*(kmax+3)))

    DO k=1,(kmax+3)
       DO i = 1, (ncols)
          rawi(i,k) = x2(i,k) + (x1(i,k) - x2(i,k)) * rawi(i,k)
       END DO
    END DO
    !     
    !     compute transmittances in the 15 micron and 9.6 micron bands.
    !
    DO k=1,(kmax+1)     
       DO i = 1, (ncols)
          x1(i,k) = 2.5e-2 * (tai(i,k+1) - 240.0e0)
       END DO
    END DO

    CALL rvexp(x1,ch(1,2),(ncols*(kmax+1)))

    DO k=1,(kmax+1)
       DO i = 1, (ncols)
          x1(i,k) = 8.9e-3 * (tai(i,k+1) - 240.0e0)
       END DO
    END DO

    CALL rvexp(x1,tai(1,2),(ncols*(kmax+1)))

    DO i = 1, ncols
       tai(i,1) = h0p
       ch(i,1)  = h0p
    END DO

    DO k=1,(kmax+1)
       DO i = 1, (ncols)
          x1(i,k) = pai(i,k)
       END DO
    END DO

    dmy(1)=pp

    CALL vamax(dmy,1,x1,(ncols*(kmax+1)))

    DO k=1,(kmax+1)
       DO i = 1, (ncols)
          fw(i,k) = x1(i,k) * pr(1)
       END DO
    END DO

    DO k=1,(kmax+1)
       DO i = 1, (ncols)
          x2(i,k) = EXP(.85* LOG(fw(i,k)))
       ENDDO
    END DO

    DO k=1,(kmax+1)
       DO i = 1, (ncols)
          tai(i,k+1) = x2(i,k) * tai(i,k+1)
          x1(i,k)  = x1(i,k) * pr(2)
       END DO
    END DO

    CALL rvsqrt(x1,x1,(ncols*(kmax+1)))

    DO k=1,(kmax+1)
       DO i = 1, (ncols)
          ch(i,k+1) = x1(i,k) * ch(i,k+1)
          !     
          !     hp25 = 0.26 for co2 = 330 ppmv
          !     
          tai(i,k+1) = dp(i,k+1) * tai(i,k+1) * hp25 * co2val / 330.0
          ch(i,k+1)  = dp(i,k+1) * ch (i,k+1) * hp25 * co2val / 330.0
       END DO
    END DO

    DO ip = 2, (kmax+2)
       DO i = 1, ncols
          tai(i,ip) = tai(i,ip-1) + tai(i,ip)
          ch(i,ip)  = ch(i,ip-1)  + ch(i,ip)
       END DO
    END DO

    DO k=1,(kmax+1)
       DO i = 1, (ncols)
          css(i,k+1) = (tai(i,k+1)  + tai(i,k))  * hp5
          ccu(i,k+1) = ( ch(i,k+1)  +  ch(i,k))  * hp5
       END DO
    END DO

    IF ( ozone ) THEN

       DO i = 1, ncols
          fluxd(i,1) = h0p
       END DO

       DO k=1,(kmax+2)
          DO i = 1, (ncols)
             fluxu(i,k) = h0p
          END DO
       END DO

       DO k=1,(kmax+1)
          DO i = 1, (ncols)
             fluxd(i,k+1) = pai(i,k) * ozai(i,k+1)
          END DO
       END DO

       DO ix = 2, (kmax+2)
          DO i = 1, ncols
             fluxd(i,ix) = fluxd(i,ix-1) + fluxd(i,ix)
             fluxu(i,ix) = fluxu(i,ix-1) + ozai(i,ix)
          END DO
       END DO

       DO k = 1, (kmax+1)
          DO i = 1, (ncols)
             pai (i,k+1)  = (fluxd(i,k) + fluxd(i,k+1)) * hp5
             ozai(i,k+1)  = (fluxu(i,k) + fluxu(i,k+1)) * hp5
          ENDDO
       END DO

       CALL rvabs(fluxu(1,2),wdel,(ncols*(kmax+1)))
       CALL rvabs(fluxd(1,2),fw,(ncols*(kmax+1)))
    END IF
    indx1 = 1
    indx2 = 1
    CALL crunch(indx1 ,indx2 ,ncols  ,kmax  ,h0p   ,h1p   ,ozone ,txuf  , &
         tv1   ,tv2   ,tui   ,tui2  ,x1    ,x2    ,cc    ,rawi  , &
         x3    ,x4    ,ch    ,css   ,ccu   ,shi   ,shu   ,wdel  , &
         fw    ,pai   ,tai   ,ozai  ,ubar  ,vbar  ,wbar  ,ubarm , &
         vbarm ,wbarm ,fluxu ,fluxd )
    indx1 = 2
    indx2 = 2
    CALL crunch(indx1 ,indx2 ,ncols ,kmax  ,h0p   ,h1p   ,ozone ,txuf  , &
         tv1   ,tv2   ,tui   ,tui2  ,x1    ,x2    ,cc    ,rawi  , &
         x3    ,x4    ,ch    ,css   ,ccu   ,shi   ,shu   ,wdel  , &
         fw    ,pai   ,tai   ,ozai  ,ubar  ,vbar  ,wbar  ,ubarm , &
         vbarm ,wbarm ,fluxu ,fluxd )

    !     
    !     downward flux txuf for water vapor
    !     

    indx1 = 2
    indx2 = (kmax+2)
    CALL crunch(indx1 ,indx2 ,ncols ,kmax  ,h0p   ,h1p   ,ozone ,txuf  , &
         tv1   ,tv2   ,tui   ,tui2  ,x1    ,x2    ,cc    ,rawi  , &
         x3    ,x4    ,ch    ,css   ,ccu   ,shi   ,shu   ,wdel  , &
         fw    ,pai   ,tai   ,ozai  ,ubar  ,vbar  ,wbar  ,ubarm , &
         vbarm ,wbarm ,fluxu ,fluxd )
    !     
    !     upward flux txuf for water vapor
    !     
    indx1 = 1
    indx2 = (kmax+1)

    CALL crunch(indx1 ,indx2 ,ncols  ,kmax  ,h0p   ,h1p   ,ozone ,txuf  , &
         tv1   ,tv2   ,tui   ,tui2  ,x1    ,x2    ,cc    ,rawi  , &
         x3    ,x4    ,ch    ,css   ,ccu   ,shi   ,shu   ,wdel  , &
         fw    ,pai   ,tai   ,ozai  ,ubar  ,vbar  ,wbar  ,ubarm , &
         vbarm ,wbarm ,fluxu ,fluxd )

    DO k = 1,(kmax+2)
       DO i = 1, (ncols)
          shh(i,k) = shh(i,k) + rawi(i,k) + cc(i,k)
       END DO
    END DO

    DO i = 1, ncols
       sumsav(i) = sumsav(i) + rawi(i,(kmax+3)) + cc(i,(kmax+3))
    END DO
  END SUBROUTINE lwflux



  !cldslw:  Estimate a contribution from cloudiness
  !    Using cloud amount of large scale (css) and and  cumulus(ccu) clouds



  SUBROUTINE cldslw(ncols ,kmax  ,nlcs  ,h1p   ,cs    ,x1    , &
       x2    ,cc    ,x3    ,x4    ,ch    ,css   ,ccu)
    !
    !==========================================================================
    !  imax.......Number of grid points on a gaussian latitude circle    
    !  kmax.......Number of grid points at vertical    
    !  nlcs.......nlcs=30  
    !  h1p........h1p    = 1.0e0      fac converts to degrees / time step  
    !  cs.........probability of clear line-of-sight from each level to
    !             all other layers.  
    !  x1.........Water vapor path (e-type ) and working dimension
    !  x2.........Water vapor path (band-center) and working dimension  
    !  cc.........planck function at level temperature for co2 bands.  
    !  x3.........water vapor path (band-wings), working dimension  
    !  x4.........Working dimension  
    !  ch.........probability of clear line-of-sight from level to top of
    !             the atmosphere.  
    !  css........Large scale cloud amount  
    !             css=css*(1-exp(-0.01*dp)) for ice cloud t < 253.0
    !  ccu........Cumulus cloud amount 
    !=========================================================================!
    ! >>> icld=1     : old cloud emisivity setting                           !
    !       ccu = ccu*(1-exp(-0.05*dp))                                      !
    !       css = css*(1-exp(-0.01*dp))          for ice cloud t<253.0       !
    !       css = css*(1-exp(-0.05*dp))          for     cloud t>253.0       !
    ! >>> icld=2     : new cloud emisivity setting                           !
    !       ccu = 1.0-exp(-0.12*ccu*dp)                                      !
    !       css = 0.0                                    for  t<-82.5c        !
    !       css = 1-exp(-1.5e-6*(t-tcrit)**2*css*dp)     for -82.5<t<-10.0    !
    !       css = 1-exp(-5.2e-3*(t-273.)-0.06)*css*dp)   for -10.0<t< 0.0     !
    !       css = 1-exp(-0.06*css*dp)                    for t> 0.0c          !
    ! >>> icld = 3   : ccm3 based cloud emisivity                             !
    !=========================================================================!
    !==========================================================================

    INTEGER, INTENT(in   ) :: ncols
    INTEGER, INTENT(in   ) :: kmax                  
    INTEGER, INTENT(in   ) :: nlcs                  
    REAL,    INTENT(in   ) :: h1p                   
    REAL,    INTENT(out  ) :: cs  (ncols,kmax+2,nlcs)
    REAL,    INTENT(out  ) :: x1  (ncols,kmax+3)    
    REAL,    INTENT(out  ) :: x2  (ncols,kmax+3)    
    REAL,    INTENT(out  ) :: cc  (ncols,kmax+3)    
    REAL,    INTENT(out  ) :: x3  (ncols,kmax+2)    
    REAL,    INTENT(out  ) :: x4  (ncols,kmax+2)    
    REAL,    INTENT(out  ) :: ch  (ncols,kmax+2)    
    REAL,    INTENT(in   ) :: css (ncols,kmax+2)    
    REAL,    INTENT(in   ) :: ccu (ncols,kmax+2)    

    INTEGER :: i
    INTEGER :: k 
    INTEGER :: j
    INTEGER :: ip 
    INTEGER :: il 
    INTEGER :: ix 
    INTEGER :: ipm1 
    INTEGER :: ipp1 

    DO k=1,(kmax+2)
       DO i=1,(ncols)
          ch(i,k) = h1p
          cc(i,k) = h1p
          x1(i,k) = h1p
          x2(i,k) = h1p
          x3(i,k) = h1p
       END DO
    END DO

    DO k=1,(kmax+2)
       DO j=1,(kmax+2)
          DO i=1,(ncols)
             cs(i,j,k) = h1p
          END DO
       END DO
    END DO

    DO ip=2,(kmax+2)
       DO i=1,ncols
          x1(i,ip) = h1p - ccu(i,ip-1)
       END DO

       CALL vamin(x1(1,ip-1),ncols,x1(1,ip),ncols)

       DO i=1,ncols
          ch(i,ip) = ch(i,ip-1) * (h1p - css(i,ip-1))
       END DO
    END DO

    DO k=1,(kmax+1)
       DO i=1,(ncols)
          ch(i,k+1) = ch(i,k+1) * x1(i,k+1)
       END DO
    END DO

    DO il=1,(kmax+1)
       ip=(kmax+2)-il
       DO i=1,ncols
          x2(i,ip) = h1p - ccu(i,ip)
       END DO

       CALL vamin(x2(1,ip+1),ncols,x2(1,ip),ncols)

       DO i=1,ncols
          cc(i,ip) = cc(i,ip+1) * (h1p - css(i,ip))
       END DO
    END DO

    DO k=1,(kmax+1)
       DO i=1,(ncols)
          cc(i,k) = cc(i,k) * x2(i,k)
       END DO
    END DO

    DO ip=2,(kmax+2)
       ipm1   = ip - 1

       DO ix=1,ipm1
          DO i=1,ncols
             x4(i,ix)    = h1p - ccu(i,ip-1)
             cs(i,ix,ip) = cs(i,ix,ip-1) * (h1p - css(i,ip-1))
          END DO
       END DO

       IF (ip .GT. 2) THEN
          DO j=1,ipm1
             DO i=1,ncols
                cs(i,j,ip-1) = cs(i,j,ip-1) * x3(i,j)
             END DO
          END DO
       END IF

       CALL vamin(x3,(ncols*ipm1),x4,(ncols*ipm1))

       DO k=1,ipm1
          DO i=1,ncols
             x3(i,k) = x4(i,k)
          END DO
       END DO

    END DO

    DO j=1,ipm1
       DO i=1,ncols
          cs(i,j,(kmax+2)) = cs(i,j,(kmax+2)) * x4(i,j)
       END DO
    END DO

    DO k=1,kmax+2
       DO i=1,ncols
          x3(i,k) = h1p
       END DO
    END DO

    DO il=1,(kmax+1)
       ip   = (kmax+2) - il
       ipp1 = ip + 1

       DO ix=ipp1,(kmax+2)
          DO i=1,ncols
             x4(i,ix)    = h1p - ccu(i,ip)
             cs(i,ix,ip) = cs(i,ix,ip+1) * (h1p - css(i,ip))
          END DO
       END DO

       IF (il .GT. 1) THEN
          DO k=ip,((kmax+1)-ip)! DO k=ip,((kmax+2)-ip)
             DO  i=1, ncols
                cs(i,k+2,ip+1) = cs(i,k+2,ip+1) * x3(i,k+2)
             END DO
          END DO
       END IF

       CALL vamin(x3(1,ipp1),(ncols*((kmax+2)-ip)),x4(1,ipp1),(ncols*((kmax+2)-ip)))

       DO k=ipp1,((kmax+2)-ip)
          DO i=1,ncols
             x3(i,k) = x4(i,k)
          END DO
       END DO

    END DO

    DO k=ipp1,((kmax+2)-ip)
       DO i=1, ncols
          cs(i,k,ip) = cs(i,k,ip) * x4(i,k)
       END DO
    END DO

  END SUBROUTINE cldslw




  ! lwrad  :compute upward and downward fluxes.



  SUBROUTINE lwrad(dtc3  ,noz   ,icld  ,tg    ,pl20  ,pl    ,tl    ,ql    , &
       o3l   ,cld   ,clu   ,ulwclr,ulwtop,atlclr,atl   ,rsclr , &
       rs    ,dlwclr,dlwbot,clwp  ,fice  ,rei   ,emisd ,co2val, &
       ncols ,kmax  ,nls   ,nlcs                                 )           
    ! input variables
    !
    !     dtc3,  noz,  pl,  pl20, tl,  tg,  ql,  o3l,  cld,  clu
    !
    !     output variables
    !
    !     atl, atlclr,  rs,  rsclr, ulwtop, ulwclr, dlwbot, dlwclr
    !
    !     parameter list variables
    !
    !     nim......number of grid points around a latitude circle.
    !     nlm......number of model layers.
    !     nlmp1....nlm plus one.
    !     nlmp2....nlm plus two.
    !     nlmp3....nlm plus three.
    !     nls......number of layers in the stratosphere.
    !
    ! local variables
    !
    !     b250.....planck function table for water vapor bands; center and
    !              wing.
    !     ntm1.....number of rows in b250 - 1.
    !     temp1....lowest temperature for which b250 is tabulated.
    !     dtb......temperature increment in b250.
    !     nup1.....number of columns in gl and coeff.
    !     ubar.....scaled water vapor path length in window.
    !     vbar.....scaled water vapor path length in center.
    !     wbar.....scaled water vapor path length in wing.
    !     rawi.....water vapor amount in layer.
    !     ozai.....ozone amount in layer.
    !     shh......planck function at level temperature for water vapor
    !              bands.
    !     shi......g-function for a path from level to top of atmosphere.
    !     txuf.....1.used as matrix of g-functions for paths from each level
    !                to all other layers.
    !              2.used for transmission in co2 band.
    !              3.used for transmission in ozone band.
    !              4.in cldslw used for probability of clear line-of-sight
    !                from each level to all other layers for max overlap.
    !     wv,ww....interpolated value of gl for band center and wing
    !              respectively.
    !     yv,yw....linear term in temperature correction for band center
    !              and wing respectively.
    !     zv,zw....quadratic term in temperature correction for band center
    !              and wing respectively.
    !     blkco2...planck function table for co2 bands.
    !     blkwin...planck function table for ozone band.
    !     cc.......planck function at level temperature for co2 bands.
    !     vbarm....planck function at level temperature for ozone band.
    !     pp.......doppler broadening cut-off.
    !     pscalv...scaled co2 amount in band center.
    !     pscalw...scaled co2 amount in band wing.
    !     dx.......parameterized optical depth of water vapor line in co2
    !              band wing.
    !     dy.......parameterized optical depth of water vapor continuum in
    !              co2 band wing, also used for ozone band wing.
    !     sv,sw....minimum in table of log water vapor amount in band center
    !              and wing respectively.
    !     cs.......probability of clear line-of-sight from each level to
    !              all other layers.
    !     ch.......probability of clear line-of-sight from level to top of
    !              the atmosphere.
    !     cc.......probability of clear line-of-sight from level to surface.
    !     ct.......probability of clear line-of-sight from level to top of
    !              atmosphere for maximun overlap.
    !     cu.......probability of clear line-of-sight from level to surface
    !              for maximum overlap.
    !
    !cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
    ! >>> icld=1     : old cloud emisivity setting                      c
    !       ccu = ccu*(1-exp(-0.05*dp))                                 c
    !       css = css*(1-exp(-0.01*dp))          for ice cloud t<253.0  c
    !       css = css*(1-exp(-0.05*dp))          for     cloud t>253.0  c
    ! >>> icld=2     : new cloud emisivity setting                      c
    !       ccu = 1.0-exp(-0.12*ccu*dp)                                 c
    !       css = 0.0                                for  t<-82.5c      c
    !       css = 1-exp(-1.5e-6*(t-tcrit)**2*css*dp) for -82.5<t<-10.0c c
    !       css = 1-exp(-5.2e-3*(t-273.)-0.06)*css*dp)for -10.0<t< 0.0c c
    !       css = 1-exp(-0.06*css*dp)                 for t> 0.0c       c
    ! >>> icld = 3   : ccm3 based cloud emisivity                       c
    !cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
    !
    ! ncols......Number of grid points on a gaussian latitude circle    
    ! kmax......Number of grid points at vertical  
    ! nls.......number of layers in the stratosphere. 
    ! nlcs......nlcs=30  
    ! dtc3......constants dtc3=1.0e0
    ! noz.......constant logical noz = .FALSE.
    ! tg........Surface Temperature (K)  
    ! pl20......pl20(i,k)=gps(i)*sigml(kflip) where
    !                         gps   =  surface pressure   (mb) 
    !                         sigml =  sigma coordinate at bottom of layer
    ! pl........Pressure at Middle of Layer(mb) 
    ! tl........Temperature at middle of Layer (K) 
    ! ql........Specific Humidity at middle of layer (g/g) 
    ! o3l.......Ozone Mixing ratio at middle of layer (g/g)   
    ! cld.......Large scale cloud amount in layers   
    ! clu.......Cumulus cloud amount in layers   
    ! ulwclr....Upward flux at top in clear case (W/m2)
    ! ulwtop....Upward flux at top (W/m2)
    ! atlclr....Heating rate in clear case (K/s)
    ! atl.......Heating rate (K/s)   
    ! rsclr.....Net surface flux in clear case (W/m2 ) 
    ! rs........Net surface flux 
    ! dlwclr....Downward flux at surface in clear case (W/m2 ) 
    ! dlwbot....Downward flux at surface (W/m2 ) 
    ! clwp  
    ! fice......controle of change of fase of water   
    ! rei.......determine rei as function of normalized pressure   
    ! emisd.....emis(i,kflip) = 1.- EXP(-1.66*rkabs(i,k)*clwp(i,k)) 
    ! co2val....co2val is wgne standard value in ppm "co2val = /345.0/     
    !
    INTEGER, INTENT(in   ) :: ncols 
    INTEGER, INTENT(in   ) :: kmax 
    INTEGER, INTENT(in   ) :: nls  
    INTEGER, INTENT(in   ) :: nlcs 

    !
    !     needed for the ncar optical properties
    !
    REAL,    INTENT(in   ) :: dtc3
    LOGICAL, INTENT(in   ) :: noz
    INTEGER, INTENT(in   ) :: icld
    REAL,    INTENT(in   ) :: tg    (ncols)
    REAL,    INTENT(in   ) :: pl20  (ncols,kmax)
    REAL,    INTENT(in   ) :: pl    (ncols,kmax)
    REAL,    INTENT(in   ) :: tl    (ncols,kmax)
    REAL,    INTENT(in   ) :: ql    (ncols,kmax)
    REAL,    INTENT(in   ) :: o3l   (ncols,kmax)
    REAL,    INTENT(in   ) :: cld   (ncols,kmax)
    REAL,    INTENT(in   ) :: clu   (ncols,kmax)
    REAL,    INTENT(out  ) :: ulwclr(ncols)
    REAL,    INTENT(out  ) :: ulwtop(ncols)
    REAL,    INTENT(out  ) :: atlclr(ncols,kmax)
    REAL,    INTENT(out  ) :: atl   (ncols,kmax)
    REAL,    INTENT(out  ) :: rsclr (ncols)
    REAL,    INTENT(out  ) :: rs    (ncols)
    REAL,    INTENT(out  ) :: dlwclr(ncols)
    REAL,    INTENT(out  ) :: dlwbot(ncols)
    REAL,    INTENT(in   ) :: clwp  (ncols,kmax)
    REAL,    INTENT(in   ) :: fice  (ncols,kmax)
    REAL,    INTENT(in   ) :: rei   (ncols,kmax)
    REAL,    INTENT(out  ) :: emisd (ncols,kmax)
    REAL,    INTENT(in   ) :: co2val       


    REAL    :: txuf  (ncols,kmax+2,kmax+2) 
    REAL    :: cs    (ncols,kmax+2,nlcs)   
    REAL    :: tv1   (ncols,kmax+3)        
    REAL    :: tv2   (ncols,kmax+3)        
    REAL    :: tui   (ncols,kmax+3)        
    REAL    :: x1    (ncols,kmax+3)        
    REAL    :: x2    (ncols,kmax+3)        
    REAL    :: cc    (ncols,kmax+3)        
    REAL    :: rawi  (ncols,kmax+3)        
    REAL    :: x3    (ncols,kmax+2)        
    REAL    :: x4    (ncols,kmax+2)        
    REAL    :: ch    (ncols,kmax+2)        
    REAL    :: dp    (ncols,kmax+2)        
    REAL    :: css   (ncols,kmax+2)        
    REAL    :: ccu   (ncols,kmax+2)        
    REAL    :: shi   (ncols,kmax+2)        
    REAL    :: shh   (ncols,kmax+2)        
    REAL    :: shu   (ncols,kmax+1)        
    REAL    :: suma  (ncols)           
    REAL    :: sumsav(ncols)           
    LOGICAL :: bitx  (ncols*(kmax+3))      


    REAL :: pai   (ncols,kmax+2) 
    REAL :: tai   (ncols,kmax+2) 
    REAL :: ozai  (ncols,kmax+2) 
    REAL :: ubar  (ncols,kmax+2) 
    REAL :: vbar  (ncols,kmax+2) 
    REAL :: wbar  (ncols,kmax+2) 
    REAL :: ubarm (ncols,kmax+2) 
    REAL :: vbarm (ncols,kmax+2) 
    REAL :: wbarm (ncols,kmax+2) 
    REAL :: fluxu (ncols,kmax+2) 
    REAL :: fluxd (ncols,kmax+2) 


    REAL      :: h0p    
    REAL      :: h1p    
    REAL      :: h1p5    
    REAL      :: hp5    
    REAL      :: dtb    
    REAL      :: dtbinv             
    REAL      :: pr(2)    
    INTEGER   :: ntm1    
    INTEGER   :: imnpnp             
    LOGICAL   :: ozone    

    REAL      :: emis (ncols,kmax)          
    REAL      :: emis1(ncols,kmax+2) 
    REAL      :: rkabs(ncols,kmax)  

    REAL      :: h1p02
    REAL      :: h6p08
    REAL      :: tice

    INTEGER  :: ls1 
    INTEGER  :: ls2 
    INTEGER  :: imls1 
    INTEGER  :: imlsm1 
    INTEGER  :: imlm1 
    INTEGER  :: imt2
    INTEGER  :: npmls1 
    INTEGER  :: npmls2 
    INTEGER  :: i 
    INTEGER  :: ip 
    INTEGER  :: ipm1 
    INTEGER  :: ix 
    INTEGER  :: ipp1 
    INTEGER  :: l 
    INTEGER  :: k 
    INTEGER  :: kflip
    REAL     :: fac 
    REAL     :: h3ppm 
    REAL     :: tcrit 
    REAL     :: ecrit 
    REAL     :: d642
    REAL     :: pre   (2)                 
    REAL     :: dmy   (1)

    h1p02 =   1.02e0
    h6p08 =   6.0811e0
    tice  = 273.16
    !     
    !     copy parameters into local variables
    !     
    ls1    = nls+1
    ls2    = nls+2
    imls1  = ncols*ls1
    imlsm1 = ncols*(nls-1)
    imnpnp = (ncols*(kmax+2))*(kmax+2)
    imlm1  = ncols*(kmax-1)
    imt2   = ncols*2
    npmls1 = ncols* ((kmax+2) - ls1)
    npmls2 = ncols* ((kmax+2) - ls2)
    !     
    !     fac converts to degrees / time step
    !     
    fac    = 9.8e-1 * dtc3 / 1.0030e04
    h1p    = 1.0e0
    h0p    = 0.0e0
    h1p5   = 1.5e0
    hp5    = 0.5e0
    h3ppm  = 3.0e-6
    tcrit  = tice - 82.5
    ecrit  = 0.007884375
    ntm1   = 31
    dtb    = 5.0e0
    dtbinv = h1p / dtb
    pre(1) = h1p / 2.75e02
    pre(2) = h1p / 5.5e02
    d642   = h1p / 6.426e02
    pr(1)  = h1p / 3.0e01
    pr(2)  = h1p / 3.0e02    
    emis1  = 0.0e0
    !     
    !     set ozone logical variable
    !     
    ozone = (.NOT. noz)
    !     
    !     ptop and dp at top don't change
    !     
    DO i = 1, ncols
       dp (i,1)     = h0p
       x1 (i,1)     = h1p
       dp (i,2)     = h1p
       pai(i,1)     = hp5
    END DO

    DO k=1,((kmax+2) - (nls+1))
       DO i = 1, ncols 
          rawi(i,nls+1+k) = ql(i,nls+k-1)
       END DO
    END DO

    IF (nls > 1) THEN
       DO k = 1,(nls-1)
          DO i = 1, ncols
             rawi(i,2+k) = h3ppm
          END DO
       END DO
    END IF

    DO k=1,kmax
       DO i = 1, ncols
          pai(i,k+1) = pl(i,k)
          tai(i,k+2) = tl(i,k)
          x1 (i,k+1) = pl20(i,k)
       END DO
    END DO

    DO i = 1, ncols
       pai(i,(kmax+2)) = pl20(i,kmax)
    END DO

    IF ( ozone ) THEN
       DO k = 1,kmax
          DO i = 1, (ncols)
             ozai(i,k+2) = o3l(i,k)
          END DO
       END DO
    END IF

    DO k = 1,kmax
       DO i = 1, ncols
          dp(i,k+2) = x1(i,k+1) - x1(i,k)
       END DO
    END DO
    !     
    !     temperature and humidity interpolations
    !     
    dmy(1)=0.1e-22
    CALL vamax(dmy,1,rawi(1,3),(ncols*kmax))

    IF ( ozone ) THEN

       dmy(1)=0.1e-9

       CALL vamax(dmy,1,ozai(1,3),(ncols*kmax))

       DO i = 1, ncols
          ozai(i,1) = h0p
          ozai(i,2) = ozai(i,3) * dp(i,2) * h1p02
       END DO

       DO k = 1,kmax
          DO  i = 1, ncols
             ozai(i,k+2) = ozai(i,k+2) * dp(i,k+2)  * h1p02
          END DO
       END DO

    END IF
    !     
    !     do temperature interpolation
    !     
    DO i = 1, ncols
       rawi(i,1) = h0p
       rawi(i,2) = h3ppm * dp(i,2) * h1p02
    END DO

    DO k=1,kmax
       DO i = 1, ncols
          rawi(i,k+2) = rawi(i,k+2) * dp(i,k+2) * h1p02
          x1(i,k)   = x1(i,k+1) / pai(i,k+1)
       END DO
    END DO

    CALL rvlog(x1,x2,(ncols*kmax))

    DO k = 1,kmax
       DO i = 1, ncols
          x1(i,k)   = pai(i,k+2) / pai(i,k+1)
       END DO
    END DO

    CALL rvlog(x1,x4,(ncols*kmax))

    DO k=1,(kmax-1)
       DO i = 1, ncols
          tui(i,k+2) = tai(i,k+2)  + x2(i,k) / x4(i,k) &
               * (tai(i,k+3) - tai(i,k+2))
       END DO
    END DO
    !
    !     set surface air temperature as mean of lowest layer t and tg
    !
    DO i = 1, ncols
       tui(i,(kmax+2)) = hp5 * ( tai(i,(kmax+2)) + tg(i) )
       tui(i,(kmax+3)) = tg(i)
       tai(i,1)        = tai(i,3)
       tai(i,2)        = tai(i,3)
    END DO

    DO k=1,2
       DO i = 1, ncols
          tui(i,k)     = tai(i,k)
       END DO
    END DO

    !     
    !     compute scaled water vapor amounts
    !     

    DO i = 1, ncols
       ubar(i,1) = h0p
       vbar(i,1) = h0p
       wbar(i,1) = h0p
    END DO

    DO k=1,(kmax+1)
       DO i = 1, (ncols)
          x3(i,k) = 0.5e-2 * (tai(i,k+1) - 225.0e0)
       END DO
    END DO

    CALL rvexp(x3,x2,(ncols*(kmax+1)))

    DO k=1,(kmax+1)
       DO i = 1, (ncols)
          vbar(i,k+1) = rawi(i,k+1) * x2(i,k) &
               * (pai(i,k) * pre(1))
          x3(i,k)     = 1.6e-2 * (tai(i,k+1) - 256.0e0)
       END DO
    END DO

    CALL rvexp(x3,x2,(ncols*(kmax+1)))

    DO k = 1,(kmax+1)
       DO i = 1, (ncols)
          wbar(i,k+1) = rawi(i,k+1) * x2(i,k) &
               * (pai(i,k) * pre(2))
          x1(i,k)     = 1.8e03    / tai(i,k+1) - h6p08
       END DO
    END DO

    CALL rvexp(x1,x2,(ncols*(kmax+1)))

    DO k = 1, (kmax+1)
       DO i = 1, (ncols)
          x2(i,k) = x2(i,k) * pai(i,k)  * d642
          x2(i,k) = x2(i,k) * rawi(i,k+1) &
               * rawi(i,k+1) / dp(i,k+1)
       END DO
    END DO

    DO ip = 2, (kmax+2)
       DO i = 1, ncols
          ubar(i,ip) = ubar(i,ip-1) + x2(i,ip-1)
          vbar(i,ip) = vbar(i,ip-1) + vbar(i,ip)
          wbar(i,ip) = wbar(i,ip-1) + wbar(i,ip)
       END DO
    END DO

    DO k=1,(kmax+1)
       DO i = 1, (ncols)
          ubarm(i,k+1) = (ubar(i,k+1) + ubar(i,k)) * hp5
          vbarm(i,k+1) = (vbar(i,k+1) + vbar(i,k)) * hp5
          wbarm(i,k+1) = (wbar(i,k+1) + wbar(i,k)) * hp5
       END DO
    END DO

    CALL lwflux(pai   ,tai   ,ozai  ,ubar  ,vbar  ,wbar  ,ubarm ,vbarm , &
         wbarm ,fluxu ,fluxd ,txuf  ,tv1   ,tv2   ,tui   ,x1    , &
         x2    ,cc    ,rawi  ,x3    ,x4    ,ch    ,dp    ,css   , &
         ccu   ,shi   ,shh   ,shu   ,sumsav,h0p   ,h1p   ,h1p5  , &
         hp5   ,dtb   ,dtbinv,pr    ,ntm1  ,ozone ,co2val, &
         ncols ,kmax  )
    !     
    !     compute clear sky fluxes only for cloud radiative forcing
    !     zero out downward flux accumulators at l=1
    !
    DO i = 1, ncols
       fluxd(i,1) = h0p
       !     
       !     upward flux at the surface
       !     
       fluxu(i,(kmax+2)) = sumsav(i)
    END DO
    !     
    !     compute downward fluxes
    !     
    DO ip = 2, (kmax+2)
       DO i = 1, ncols
          suma(i) = h0p
       END DO
       ipm1 = ip - 1
       DO ix = 1, ipm1
          DO i = 1, ncols
             suma(i) = suma(i) + txuf(i,ix,ip)
          END DO
       END DO
       DO i = 1, ncols
          fluxd(i,ip) = suma(i) - shi(i,ip) + shh(i,ip)
       END DO
    END DO
    !     
    !     compute upward fluxes
    !     
    DO ip = 1, (kmax+1)
       ipp1      = ip + 1
       DO i = 1, ncols
          suma(i) = h0p
       END DO
       DO ix = ipp1, (kmax+2)
          DO i = 1, ncols
             suma(i) = suma(i) + txuf(i,ix,ip)
          END DO
       END DO
       DO i = 1, ncols
          fluxu(i,ip) = suma(i)  + shu(i,ip) + shh(i,ip)
       END DO
    END DO

    DO k=1,(kmax+2)
       DO  i = 1, (ncols)
          x1(i,k) = fluxd(i,k) - fluxu(i,k)
       END DO
    END DO

    DO i = 1, ncols
       ulwclr(i)  = -x1(i,2)
       rsclr (i)  = -x1(i,(kmax+2))
       dlwclr(i)  = fluxd(i,(kmax+2))
    END DO

    DO k = 1,kmax
       DO i = 1, (ncols)
          atlclr(i,k) = (x1(i,k+1) - x1(i,k+2)) * fac / dp(i,k+2)
       END DO
    END DO

    !     
    !     we don't allow clouds between gcm levels in the stratosphere
    !     

    DO k=1,kmax
       DO i = 1, (ncols)
          css(i,k+1)   = cld(i,k)
          ccu(i,k+1)   = clu(i,k)
       END DO
    END DO

    DO k=1,(nls+1)
       DO i = 1, ncols 
          css(i,k) = h0p
          ccu(i,k) = h0p
       END DO
    END DO
    !     
    !     icld = 1     : old cloud emissivity setting
    !     icld = 2     : new cloud emissivity setting
    !     
    IF (icld == 1) THEN

       DO k=1,((kmax+2) - (nls+2))
          DO i = 1, ncols
             tv1(i,nls+k+1) = -.05e0 *  dp(i,nls+k+2)
          END DO
       END DO

       CALL rvexp(tv1(1,ls2),tv2(1,ls2),npmls2)

       DO k=1,((kmax+2) - (nls+2))
          DO i = 1,ncols
             ccu(i,nls+k+1) = ccu(i,nls+k+1) * ( h1p - tv2(i,nls+k+1) )
          END DO
       END DO

       DO l = ls2, (kmax+1)
          DO i = 1, ncols
             !     
             !     bash down cloud emissivities
             !     
             IF (tl(i,l-1) < 253.0) THEN
                tv1(i,l) = -0.01e0 * dp(i,l+1)
             END IF
          END DO
       END DO

       CALL rvexp(tv1(1,ls2),tv2(1,ls2),npmls2)

       DO k=1,((kmax+2) - (nls+2))
          DO i = 1,  ncols
             css(i,nls+k+1) = css(i,nls+k+1) * ( h1p - tv2(i,nls+k+1) )
          END DO
       END DO

    ELSE IF (icld == 2) THEN

       DO k=1,((kmax+2) - (nls+2))
          DO i = 1,  ncols
             tv1(i,nls+k+1) = -.12e0 * ccu(i,nls+k+1) * dp(i,nls+k+2)
          END DO
       END DO

       CALL rvexp(tv1(1,ls2),tv2(1,ls2),npmls2)

       DO k=1,((kmax+2) - (nls+2))
          DO i = 1,  ncols
             ccu(i,nls+k+1) =  h1p - tv2(i,nls+k+1)
          END DO
       END DO

       DO l = ls2, (kmax+1)
          DO i = 1, ncols
             tv2(i,l) =  tl(i,l-1) - tcrit
          END DO
       END DO

       dmy(1)=h0p

       CALL vamax(dmy,1,tv2(1,ls2),npmls2)

       DO k=1,((kmax+2) - (nls+2))
          DO i = 1,  ncols
             tv1(i,nls+k+1) =  1.5e-6 * tv2(i,nls+k+1) * tv2(i,nls+k+1)
          END DO
       END DO

       dmy(1)=ecrit

       CALL vamin(dmy,1,tv1(1,ls2),npmls2)
       dmy(1)=ecrit

       DO l = ls2, (kmax+1)
          DO i = 1, ncols
             tv2(i,l) =  tl(i,l-1) - tice
          END DO
       END DO

       DO k=1,((kmax+2) - (nls+2))
          DO i = 1,  ncols
             tv2(i,nls+k+1) = 5.2115625e-3 * tv2(i,nls+k+1) + 0.06e0
          END DO
       END DO

       CALL vamax(dmy,1,tv2(1,ls2),npmls2)
       dmy(1)=0.06
       CALL vamin(dmy,1,tv2(1,ls2),npmls2)
       dmy(1)=ecrit

       CALL r8bteq(tv1(1,ls2),npmls2,dmy,1,bitx)
       CALL r8vctr(tv2(1,ls2),npmls2,bitx,tv1(1,ls2),npmls2)

       DO l = ls2, (kmax+1)
          DO i = 1, ncols
             tv1(i,l) =  -tv1(i,l) * css(i,l) * dp(i,l+1)
          END DO
       END DO

       CALL rvexp(tv1(1,ls2),tv2(1,ls2),npmls2)

       DO k=1,((kmax+2) - (nls+2))
          DO i = 1,  ncols
             css(i,nls+k+1) =  h1p - tv2(i,nls+k+1)
          END DO
       END DO

    ELSE IF (icld == 3) THEN

       DO k = 1, kmax
          kflip=kmax+1-k
          DO i = 1, ncols
             rkabs(i,k) = 0.090361*(1.-fice(i,k)) + &
                  (0.005 + 1./rei(i,k))*fice(i,k)
             emis(i,kflip) = 1.- EXP(-1.66*rkabs(i,k)*clwp(i,k))
             emisd(i,k)=emis(i,kflip)
          END DO
       END DO

       DO k=1,kmax
          DO i = 1, (ncols)
             emis1(i,k+1) = emis(i,k)
          END DO
       END DO

       DO k=1,nls+1
          DO i = 1,  ncols
             emis1(i,k) = h0p
          END DO
       END DO

       DO k=1,((kmax+2) - (nls+2))
          DO i = 1, ncols
             css(i,nls+k+1) = css(i,nls+k+1) * emis1(i,nls+k+1)
             ccu(i,nls+k+1) = ccu(i,nls+k+1) * emis1(i,nls+k+1)
          END DO
       END DO

    END IF
    !     
    !     get the contribution from cloudiness
    !     
    CALL cldslw(ncols ,kmax  ,nlcs  ,h1p   ,cs    ,x1    ,x2    , &
         cc    ,x3    ,x4    ,ch    ,css   ,ccu   )

    DO k=1,(kmax+2)
       DO l=1,(kmax+2)
          DO i = 1, (ncols)
             txuf(i,l,k) = txuf(i,l,k) * cs(i,l,k)
          END DO
       END DO
    END DO

    DO k=1,(kmax+2)
       DO i = 1, (ncols)
          shi(i,k) = shi(i,k) * ch(i,k)
       END DO
    END DO

    DO k=1,(kmax+1)
       DO i = 1, (ncols)
          shu(i,k) = shu(i,k) * cc(i,k)
          shu(i,k) = shu(i,k) + shh(i,k)
       END DO
    END DO
    !     
    !     zero out downward flux accumulators at l=1
    !     
    DO i = 1, ncols
       fluxd(i,1) = h0p
    END DO
    !     
    !     upward flux at the surface
    !     
    DO i = 1, ncols
       fluxu(i,(kmax+2)) = sumsav(i)
    END DO
    !     
    !     upward flux at the surface was computed before call to cldslw
    !     compute downward fluxes
    !     
    DO ip = 2, (kmax+2)

       DO i = 1, ncols
          suma(i) = h0p
       END DO

       ipm1 = ip - 1

       DO ix = 1, ipm1
          DO i = 1, ncols
             suma(i) = suma(i) + txuf(i,ix,ip)
          END DO
       END DO

       DO i = 1, ncols
          fluxd(i,ip) = suma(i) - shi(i,ip) + shh(i,ip)
       END DO

    END DO
    !     
    !     compute upward fluxes
    !     
    DO ip = 1, (kmax+1)
       ipp1 = ip + 1

       DO i = 1, ncols
          suma(i) = h0p
       END DO

       DO ix = ipp1, (kmax+2)
          DO i = 1, ncols
             suma(i) = suma(i) + txuf(i,ix,ip)
          END DO
       END DO

       DO i = 1, ncols
          fluxu(i,ip) = suma(i) + shu(i,ip)
       END DO

    END DO

    DO k=1,(kmax+2)
       DO i = 1, (ncols)
          x1(i,k) = fluxd(i,k) - fluxu(i,k)
       END DO
    END DO

    DO i = 1, ncols
       ulwtop(i) = -x1(i,2)
       rs(i)     = -x1(i,(kmax+2))
       dlwbot(i) = fluxd(i,(kmax+2))
    END DO

    DO k=1,kmax
       DO i = 1, (ncols)
          atl(i,k) = (x1(i,k+1) - x1(i,k+2)) * fac / dp(i,k+2)
       END DO
    END DO

  END SUBROUTINE lwrad




  ! cloudy :computes  ozone heating, downflux and ground absorption, water
  !         vapor heating and computes for cycles over five bands total
  !         optical depth, reflection and transmission for diffuse
  !         incidence,direct transmission, diffuse reflection and
  !         transmission for direct beam, upward and dwonward fluxes at
  !         layer boundaries, absorption in the column.



  SUBROUTINE cloudy (ncols ,kmax  ,scosc ,cmuc  ,csmcld,dscld ,rvbc  ,rvdc  , &
       rnbc  ,rndc  ,agvcd ,agncd ,rsvcd ,rsncd ,sc    ,rco   , &
       rcg   ,taut  ,rc2   ,tr1   ,tr2   ,tr3   ,ta    ,wa    , &
       oa    ,e0    ,pu    ,ozcd  ,swale ,swil  ,css   ,acld  , &
       dpc   ,swilc ,ccu   ,tauc  ,litd  ,sqrt3 ,gg    ,ggp   , &
       ggsq  ,np    ,lmp1  ,nsol  ,ncld  ,nclmp1,ncldnp,dooz    )
    !
    !==========================================================================
    !     imax......Number of grid points on a gaussian latitude circle  
    !     kmax......Number of grid points at vertical  
    !     scosc.....scosz(i)   = s0     * cmu(i)
    !                         where s0  is constant solar
    !                               cmu is cosine of solar zenith angle
    !     cmuc......cmuc is cosine of solar zenith angle 
    !     csmcld....csmcld = cosmag(i)  = 1224.0 * cmu(i) * cmu(i) + 1.0
    !     dscld.....Total absorption in atmosphere and ground 
    !     rvbc......Visible beam cloudy flux  
    !     rvdc......Visible diffuse cloudy flux  
    !     rnbc......Nir beam cloudy flux  
    !     rndc......Nir diffuse cloudy flux  
    !     agvcd.....Ground Visible Diffuse Albedo 
    !     agncd.....Ground near Infrared Diffuse albedo 
    !     rsvcd.....Ground Viseible beam albedo 
    !     rsncd.....Ground near infrared beam albedo 
    !     sc........Ground absorption    
    !     rco.......Cloudy an ground reflection for ozone absorption comp.   
    !     rcg.......Cloudy and ground reflection for ground absoption 
    !               computation in visible region of spectrum    
    !     taut......Downward visible beam  
    !     rc2.......cloudy and ground reflection for ground absoption 
    !               computation in region of spectrum from 0.7 to 0.9 mcm   
    !     tr1.......Extinction of beam radiation (clear)   
    !     tr2.......Extinction of beam radiation (cloud) 
    !     tr3.......Extinction of beam radiation (Cloud, Raley)   
    !     ta........Layer Temperature in DLGP    
    !     wa........Layer specific humidity in DLGP   
    !     oa........Layer ozone mixing ratio in DLGP    
    !     e0........cloud optical depth    
    !     pu........pressure at botton of layer in DLGP    
    !     ozcd......ozone amount in column in CDLGP  
    !     swale.....water vapor amount in column in DLGP 
    !     swil......water vapor amount in layer in DLGP  
    !     css.......cloud amount   
    !     acld......Heating rate (cloudy)  
    !     dpc.......pressure defference   
    !     swilc.....water vapor amount in layer in CDLGP 
    !     ccu.......cumulus cloud amount in DLGP   
    !     tauc......Cloud optical depth in cloudy DLGP  
    !     litd......numbers de CDLGP in all layers  
    !     sqrt3.....Magification factor for diffuse reflected radiation sqrt3  = SQRT(3.0)
    !     gg........Asymmetry Factor      = 0.85   
    !     ggp.......ggp    = gg  / (1.0 + gg) * 0.75   
    !     ggsq......ggsq   = gg  * gg 
    !     np........np = (kmax+2) 
    !     lmp1......lmp1   = (kmax+1) 
    !     nsol......Number of solar latitude grid points (cosz>0.01)  
    !     ncld......Number of cloudy DLGP  
    !     nclmp1....NCLD*(KMAX+1), where NCLD is number of cloudy DLGP
    !     ncldnp....NCLD*(KMAX+2), where NCLD is number of cloudy DLGP
    !     dooz......dooz   = (.NOT. noz) where : noz = .FALSE. 
    !               (do ozone computation )
    !==========================================================================
    !
    INTEGER, INTENT(in   ) :: ncols 
    INTEGER, INTENT(in   ) :: kmax
    REAL,    INTENT(in   ) :: scosc (ncols)            
    REAL,    INTENT(in   ) :: cmuc  (ncols)            
    REAL,    INTENT(in   ) :: csmcld(ncols)            
    REAL,    INTENT(out  ) :: dscld (ncols)            
    REAL,    INTENT(out  ) :: rvbc  (ncols)            
    REAL,    INTENT(out  ) :: rvdc  (ncols)            
    REAL,    INTENT(out  ) :: rnbc  (ncols)            
    REAL,    INTENT(out  ) :: rndc  (ncols)            
    REAL,    INTENT(in   ) :: agvcd (ncols)            
    REAL,    INTENT(in   ) :: agncd (ncols)            
    REAL,    INTENT(in   ) :: rsvcd (ncols)            
    REAL,    INTENT(in   ) :: rsncd (ncols)            
    REAL,    INTENT(out  ) :: sc    (ncols)            
    REAL,    INTENT(in   ) :: rco   (ncols)            
    REAL,    INTENT(in   ) :: rcg   (ncols)            
    REAL,    INTENT(out  ) :: taut  (ncols)            
    REAL,    INTENT(in   ) :: rc2   (ncols)            
    REAL,    INTENT(out  ) :: tr1   (ncols)            
    REAL,    INTENT(in   ) :: tr2   (ncols)            
    REAL,    INTENT(in   ) :: tr3   (ncols)            
    REAL,    INTENT(out  ) :: ta    (ncols*(kmax+1))   
    REAL,    INTENT(out  ) :: wa    (ncols*(kmax+1))   
    REAL,    INTENT(out  ) :: oa    (ncols*(kmax+1))   
    REAL,    INTENT(out  ) :: e0    (ncols*(kmax+1))   
    REAL,    INTENT(out  ) :: pu    (ncols*(kmax+2))   
    REAL,    INTENT(in   ) :: ozcd  (ncols*(kmax+2))   
    REAL,    INTENT(out  ) :: swale (ncols*(kmax+2))   
    REAL,    INTENT(out  ) :: swil  (ncols*(kmax+1))   
    REAL,    INTENT(out  ) :: css   (ncols*(kmax+1))   
    REAL,    INTENT(out  ) :: acld  (ncols*(kmax+1))   
    REAL,    INTENT(out  ) :: dpc   (ncols*(kmax+1))   
    REAL,    INTENT(in   ) :: swilc (ncols*(kmax+1))   
    REAL,    INTENT(out  ) :: ccu   (ncols*(kmax+1))   
    REAL,    INTENT(in   ) :: tauc  (ncols*(kmax+1))   
    INTEGER, INTENT(in   ) :: litd  (ncols*(kmax+2))   
    REAL,    INTENT(in   ) :: sqrt3                   
    REAL,    INTENT(in   ) :: gg                      
    REAL,    INTENT(in   ) :: ggp                     
    REAL,    INTENT(in   ) :: ggsq                    
    INTEGER, INTENT(in   ) :: np                      
    INTEGER, INTENT(in   ) :: lmp1                    
    INTEGER, INTENT(in   ) :: nsol                    
    INTEGER, INTENT(in   ) :: ncld                    
    INTEGER, INTENT(in   ) :: nclmp1                  
    INTEGER, INTENT(in   ) :: ncldnp                  
    LOGICAL, INTENT(in   ) :: dooz                    



    REAL                 :: w     (ncols*(kmax+2))     
    REAL                 :: dn    (ncols*(kmax+2))     
    REAL                 :: up    (ncols*(kmax+2))     
    REAL                 :: vm    (ncols*(kmax+2))     
    REAL                 :: vp    (ncols*(kmax+2))     
    REAL                 :: cm    (ncols*(kmax+2))     
    REAL                 :: dl    (ncols*(kmax+2))     
    REAL                 :: den   (ncols*(kmax+1))     

    REAL                 :: f2   (ncols*(kmax+1))
    REAL                 :: cr   (ncols*(kmax+2))
    REAL                 :: e2   (ncols*(kmax+1))
    REAL                 :: ul   (ncols*(kmax+2))
    REAL                 :: u1   (ncols*(kmax+1))
    REAL                 :: ak   (ncols*(kmax+1))
    REAL                 :: da   (ncols*(kmax+1))
    REAL                 :: db   (ncols*(kmax+1))
    REAL                 :: alf1 (ncols*(kmax+1))
    REAL                 :: alf2 (ncols*(kmax+1))
    REAL                 :: sol  (ncols*(kmax+2))     



    !REAL, PARAMETER :: fk(5) = (/0.107e0, 0.104e0, 0.073e0, 0.044e0,  0.025e0/)
    !REAL, PARAMETER :: xk(5) = (/0.005e0, 0.041e0, 0.416e0, 4.752e0, 72.459e0/)

    ! Include global version 2.2 - Increase number of spectral radiation bands
    
    REAL, PARAMETER :: fk(10) = (/0.0698e0,0.1558e0,0.0631e0,0.0362e0,0.0243e0, &
                                  0.0158e0,0.0087e0,0.001467e0,0.002342e0,0.001075e0/)
    REAL, PARAMETER :: xk(10) = (/0.0002e1,0.0035e1,0.0377e1,0.195e1,0.940e1, &
                                  4.46e1,19.0e1,98.9e1,270.60e1,3901.1e1/)
     
    REAL :: avbc (ncols)
    REAL :: anbc (ncols)
    REAL :: rvnbc(ncols)

    REAL :: expcut
    REAL :: ggpp1
    REAL :: ggpm1
    REAL :: gsqm1

    INTEGER :: lp 
    INTEGER :: i 
    INTEGER :: l 
    INTEGER, DIMENSION(lmp1) :: l0a 
    INTEGER, DIMENSION(np)   :: l0b 
    INTEGER, DIMENSION(lmp1) :: l0c
    INTEGER, DIMENSION(lmp1) :: l1a
    INTEGER, DIMENSION(np)   :: l1b
    INTEGER, DIMENSION(lmp1) :: l1c
    INTEGER :: ik 
    INTEGER :: k


    ggpp1 = 1.0 + ggp
    ggpm1 = ggp - 1.0
    gsqm1 = 1.0 - ggsq
    expcut=- LOG(1.0e53)
    lp = lmp1 * ncld
    DO i= 1, ncld
       dn(i)    = 0.0
       tr1(i)   = 0.0
       rvnbc(i) = 0.0
    END DO
    IF (dooz) THEN

       DO l = 1, lmp1
          l0a(l) = (l-1) * ncld
          l1a(l) =  l    * ncld
       END DO
       DO l = 2, np
          l0b(l) = (l-2) * ncld
          l1b(l) = (l-1) * ncld
       END DO
       DO k = 1, lmp1
          l  = np-k
          l0c(k) = (l-1) * ncld
          l1c(k) =  l    * ncld
       END DO
       DO l = 2, np
          DO i = 1, ncld
             w(l0b(l)+i) = ozcd(l1b(l)+i) * csmcld(i)
          END DO
       END DO
       DO i = 1, nclmp1
          e0(i) = 103.63 * w(i)
          e0(i) = e0(i)  * e0(i) * e0(i)
          vp(i) = 1.0 + 138.57   * w(i)
          cm(i) = vp(i) ** 0.805
          dn(ncld+i) = 0.02118 * w(i) &
               / (1.0 + 0.042 * w(i) &
               + 0.000323 * w(i) * w(i)) &
               + 1.08173  * w(i) &
               / cm(i) + 0.0658  * w(i) &
               / (1.0   + e0(i))
       END DO
       !     
       !     compute ozone heating on the way down
       !     
       DO i = 1, nclmp1
          acld(i) = dn(ncld+i) - dn(i)
       END DO

       DO l = 1, lmp1
          DO i = 1, ncld
             acld(l0a(l)+i) = acld(l0a(l)+i) * scosc(i)
          END DO
       END DO
    ELSE
       DO i = 1, ncld
          dn(lp+i) = 0.0
       END DO
    END IF
    !     
    !     downflux and ground absorption for lambda under 0.7 microns
    !     as above but for lamda between 0.7 and 0.9 microns
    !     
    DO i = 1, ncld
       sc(i)   = 0.5     - dn(lp+i)
       taut(i) = sc(i)   * tr3(i) * scosc(i)
       avbc(i) = taut(i) * (1.0 - rsvcd(i))
       rvbc(litd(i)) = taut(i)
    END DO
    DO i = 1, ncld
       sc(i)   = sc(i)   * (1.0 - rcg(i)) * scosc(i)
       taut(i) = (sc(i)  - avbc(i)) &
            / (1.0    - agvcd(i))
       rvdc(litd(i)) = taut(i)
    END DO
    DO i = 1, ncld
       !rnbc(i) = 0.147   * tr2(i)         * scosc(i)
       !anbc(i) = (1.0    - rsncd(i))      * rnbc(i)
       !rndc(i) = (0.147  * (1.0 - rc2(i)) * scosc(i) &
       !     - anbc(i))/ (1.0 - agncd(i))
       !sc(i)   = sc(i)   + (1.0 - rc2(i)) * scosc(i) &
       !     * 0.147
       
       ! Include global version 2.2
       rnbc(i) = 0.1214  * tr2(i)         * scosc(i)
       anbc(i) = (1.0    - rsncd(i))      * rnbc(i)
       rndc(i) = (0.1214  * (1.0 - rc2(i)) * scosc(i) &
                 - anbc(i))/ (1.0 - agncd(i))
       sc(i)   = sc(i)   + (1.0 - rc2(i)) * scosc(i) &
                * 0.1214
    END DO
    IF (dooz) THEN
       DO i = 1, ncld
          up(lp+i) = dn(lp+i)
          w(lp+i)  = ozcd(lp+i) * (1.9 + csmcld(i))
       END DO
       DO i = 1, nclmp1
          w(i) = 1.9 * ozcd(i)
       END DO

       DO l = 1, lmp1
          !cdir nodep
          DO i = 1, ncld
             w(l0a(l)+i) = w(lp+i) - w(l0a(l)+i)
          END DO
       END DO
       DO i = 1, nclmp1
          e0(i) = 103.63       * w(i)
          e0(i) = e0(i) * e0(i) * e0(i)
          vp(i) = 1.0 + 138.57 * w(i)
          cm(i) = vp(i) ** 0.805
          up(i) = 0.02118 * w(i) &
               / (1.0 + 0.042 * w(i) &
               + 0.000323 * w(i) * w(i)) &
               + 1.08173  * w(i) &
               / cm(i) + 0.0658  * w(i) &
               / (1.0 + e0(i))
       END DO
       !     
       !     compute ozone heating on the way up
       !     
       DO i = 1, nclmp1
          w(i) = up(i) - up(ncld+i)
       END DO
       DO l = 1, lmp1
          DO i=1,ncld
             acld(l0a(l)+i) = acld(l0a(l)+i) + w(l0a(l)+i) * rco(i) &
                  * scosc(i)
          END DO
       END DO
       acld(1:nclmp1) = MAX(0.0,acld(1:nclmp1))
    END IF
    DO l = 1, lmp1
       DO i=1,ncld
          oa(l0a(l)+i)  = cmuc(i)
       END DO
    END DO
    DO i = 1, nclmp1
       ta(i) = 0.5  - ggp * oa(i)
       wa(i) = 1.0  - ta(i)
    END DO
    !     
    !     cycle over ten bands
    !     
    !DO ik = 1, 5
    
    ! Include global version 2.2
    DO ik=1,10

       !
       !     compute total optical depth and single scattering albedo
       !     pizero of clouds is 0.99
       !
       DO i = 1, nclmp1
          ccu(i) = tauc(i) + swilc(i) * xk(ik)   
          cr(i)  = tauc(i) / ccu(i)   * 0.99
          !     
          !     compute reflection and transmission for diffuse incidence
          !     
          vp(i)  = 1.0 - cr(i) * gg
          vm(i)  = 1.0 - cr(i)
       END DO
       DO i = 1, nclmp1
          vp(i)  = SQRT(vp(i))
          vm(i)  = SQRT(vm(i))
          u1(i)  = vp(i) / vm(i)
          w(i)   = u1(i)  + 1.0
          w(i)   = w(i)   * w(i)
          cm(i)  = u1(i)  - 1.0
          cm(i)  = cm(i)  * cm(i)
          dpc(i) = sqrt3 * vp(i) * vm(i) * ccu(i)
          e2(i)  = -dpc(i)
          IF (ik >= 4) e2(i) = MAX(e2(i),expcut)
          e2(i)  = EXP(e2(i))
          cm(i)  = w(i)   - cm(i) * e2(i) * e2(i)
          pu(i)  = (u1(i) * u1(i) - 1.0) &
               * (1.0 - e2(i) * e2(i)) / cm(i)
          css(i) =  4.0 * u1(i) * e2(i)  / cm(i)
          !     
          !     delta-scaling of all pertinent quantities
          !     
          vp(i)  = 1.0 - ggsq    * cr(i)
          ccu(i) = ccu(i) * vp(i)
          cr(i)  = cr(i)  * gsqm1 / vp(i)
       END DO
       !     
       !     compute direct transmission
       !     
       DO i = 1, ncld
          sol(i)  = scosc(i) * fk(ik)  
       END DO
       DO l = 1, lmp1
          DO i=1,ncld
             dpc(l0a(l)+i) = ccu(l0a(l)+i) * csmcld(i)
          END DO
       END DO
       DO i = 1, nclmp1
          e0(i)  = -dpc(i)
          IF (ik >= 4) e0(i) = MAX(e0(i), expcut)
          e0(i)  = EXP(e0(i))
       END DO
       !     
       !     compute diffuse reflection and transmission for direct beam
       !     set up delta-eddington parameters
       !     
       DO l = 1, lmp1
          !cdir nodep
          DO i = 1, ncld
             sol(l1a(l)+i) = sol(l0a(l)+i)  * e0(l0a(l)+i)
          END DO
       END DO
       DO i = 1, ncld
          rvnbc(i) = rvnbc(i) + sol(lp+i)
       END DO

       DO i = 1, nclmp1
          swil(i)  =  1.75 - cr(i) * ggpp1
          swale(i) = -0.25 - cr(i) * ggpm1
          ak(i)    =  swil(i)  * swil(i) &
               -  swale(i) * swale(i)
       END DO
       DO i = 1, nclmp1
          ak(i) = SQRT(ak(i))
          alf1(i)  = swil(i)  * wa(i) &
               + swale(i) * ta(i)
          alf2(i)  = swil(i)  * ta(i) &
               + swale(i) * wa(i)
          vp(i) = 1.0 - ak(i) * oa(i)
          vm(i) = 1.0 + ak(i) * oa(i)
          ul(i) = ta(i)   - alf2(i) * oa(i)
          u1(i) = wa(i)   + alf1(i) * oa(i)
          cm(i) = alf2(i) + ak(i)   * ta(i)
          dl(i) = alf2(i) - ak(i)   * ta(i)
          e2(i) = alf1(i) - ak(i)   * wa(i)
          f2(i) = alf1(i) + ak(i)   * wa(i)
          den(i)  = 1.0 - ak(i)  * ak(i) &
               *       oa(i)  * oa(i)
       END DO
       DO i = 1, nclmp1
          den(i) = MAX(den(i),.000001e0)
          dpc(i) = ak(i) * ccu(i)
          da(i)  = -dpc(i)
          IF (ik >= 4) da(i) = MAX(da(i), expcut)
          da(i) = EXP(da(i))
          dpc(i) = 2.0 * dpc(i)
          db(i)  = -dpc(i)
          IF (ik >= 4) db(i) = MAX(db(i), expcut)
          db(i) = EXP(db(i))
          den(i) = den(i) * (ak(i)   + swil(i) &
               + (ak(i) - swil(i)) * db(i))
          !     
          !     compute upward and downward fluxes at layer boundaries
          !     
          up(i) = cr(i)  * (vp(i) * cm(i) &
               - vm(i)  * dl(i)  * db(i) &
               - 2.0           * ak(i)  * ul(i) &
               * e0(i)  * da(i)) / den(i)
          up(i) = up(i)  * sol(i)
          dn(ncld+i) = -cr(i)  * (vm(i) * f2(i) &
               * e0(i)   - vp(i)  * e2(i) &
               * e0(i)   * db(i)  - 2.0 &
               * ak(i)   * u1(i)  * da(i)) &
               / den(i)
          dn(ncld+i) = sol(i)  * dn(ncld+i)
       END DO
       !     
       !     fill up boundary terms
       !     
       DO i = 1, ncld
          up(lp+i) = rsncd(i) * sol(lp+i)
          pu(lp+i) = agncd(i)
          dn(i) = 0.0
          cr(i) = 0.0
          cm(i) = 1.0
          vp(i) = 0.0
          vm(i) = up(i)
       END DO
       !     
       !     safety net
       !     
       DO i = 1, ncldnp
          up (i) = MAX(up (i), 0.0)
          dn (i) = MAX(dn (i), 0.0)
          sol(i) = MAX(sol(i), 0.0)
       END DO
       DO i = 1, nclmp1
          pu (i) = MAX(pu (i), 0.0)
          css(i) = MAX(css(i), 0.0)
       END DO
       !     
       !     flux adding of layers
       !     compute magnification factors
       !     
       DO i = 1, nclmp1
          e0(i) = css(i) * css(i)
       END DO
       DO l = 1, lmp1
          !cdir nodep
          DO i = 1, ncld
             cr(l1a(l)+i) = pu(l0a(l)+i) + e0(l0a(l)+i) * cr(l0a(l)+i) &
                  * cm(l0a(l)+i)
             cm(l1a(l)+i) = 1.0      - cr(l1a(l)+i) * pu(l1a(l)+i)
             cm(l1a(l)+i) = 1.0      / cm(l1a(l)+i)
          END DO
       END DO
       !     
       !     compute fluxes on the way down
       !     
       DO i = 1, nclmp1
          db(i) = cr(i)  * up(i)
          e0(i) = css(i) * cm(i)
       END DO
       DO l = 1, lmp1
          !cdir nodep
          DO i = 1, ncld
             vp(l1a(l)+i) = e0(l0a(l)+i) * (vp(l0a(l)+i) + db(l0a(l)+i)) &
                  + dn(l1a(l)+i)
          END DO
       END DO
       DO i = 1, nclmp1
          vm(ncld+i) = cm(ncld+i) *  &
               (vp(ncld+i) * pu(ncld+i) + up(ncld+i))
       END DO
       DO i = 1, ncld
          ul(lp+i) = vm(lp+i)
          dl(lp+i) = vp(lp+i)  + ul(lp+i) * cr(lp+i) + sol(lp+i)
          tr1(i)   = tr1(i)    + dl(lp+i) - ul(lp+i)
       END DO
       !     
       !     compute fluxes on the way up
       !     
       DO i = 1, nclmp1
          e0(i) = css(i) * cm(i)
       END DO

       DO k = 1, lmp1
          !cdir nodep
          DO i = 1, ncld
             ul(l0c(k)+i) = vm(l0c(k)+i) + ul(l1c(k)+i) * e0(l0c(k)+i)
          END DO
       END DO
       DO i = 1, nclmp1
          dl(i)   = vp(i)   + ul(i) * cr(i) + sol(i)
       END DO
       DO i = 1, nclmp1
          acld(i) = acld(i) + dl(i) - ul(i) &
               - (dl(ncld+i)     -   ul(ncld+i))
       END DO
    END DO
    DO i = 1, ncld
       taut(i) = rnbc(i) + rvnbc(i)
    END DO
    DO i = 1, ncld
       rnbc(litd(i)) = taut(i)
    END DO
    DO i = 1, ncld
       taut(i) = rndc(i) + (tr1(i) - rvnbc(i) &
            * (1.0 - rsncd(i))) / (1. - agncd(i))
    END DO
    DO i = 1, ncld
       rndc(litd(i)) = taut(i)
    END DO
    DO i = 1, ncld
       taut(i) = sc(i) + tr1(i)
    END DO
    DO i = 1, ncld
       sc(litd(i)) = taut(i)
    END DO
    !     
    !     add up absorption in column
    !     
    DO i = 1, nclmp1
       e0(i) = acld(i)
    END DO
    DO i = 1, nclmp1
       acld(litd(i)) = e0(i)
    END DO
    DO i = 1, nsol
       dscld(i) = sc(i)
    END DO
    DO l = 1, lmp1
       DO i = 1, nsol
          dscld(i) = dscld(i) + acld(l0a(l)+i)
       END DO
    END DO
  END SUBROUTINE cloudy





  ! clear  :computes for cycles over five bands ozone heating, radiational
  !         downflux and ground absorption, and water vapor heating.
  !



  SUBROUTINE  clear(ncols ,kmax  ,sqrt3 ,np    ,lmp1  ,nsol  ,nslmp1,nsolnp, &
       dooz  ,scosz ,cosmag,dsclr ,rvbl  ,rvdl  ,rnbl  ,rndl  , &
       agv   ,rsurfv,rsurfn,sl    ,rlo   ,rlg   ,tr1   ,e0    , &
       ozale ,swale ,aclr                                       )
    !==========================================================================
    !    imax......Number of grid points on a gaussian latitude circle
    !    kmax......Number of grid points at vertical
    !    sqrt3.....Magification factor for diffuse reflected radiation 
    !              sqrt3  = SQRT(3.0)   
    !    np........np = (kmax+2)       
    !    lmp1......lmp1   = (kmax+1)     
    !    nsol......Number of solar latitude grid points (cosz>0.01)      
    !    nslmp1....nsol*(kmax +1 ), where nsol is number of solar
    !              latitude grid points (cosz>0.01)  
    !    nsolnp....nsol*(kmax +2 ), where nsol is number of solar
    !              latitude grid points (cosz>0.01)     
    !    dooz......dooz   = (.NOT. noz) where : noz = .FALSE. 
    !               (do ozone computation )    
    !    scosz.....scosz(i)   = s0     * cmu(i)
    !                         where s0  is constant solar
    !                               cmu is cosine of solar zenith angle 
    !    cosmag....Magnification factor in DLGP 
    !              csmcld = cosmag(i)  = 1224.0 * cmu(i) * cmu(i) + 1.0
    !    dsclr.....Absorption of clear atmosphere and ground clear 
    !    rvbl......Visible beam clear  "Downward ground fluxes in DLGP" 
    !    rvdl......Visible diffuse clear "Downward ground fluxes in DLGP" 
    !    rnbl......NearIR beam clear "Downward ground fluxes in DLGP" 
    !    rndl......NearIR diffuse clear  "Downward ground fluxes in DLGP" 
    !    agv.......Ground visible diffuse albedo in DLGP   
    !    rsurfv....Ground visible beam albedo in DLGP 
    !    rsurfn....Ground near IR beam albedo in DLGP
    !    sl........Net ground clear flux 
    !    rlo.......Clear sky and ground reflection in DLGP for 
    !              ozone computation   
    !    rlg.......Clear sky and ground reflection in DLGP for
    !              ground absorption computation  
    !    tr1.......Extinction of beam radiation (clear)    
    !    e0........Cloud optical depth in DLGP  
    !    ozale.....Ozone amount in column in DLGP 
    !    swale.....water vapor amount in column in DLGP 
    !    aclr......Absorption in clear ATM  
    !==========================================================================
    INTEGER, INTENT(in   ) :: ncols
    INTEGER, INTENT(in   ) :: kmax
    REAL,    INTENT(in   ) :: sqrt3                         
    INTEGER, INTENT(in   ) :: np                            
    INTEGER, INTENT(in   ) :: lmp1                          
    INTEGER, INTENT(in   ) :: nsol                          
    INTEGER, INTENT(in   ) :: nslmp1                        
    INTEGER, INTENT(in   ) :: nsolnp                        
    LOGICAL, INTENT(in   ) :: dooz                          
    REAL,    INTENT(in   ) :: scosz (ncols)    
    REAL,    INTENT(in   ) :: cosmag(ncols)    
    REAL,    INTENT(out  ) :: dsclr (ncols)    
    REAL,    INTENT(out  ) :: rvbl  (ncols)    
    REAL,    INTENT(out  ) :: rvdl  (ncols)    
    REAL,    INTENT(out  ) :: rnbl  (ncols)    
    REAL,    INTENT(out  ) :: rndl  (ncols)    
    REAL,    INTENT(in   ) :: agv   (ncols)    
    REAL,    INTENT(in   ) :: rsurfv(ncols)    
    REAL,    INTENT(in   ) :: rsurfn(ncols)    
    REAL,    INTENT(out  ) :: sl    (ncols)    
    REAL,    INTENT(in   ) :: rlo   (ncols)    
    REAL,    INTENT(in   ) :: rlg   (ncols)    
    REAL,    INTENT(in   ) :: tr1   (ncols)    
    REAL,    INTENT(out  ) :: e0    (ncols*(kmax+1))   
    REAL,    INTENT(in   ) :: ozale (ncols*(kmax+2))   
    REAL,    INTENT(in   ) :: swale (ncols*(kmax+2))   
    REAL,    INTENT(out  ) :: aclr  (ncols*(kmax+1))   

    REAL                  :: den   (ncols*(kmax+1))          
    REAL                  :: w     (ncols*(kmax+2))          
    REAL                  :: dn    (ncols*(kmax+2))          
    REAL                  :: up    (ncols*(kmax+2))          
    REAL                  :: vp    (ncols*(kmax+2))          
    REAL                  :: cm    (ncols*(kmax+2))          

    !REAL, PARAMETER :: fk(5) = (/0.107e0, 0.104e0, 0.073e0, 0.044e0,  0.025e0/)
    !REAL, PARAMETER :: xk(5) = (/0.005e0, 0.041e0, 0.416e0, 4.752e0, 72.459e0/)

    ! Include global version 2.2 - Increase number of spectral radiation bands
    REAL, PARAMETER :: fk(10) = (/0.0698e0,0.1558e0,0.0631e0,0.0362e0,0.0243e0, &
                                  0.0158e0,0.0087e0,0.001467e0,0.002342e0,0.001075e0/)
    REAL, PARAMETER :: xk(10) = (/0.0002e1,0.0035e1,0.0377e1,0.195e1,0.940e1, &
                                  4.46e1,19.0e1,98.9e1,270.60e1,3901.1e1/)

    
    REAL :: avbl(ncols)
    REAL :: dum(1)
    REAL :: expcut

    INTEGER :: i 
    INTEGER :: l 
    INTEGER :: l0 
    INTEGER :: l1 
    INTEGER :: lp 
    INTEGER :: ik

    expcut=- LOG(1.0e53)
    lp = lmp1 * nsol
    DO i = 1, nsol
       sl(i) = 0.0
       dn(i) = 0.0
    END DO
    DO i = 1, nslmp1
       aclr(i) = 0.0
    END DO
    DO l = 1, lmp1
       l0 = (l-1) * nsol
       DO i = 1, nsol
          den(l0+i) = scosz(i)
       END DO
    END DO
    IF (dooz) THEN
       DO l = 2, np
          l0 = (l-2) * nsol
          l1 = (l-1) * nsol
          DO i = 1, nsol
             w(l0+i) = ozale(l1+i) * cosmag(i)
          END DO
       END DO
       DO i = 1, nslmp1
          e0(i) = 103.63       * w(i)
          e0(i) = e0(i) * e0(i) * e0(i)
          vp(i) = 1.0 + 138.57 * w(i)
          cm(i) = EXP(LOG(vp(i) + 1.0e-100)* 0.805)
       END DO
       DO i = 1, nslmp1
          dn(nsol+i) = 0.02118 * w(i) &
               / (1.0 + 0.042 * w(i) &
               + 0.000323 * w(i) * w(i)) &
               + 1.08173  * w(i) &
               / cm(i) + 0.0658  * w(i) &
               / (1.0   + e0(i))
       END DO
       !
       !        compute ozone heating on the way down
       !
       DO i = 1, nslmp1
          aclr(i) = (dn(nsol+i) - dn(i)) * den(i)
       END DO
    ELSE
       DO i = 1, nsol
          dn(lp+i) = 0.0
       END DO
    END IF
    !     
    !     downflux and ground absorption for lamda less than 0.7 microns
    !     as above but for lambda between 0.7 and 0.9 microns
    !     
    DO i = 1, nsol
       sl(i)   = 0.5        - dn(lp+i)
       rvbl(i) = sl(i) * tr1(i) * scosz(i)
       avbl(i) = (1.0 - rsurfv(i)) * rvbl(i)
       sl(i)   = (1.0 - rlg(i))    * scosz(i) * sl(i)
       rvdl(i) = (sl(i) - avbl(i)) / (1.0 - agv(i))
       !rnbl(i) = 0.147 * scosz(i)
       !rndl(i) = 0.0*sl(i)
       ! Include global version 2.2 
       rnbl(i) = 0.1214 * scosz(i)
       rndl(i) = 0.0
       sl(i)   = sl(i) + rnbl(i)  * (1.0 - rsurfn(i))
    END DO

    IF (dooz) THEN
       DO i = 1, nsol
          up(lp+i) = dn(lp+i)
          w(lp+i)  = ozale(lp+i) * (1.90 + cosmag(i))
       END DO
       DO i = 1, nslmp1
          w(i) = 1.9 * ozale(i)
       END DO
       DO l = 1, lmp1
          l0 = (l-1) * nsol
          !cdir nodep
          DO i = 1, nsol
             w(l0+i) = w(lp+i) - w(l0+i)
          END DO
       END DO
       DO i = 1, nslmp1
          e0(i) = 103.63 * w(i)
          e0(i) = e0(i)  * e0(i) * e0(i)
          vp(i) = 1.0 + 138.57   * w(i)
          cm(i) = EXP(LOG(vp(i) + 1.0e-100)* 0.805)
       END DO
       DO i = 1, nslmp1
          up(i) = 0.02118 * w(i) &
               / (1.0 + 0.042 * w(i) &
               + 0.000323 * w(i) * w(i)) &
               + 1.08173  * w(i) &
               / cm(i) + 0.0658  * w(i) &
               / (1.0   + e0(i))
       END DO
       !
       !     compute ozone heating on the way up
       !
       DO i = 1, nslmp1
          w(i) = up(i) - up(nsol+i)
       END DO
       DO l = 1, lmp1
          l0 = (l-1) * nsol
          DO i = 1, nsol
             aclr(l0+i) = aclr(l0+i) + w(l0+i) * rlo(i) &
                  * scosz(i)
          END DO
       END DO
       dum(1)=0.0e0
       aclr(1:nslmp1) = MAX(aclr(1:nslmp1), 0.0)
    END IF
    !     
    !     cycle over ten bands
    !     
    !DO ik = 1, 5
    ! Include global version 2.2
    DO ik=1,10
       DO l = 1, np
          l0 = (l-1) * nsol
          DO i = 1, nsol
             w(l0+i) = swale(l0+i) * cosmag(i)
          END DO
       END DO
       IF (ik >= 4) THEN
          DO i = 1, nsolnp
             dn(i) = -w(i) * xk(ik)
             dn(i) = MAX(dn(i), expcut)
             dn(i) = EXP(dn(i))
          END DO
       ELSE
          DO i = 1, nsolnp
             dn(i) = EXP(-w(i) * xk(ik))
          END DO
       END IF
       !     
       !     compute water vapor heating on the way down
       !     
       DO i = 1, nslmp1
          w(i)    = (dn(i)  - dn(nsol+i)) * fk(ik)
          w(i)    = w(i)    * den(i)
          aclr(i) = aclr(i) + w(i)
       END DO
       !     
       !     ground absorption for wavelengths over 0.9 microns
       !     
       DO i = 1, nsol
          sl(i)   = sl(i)   + dn(lp+i) * (1.0 - rsurfn(i)) &
               * scosz(i) * fk(ik)
          rnbl(i) = rnbl(i) + dn(lp+i) * scosz(i) * fk(ik)
          up(lp+i) = dn(lp+i)
          w(lp+i)  = swale(lp+i) * (sqrt3 + cosmag(i)) * xk(ik)
       END DO
       DO i = 1, nslmp1
          w(i) = sqrt3 * swale(i) * xk(ik)
       END DO
       DO l = 1, lmp1
          l0 = (l-1) * nsol
          !cdir nodep
          DO i = 1, nsol
             w(l0+i) = w(l0+i) - w(lp+i)
          END DO
       END DO
       up(1:nslmp1) = EXP(w(1:nslmp1))
       !
       !     compute water vapor heating on the way up
       !
       DO i = 1, nslmp1
          w(i) = (up(nsol+i) - up(i)) * fk(ik)
       END DO
       DO l = 1, lmp1
          l0 = (l-1) * nsol
          !cdir nodep
          DO i = 1, nsol
             aclr(l0+i) = aclr(l0+i) + w(l0+i) * rsurfn(i) * scosz(i)
          END DO
       END DO
    END DO
    DO i = 1, nsol
       dsclr(i) = sl(i)
    END DO
    DO l = 1, lmp1
       l0 = (l-1) * nsol
       DO i = 1, nsol
          dsclr(i) = dsclr(i) + aclr(l0+i)
       END DO
    END DO
  END SUBROUTINE clear




  ! setsw  :calculates ozone and water vapor amounts, clear sky
  !         reflectivities, clear sky ozone reflection, clear sky ground
  !         reflection; finds cloud top; computes cloud optical depth,
  !         cloudy sky reflectivities, cloudy sky ozone reflection, cloudy
  !         sky ground reflection.


  SUBROUTINE setsw(ncols ,kmax  ,tice  ,icld  ,clwp  ,fice  ,rei   ,taud  , &
       tsea  ,scosz ,cmu   ,cosmag,dsclr ,rvbl  ,scosc ,cmuc  , &
       csmcld,dscld ,rvbc  ,rvdl  ,rnbl  ,rndl  ,agv   ,agn   , &
       rvdc  ,rnbc  ,rndc  ,agncd ,rsurfv,rsurfn,sl    ,sc    , &
       ta    ,wa    ,oa    ,pu    ,aclr  ,dp    ,css   ,acld  , &
       dpc   ,ccu   ,litx  ,listim,bitd  ,sqrt3 ,gg    ,ggp   , &
       ggsq  ,athrd ,tthrd ,rcn1  ,rcn2  ,tcrit ,ecrit ,np    , &
       lmp1  ,nsol  ,nsolp1,nslmp1,nsolnp,ncld  ,ncldp1,nclmp1, &
       ncldnp,dooz)
    !==========================================================================
    !    imax......Number of grid points on a gaussian latitude circle    
    !    kmax......Number of grid points at vertical    
    !    tice......tice=273.16 zero grau absoluto
    !    clwp
    !    fice......controle of change of fase of water
    !    rei.......determine rei as function of normalized pressure
    !    taud
    !    tsea
    !    icld......>>> icld=1     : old cloud emisivity setting              !
    !                               ccu = ccu*(1-exp(-0.05*dp))               !
    !                               css = css*(1-exp(-0.01*dp))  
    !                                     for ice cloud t<253.0               !
    !                               css = css*(1-exp(-0.05*dp))               !
    !                                     for     cloud t>253.0               !
    !              >>> icld=2     : new cloud emisivity setting               !
    !                               ccu = 1.0-exp(-0.12*ccu*dp)               !
    !                               css = 0.0 for      t<-82.5c               !
    !                               css = 1-exp(-1.5e-6*(t-tcrit)**2*css*dp)  !
    !                                     for -82.5<t<-10.0                   !
    !                               css = 1-exp(-5.2e-3*(t-273.)-0.06)*css*dp)!
    !                                     for -10.0<t< 0.0                    !
    !                               css = 1-exp(-0.06*css*dp)                 !
    !                                     for t> 0.0c                         !
    !             >>> icld = 3   : ccm3 based cloud emisivity                 !
    !    sqrt3.....Magification factor for diffuse reflected radiation 
    !              sqrt3  = SQRT(3.0)       
    !    gg........Asymmetry Factor      = 0.85       
    !    ggp.......ggp    = gg  / (1.0 + gg) * 0.75       
    !    ggsq......ggsq   = gg  * gg     
    !    athrd.....constant athrd  = 1.0 / 3.0    
    !    tthrd.....constant tthrd  = 2.0 / 3.0    
    !    rcn1......constant  rcn1   = 1.0 / 6.55
    !    rcn2......constant  rcn2   = 1.0 / 4.47238
    !    tcrit.....constant tcrit  = tice - 82.5    
    !    ecrit.....ecrit  = 0.0105125    
    !    np........np     = (kmax+2)    
    !    lmp1......lmp1   = (kmax+1)     
    !    nsol......Number of solar latitude grid points (cosz>0.01)       
    !    nsolp1....nsolp1=nsol+1    
    !    nslmp1....nslmp1=nsol*(kmax +1 ), where nsol is number of solar
    !              latitude grid points (cosz>0.01)      
    !    nsolnp....nsolnp=nsol*(kmax +2 ), where nsol is number of solar
    !              latitude grid points (cosz>0.01)      
    !    ncld......Number of cloudy DLGP    
    !    ncldp1....ncldp1=NCLD+1    
    !    nclmp1....nclmp1=NCLD*(kmax+1)    
    !    ncldnp....ncldnp=NCLD*(kmax+2)    
    !    dooz......dooz   = (.NOT. noz) where : noz = .FALSE. 
    !               (do ozone computation )     
    !    scosz.....scosz(i)   = s0     * cmu(i)
    !                         where s0  is constant solar
    !                               cmu is cosine of solar zenith angle  
    !    cmu.......is cosine of solar zenith angle 
    !    cosmag....Magnification factor in DLGP 
    !    dsclr.....Absorption of clear atmosphere and ground clear 
    !    rvbl......Visible beam clear  "Downward ground fluxes in DLGP"   
    !    scosc.....scosz(i)   = s0     * cmu(i)
    !                         where s0  is constant solar
    !                               cmu is cosine of solar zenith angle 
    !    cmuc......cmuc is cosine of solar zenith angle   
    !    csmcld....csmcld = cosmag(i)  = 1224.0 * cmu(i) * cmu(i) + 1.0
    !    dscld.....Total absorption in atmosphere and ground  
    !    rvbc......Visible beam cloudy flux    
    !    rvdl......Visible diffuse clear  
    !    rnbl......NearIR beam clear  
    !    rndl......NearIR diffuse clear  
    !    agv.......Ground visible diffuse albedo in DLGP   
    !    agn.......Ground near IR diffuse albedo in DLGP    
    !    rvdc......Visible diffuse cloudy  
    !    rnbc......NearIR beam cloudy  
    !    rndc......NearIR diffuse cloudy  
    !    agncd.....Ground near IR diffuse albedo in CDLGP 
    !    rsurfv....Ground visible beam albedo in DLGP 
    !    rsurfn....Ground near IR beam albedo in DLGP
    !    sl........Net ground clear flux    
    !    sc........Ground absorption      
    !    ta........Layer Temperature in DLGP    
    !    wa........Layer specific humidity in DLGP   
    !    oa........Layer ozone mixing ratio in DLGP    
    !    pu........pressure at botton of layer in DLGP        
    !    aclr......Absorption in clear ATM  
    !    dp........Pressure difference in DLGP    
    !    css.......Large scale cloud anount in DLGP    
    !    acld......heatinf rate (cloudy)  
    !    dpc.......Pressure difference in DLGP    
    !    ccu.......cumulus cloud amount in DLGP   
    !    litx......Numbers of DLGP in all layers  
    !    listim....1,2,3...imax*(kmax+1)
    !    bitd......(.true.) in CDLGP  
    !    agvcd.....ground visible diffuse albedo in CDLGP 
    !    rlo.......Clear sky and ground reflection in DLGP for 
    !              ozone computation      
    !    rlg.......Clear sky and ground reflection in DLGP for
    !              ground absorption computation   
    !    rsvcd.....Ground Viseible beam albedo 
    !    rsncd.....Ground near infrared beam albedo 
    !    rco.......Cloudy an ground reflection for ozone absorption comp.    
    !    rcg.......Cloudy and ground reflection for ground absoption 
    !              computation in visible region of spectrum      
    !    taut......Downward visible beam   
    !    rc2.......Cloudy and ground reflection for ground absoption 
    !              computation in region of spectrum from 0.7 to 0.9 mcm    
    !    tr1.......Extinction of beam radiation (clear) 
    !    tr2.......Extinction of beam radiation (cloud) 
    !    tr3.......Extinction of beam radiation (Cloud, Raley) 
    !    e0........cloud optical depth        
    !    ozale.....Ozone amount in column in DLGP  
    !    ozcd......ozone amount in column in CDLGP   
    !    swale.....water vapor amount in column in DLGP 
    !    swil......water vapor amount in layer in DLGP  
    !    swilc.....water vapor amount in layer in CDLGP  
    !    tauc......Cloud optical depth in cloudy DLGP   
    !    litd......numbers de CDLGP in all layers  
    !    bitc......Working logical dimension  
    !==========================================================================

    INTEGER, INTENT(in   ) :: ncols
    INTEGER, INTENT(in   ) :: kmax                  
    REAL,    INTENT(in   ) :: tice
    REAL,    INTENT(in   ) :: clwp(ncols,kmax)
    REAL,    INTENT(in   ) :: fice(ncols,kmax)
    REAL,    INTENT(in   ) :: rei (ncols,kmax)
    REAL,    INTENT(out  ) :: taud(ncols,kmax)
    REAL,    INTENT(in   ) :: tsea(ncols)
    INTEGER, INTENT(in   ) :: icld


    REAL,    INTENT(in   ) :: sqrt3                   
    REAL,    INTENT(in   ) :: gg                      
    REAL,    INTENT(in   ) :: ggp                     
    REAL,    INTENT(in   ) :: ggsq                    
    REAL,    INTENT(in   ) :: athrd                   
    REAL,    INTENT(in   ) :: tthrd                   
    REAL,    INTENT(in   ) :: rcn1                    
    REAL,    INTENT(in   ) :: rcn2                    
    REAL,    INTENT(in   ) :: tcrit                   
    REAL,    INTENT(in   ) :: ecrit                   
    INTEGER, INTENT(in   ) :: np                      
    INTEGER, INTENT(in   ) :: lmp1                    
    INTEGER, INTENT(in   ) :: nsol                    
    INTEGER, INTENT(in   ) :: nsolp1                  
    INTEGER, INTENT(in   ) :: nslmp1                  
    INTEGER, INTENT(in   ) :: nsolnp                  
    INTEGER, INTENT(out  ) :: ncld                    
    INTEGER, INTENT(out  ) :: ncldp1                  
    INTEGER, INTENT(out  ) :: nclmp1                  
    INTEGER, INTENT(out  ) :: ncldnp                  
    LOGICAL, INTENT(in   ) :: dooz                    


    REAL,    INTENT(in   ) :: scosz (ncols)            
    REAL,    INTENT(in   ) :: cmu   (ncols)            
    REAL,    INTENT(in   ) :: cosmag(ncols)            
    REAL,    INTENT(out  ) :: dsclr (ncols)            
    REAL,    INTENT(out  ) :: rvbl  (ncols)            
    REAL,    INTENT(out  ) :: scosc (ncols)            
    REAL,    INTENT(out  ) :: cmuc  (ncols)            
    REAL,    INTENT(out  ) :: csmcld(ncols)            
    REAL,    INTENT(out  ) :: dscld (ncols)            
    REAL,    INTENT(out  ) :: rvbc  (ncols)            
    REAL,    INTENT(out  ) :: rvdl  (ncols)            
    REAL,    INTENT(out  ) :: rnbl  (ncols)            
    REAL,    INTENT(out  ) :: rndl  (ncols)            
    REAL,    INTENT(in   ) :: agv   (ncols)            
    REAL,    INTENT(in   ) :: agn   (ncols)            
    REAL,    INTENT(out  ) :: rvdc  (ncols)            
    REAL,    INTENT(out  ) :: rnbc  (ncols)            
    REAL,    INTENT(out  ) :: rndc  (ncols)            
    REAL,    INTENT(out  ) :: agncd (ncols)            
    REAL,    INTENT(in   ) :: rsurfv(ncols)            
    REAL,    INTENT(in   ) :: rsurfn(ncols)            
    REAL,    INTENT(out  ) :: sl    (ncols)            
    REAL,    INTENT(out  ) :: sc    (ncols)            
    REAL,    INTENT(inout) :: ta    ((ncols*(kmax+1))) 
    REAL,    INTENT(inout) :: wa    ((ncols*(kmax+1))) 
    REAL,    INTENT(out  ) :: oa    ((ncols*(kmax+1))) 
    REAL,    INTENT(inout) :: pu    ((ncols*(kmax+2))) 
    REAL,    INTENT(out  ) :: aclr  ((ncols*(kmax+1))) 
    REAL,    INTENT(in   ) :: dp    ((ncols*(kmax+1))) 
    REAL,    INTENT(out  ) :: css   ((ncols*(kmax+1))) 
    REAL,    INTENT(out  ) :: acld  ((ncols*(kmax+1))) 
    REAL,    INTENT(inout) :: dpc   ((ncols*(kmax+1))) 
    REAL,    INTENT(inout) :: ccu   ((ncols*(kmax+1))) 
    INTEGER, INTENT(in   ) :: litx  ((ncols*(kmax+1))) 
    INTEGER, INTENT(in   ) :: listim((ncols*(kmax+2))) 
    LOGICAL, INTENT(out  ) :: bitd  ((ncols*(kmax+2))) 

    REAL                   :: agvcd (ncols)            
    REAL                   :: rlo   (ncols)            
    REAL                   :: rlg   (ncols)            
    REAL                   :: rsvcd (ncols)            
    REAL                   :: rsncd (ncols)            
    REAL                   :: rco   (ncols)            
    REAL                   :: rcg   (ncols)            
    REAL                   :: taut  (ncols)            
    REAL                   :: rc2   (ncols)            
    REAL                   :: tr1   (ncols)            
    REAL                   :: tr2   (ncols)            
    REAL                   :: tr3   (ncols)            
    REAL                   :: e0    ((ncols*(kmax+1))) 
    REAL                   :: ozale ((ncols*(kmax+2))) 
    REAL                   :: ozcd  ((ncols*(kmax+2))) 
    REAL                   :: swale ((ncols*(kmax+2))) 
    REAL                   :: swil  ((ncols*(kmax+1))) 
    REAL                   :: swilc ((ncols*(kmax+1))) 
    REAL                   :: tauc  ((ncols*(kmax+1))) 
    INTEGER                :: litd  ((ncols*(kmax+2))) 
    LOGICAL                :: bitc  ((ncols*(kmax+2))) 


    REAL                   :: clwp1 (ncols,kmax)
    REAL                   :: clwp1a((ncols*(kmax+1)))
    REAL                   :: rkabs (ncols,kmax)
    REAL                   :: tauxcl(ncols,kmax)
    REAL                   :: tauxci(ncols,kmax)

    INTEGER                :: icl (ncols)
    INTEGER                :: icc (ncols)
    INTEGER                :: idum(1)
    REAL                   :: dum (1)
    REAL                   :: arg1(ncols)
    REAL                   :: a1  (ncols)
    REAL                   :: e1  (ncols)
    REAL                   :: upim(ncols)
    REAL                   :: dnim(ncols)
    REAL                   :: rc1 (ncols)
    REAL                   :: tlim(ncols)
    REAL                   :: g   (ncols)
    REAL                   :: taui(ncols)
    REAL                   :: b1  (ncols)
    REAL                   :: c1  (ncols)

    REAL                   :: expcut
    REAL,    PARAMETER     :: abarl=2.261e-2
    REAL,    PARAMETER     :: bbarl=1.4365
    REAL,    PARAMETER     :: abari=3.448e-3
    REAL,    PARAMETER     :: bbari=2.431
    INTEGER                :: i 
    INTEGER                :: l
    INTEGER                :: l0 
    INTEGER                :: l1 
    INTEGER                :: k 
    INTEGER                :: kflip 
    INTEGER                :: lm 
    INTEGER                :: nsollm
    REAL                   :: tmp1l 
    REAL                   :: tmp1i
    clwp1a=0.0
    expcut=- LOG(1.0e53)
    !     
    !     zero out ozone below 500 mb
    !     
    IF (dooz) THEN
       dum(1)=500.0e0
       CALL r8btgt(pu(nsolp1),nslmp1,dum,1,bitc)
       dum(1)=0.0e0
       CALL r8vctr(dum,1,bitc,oa,nslmp1)
       !     
       !     compute ozone and water vapor amounts
       !     
       DO i=1,nsol
          ozale(i) = 0.0
       END DO
       DO i=1,nslmp1
          oa(i) = 476.0 * oa(i) * dp(i)
       END DO
       DO l=2,np
          l0 = (l-2) * nsol
          l1 = (l-1) * nsol
          !cdir nodep
          DO i=1,nsol
             ozale(l1+i) = ozale(l0+i) + oa(l0+i)
          END DO
       END DO
    END IF
    DO i=1,nsol
       swale(i) = 0.0
    END DO
    DO i=1,nsolnp
       pu(i) = pu(i) * pu(i)
    END DO
    CALL rvsqrt(ta,swil,nslmp1)
    DO i=1,nslmp1
       swil(i) = 120.1612    * swil(i)
       swil(i) = (pu(nsol+i) - pu(i)) &
            * wa(i)       / swil(i)
    END DO
    DO l=2,np
       l0 = (l-2) * nsol
       l1 = (l-1) * nsol
       !cdir nodep
       DO i=1,nsol
          swale(l1+i) = swale(l0+i) + swil(l0+i)
       END DO
    END DO
    !     
    !     compute clear sky reflectivities
    !     clear sky ozone reflection, tauray=0.85
    !     
    DO i=1,nsol
       e1(i) = -0.85 * cosmag(i)
       e1(i) = EXP(e1(i))
    END DO
    DO i=1,nsol
       b1(i)   = 3.0 * cmu(i)
       c1(i)   = 2.0 - b1(i)
       b1(i)   = 2.0 + b1(i)
       a1(i)   = (b1(i) + c1(i) * e1(i)) * rcn1
       upim(i) = 1.0 - a1(i)
       dnim(i) = a1(i) - e1(i)
       rlo(i)  = upim(i) + (e1(i) * rsurfv(i) &
            + dnim(i) * agv(i)) &
            * 0.576004 / (1.0 - 0.423996 * agv(i))
       rlo(i)  = tthrd * rsurfv(i) + athrd  * rlo(i)
       !     
       !     clear sky ground reflection, tauray=0.15746
       !     
       e1(i)   = -0.15746 * cosmag(i)
       e1(i)   = EXP(e1(i))
    END DO
    DO i=1,nsol
       tr1(i)  = e1(i)
       a1(i)   = (b1(i) + c1(i) * e1(i)) * rcn2
       upim(i) = 1.0 - a1(i)
       dnim(i) = a1(i) - e1(i)
       rlg(i)  = upim(i) + (e1(i)  * rsurfv(i) &
            + dnim(i) * agv(i)) * 0.88 &
            / (1.0 - 0.12  * agv(i))
    END DO
    CALL clear (ncols ,kmax  ,sqrt3 ,np    ,lmp1  ,nsol  ,nslmp1,nsolnp, &
         dooz  ,scosz ,cosmag,dsclr ,rvbl  ,rvdl  ,rnbl  ,rndl  , &
         agv   ,rsurfv,rsurfn,sl    ,rlo   ,rlg   ,tr1   ,e0    , &
         ozale ,swale ,aclr                                       )
    !     
    !     find cloud top
    !     
    CALL vamax(ccu,nslmp1,css,nslmp1)
    DO i=1,nsol
       icc(i) = np
    END DO
    DO k=1,lmp1
       l=np-k
       l0 = (l-1) * nsol + 1
       dum(1)=0.0e0
       CALL r8btgt(css(l0),nsol,dum,1,bitc)
       idum(1)=l
       ! CALL i8vctr(idum,1,bitc,icc,nsol)
       WHERE (bitc(1:nsol)) icc(1:nsol) = l
    END DO
    idum(1)=np
    ! CALL i8btne(icc,nsol,idum,1,bitd(1))
    bitd(1:nsol) = icc(1:nsol) /= np
    CALL r8scnt(bitd,nsol,ncld)
    IF (ncld == 0) THEN
       DO i=1,nslmp1
          acld(i) = aclr(i)
       END DO
       DO i=1,nsol
          sc(i)    = sl(i)
          dscld(i) = dsclr(i)
          rndc(i)  = rndl(i)
          rvdc(i)  = rvdl(i)
          rnbc(i)  = rnbl(i)
          rvbc(i)  = rvbl(i)
       END DO
       RETURN
    END IF
    ncldp1 = ncld + 1
    nclmp1 = ncld * lmp1
    ncldnp = ncld * np
    idum(1)=np
    DO l=1,lmp1
       l1 = l * nsol + 1
       ! CALL i8btne(icc,nsol,idum,1,bitd(l1))
       bitd(l1:l1+nsol-1) = icc(1:nsol) /= np
    END DO
    !
    !     compress out cloudy grid point values for ozone amt., water amt.,
    !     scosz, etc.
    !
    ! CALL i8vcmp(listim,bitd,nsolnp,litd,ncldnp)
    litd(1:COUNT(bitd(1:nsolnp))) = PACK(listim(1:nsolnp), bitd(1:nsolnp))
    CALL i8vgat(icc,nsol,litd,icl,ncld)
    CALL r8vgat(cmu,nsol,litd,cmuc,ncld)
    CALL r8vgat(agv,nsol,litd,agvcd,ncld)
    CALL r8vgat(agn,nsol,litd,agncd,ncld)
    CALL r8vgat(rsurfv,nsol,litd,rsvcd,ncld)
    CALL r8vgat(rsurfn,nsol,litd,rsncd,ncld)
    CALL r8vgat(scosz,nsol,litd,scosc,ncld)
    CALL r8vgat(cosmag,nsol,litd,csmcld,ncld)
    CALL r8vgat(swil,nslmp1,litd,swilc,nclmp1)
    IF (dooz) THEN
       CALL r8vgat(ozale,nsolnp,litd,ozcd,ncldnp)
       !     
       !     make ozone amount constant below cloud top
       !     
       DO l=1,lmp1
          l0 = (l-1) * ncld + 1
          l1 =  l    * ncld + 1
          idum(1)=l
          ! CALL i8btle(icl,ncld,idum,1,bitc)
          bitc(1:ncld) = icl(1:ncld) <= l
          CALL r8vctr(ozcd(l0),ncld,bitc,ozcd(l1),ncld)
       END DO
    END IF
    !     
    !     compute cloud optical depth
    !     
    !     icld = 1   : old cloud emisivity setting
    !     icld = 2   : new cloud emisivity setting
    !     
    IF (icld == 1) THEN
       DO i=1,nslmp1
          e0(i)   = 0.05
          bitc(i) = (ta(i)  .LT. 253.0) &
               .AND. (ccu(i) .EQ. 0.0)
       END DO
       dum(1)=0.025
       CALL r8vctr(dum,1,bitc,e0,nslmp1)
    ELSE IF (icld == 2) THEN
       DO i=1,nslmp1
          e0(i) = (ta(i) - tcrit)
       END DO
       dum(1)=0.0e0
       CALL vamax(dum,1,e0,nslmp1)
       DO i=1,nslmp1
          tauc(i) = 2.0e-6 * e0(i) * e0(i)
       END DO
       dum(1)=ecrit
       CALL vamin(dum,1,tauc,nslmp1)
       DO i=1,nslmp1
          e0(i) = 6.94875e-3 * (ta(i) - tice) + 0.08
       END DO
       dum(1)=ecrit
       CALL vamax(dum,1,e0,nslmp1)
       dum(1)=0.08e0
       CALL vamin(dum,1,e0,nslmp1)
       dum(1)=ecrit
       CALL r8bteq(e0,nslmp1,dum,1,bitc)
       CALL r8vctr(tauc,nslmp1,bitc,e0,nslmp1)
       dum(1)=0.0e0
       CALL r8btgt(ccu,nslmp1,dum,1,bitc)
       dum(1)=0.16e0
       CALL r8vctr(dum,1,bitc,e0,nslmp1)
    ELSE IF (icld == 3) THEN
       DO k=1,kmax
          kflip=kmax+1-k
          DO i=1,ncols
             rkabs(i,k) = 0.090361*(1.-fice(i,k)) + &
                  (0.005 + 1./rei(i,k))*fice(i,k)
             tmp1l = abarl + bbarl/10.0
             tmp1i = abari + bbari/rei(i,k)
             tauxcl(i,k) = clwp(i,k)*tmp1l*(1.-fice(i,k))
             tauxci(i,k) = clwp(i,k)*tmp1i*fice(i,k)
             IF (tsea(i) > 0.) THEN
                clwp1(i,kflip)=0.70*(tauxcl(i,k)+tauxci(i,k))
             ELSE
                clwp1(i,kflip)=1.*(tauxcl(i,k)+tauxci(i,k))
             END IF
             taud(i,k)=clwp1(i,kflip)
          END DO
       END DO
       lm=(kmax)
       nsollm=nsol*lm
       CALL r8vgat(clwp1,(ncols*kmax),litx,clwp1a(nsolp1),nsollm)
       DO i=1,nslmp1
          !     
          !     the extra cloud fraction idea from ncar
          !     
          e0(i) = SQRT(css(i))*css(i)*clwp1a(i)
       END DO
    END IF
    IF (icld /= 3) THEN
       DO i=1,nslmp1
          e0(i) = e0(i) * dpc(i) * css(i)
       END DO
    END IF
    CALL r8vgat(e0,nslmp1,litd,tauc,nclmp1)
    DO i=1,ncld
       taut(i) = 0.0
    END DO
    DO l=1,lmp1
       l0 = (l-1) * ncld
       DO i=1,ncld
          taut(i) = taut(i) + tauc(l0+i)
       END DO
    END DO
    !     
    !     compute cloudy sky reflectivities
    !     cloudy sky ozone reflection, tauray=0.0, gcld=0.85
    !     
    DO i=1,ncld
       tlim(i) = 1.0 / (1.0 + 0.1299 * taut(i))
       arg1(i) = -0.2775 * taut(i) * csmcld(i)
       e1(i)   = EXP(arg1(i))
    END DO
    DO i=1,ncld
       tr2(i)  = e1(i)
       b1(i)   = 3.0 * cmuc(i)
       c1(i)   = 2.0 - b1(i)
       b1(i)   = 2.0 + b1(i)
       a1(i)   = b1(i)   + c1(i)  * e1(i)
       a1(i)   = a1(i)   / (4.0 + 0.45 * taut(i))
       upim(i) = 1.0          - a1(i)
       dnim(i) = a1(i)   - e1(i)
       rc1(i)  = upim(i) + (e1(i)    * rsvcd(i) &
            + dnim(i) * agvcd(i)) * tlim(i) &
            / (1.0 - (1.0  - tlim(i))  * agvcd(i))
       rc2(i)  = upim(i) + (e1(i)    * rsncd(i) &
            + dnim(i) * agncd(i)) * tlim(i) &
            / (1.0 - (1.0  - tlim(i))  * agncd(i))
       !     
       !     cloudy sky ozone reflection, tauray=0.85, gcld=0.85
       !     
       taui(i) = taut(i) + 0.85
       g(i)    = 0.85 * taut(i) / taui(i)
       tlim(i) = 1.0  / (1.0 + 0.866 * (1.0 - g(i)) &
            * taui(i))
       arg1(i) = - (1.0 - g(i) * g(i)) &
            * taui(i)     * csmcld(i)
       e1(i)   = EXP(arg1(i))
    END DO
    DO i=1,ncld
       a1(i)   = b1(i) + c1(i) * e1(i)
       a1(i)   = a1(i) / (4.0 + 3.0 * (1.0 - g(i)) &
            * taui(i))
       upim(i) = 1.0          - a1(i)
       dnim(i) = a1(i)   - e1(i)
       rco(i)  = upim(i) + (e1(i)    * rsvcd(i) &
            + dnim(i) * agvcd(i)) * tlim(i) &
            / (1.0 - (1.0  - tlim(i))  * agvcd(i))
       rco(i)  = tthrd * rc1(i) + athrd * rco(i)
       !     
       !     cloudy sky ground reflection, tauray=0.15746, gcld=0.85
       !     
       taui(i) = taut(i)        + 0.15746
       g(i)    = 0.85 * taut(i) / taui(i)
       tlim(i) = 1.0  / (1.0 + 0.866 * (1.0 - g(i)) &
            * taui(i))
       arg1(i) = -(1.0 - g(i) * g(i)) &
            * taui(i)     * csmcld(i)
       e1(i)   = EXP(arg1(i))
    END DO
    DO i=1,ncld
       tr3(i)  = e1(i)
       a1(i)   = b1(i) + c1(i) * e1(i)
       a1(i)   = a1(i) / (4.0 + 3.0 * (1.0 - g(i)) &
            * taui(i))
       upim(i) = 1.0 - a1(i)
       dnim(i) = a1(i)   - e1(i)
       rcg(i)  = upim(i) + (e1(i)    * rsvcd(i) &
            + dnim(i) * agvcd(i)) * tlim(i) &
            / (1.0 - (1.0  - tlim(i))  * agvcd(i))
    END DO

    CALL cloudy (ncols ,kmax  ,scosc ,cmuc  ,csmcld,dscld ,rvbc  ,rvdc  , &
         rnbc  ,rndc  ,agvcd ,agncd ,rsvcd ,rsncd ,sc    ,rco   , &
         rcg   ,taut  ,rc2   ,tr1   ,tr2   ,tr3   ,ta    ,wa    , &
         oa    ,e0    ,pu    ,ozcd  ,swale ,swil  ,css   ,acld  , &
         dpc   ,swilc ,ccu   ,tauc  ,litd  ,sqrt3 ,gg    ,ggp   , &
         ggsq  ,np    ,lmp1  ,nsol  ,ncld  ,nclmp1,ncldnp,dooz    )

  END SUBROUTINE setsw






  SUBROUTINE swrad(ncols ,kmax  ,nls   ,dtc3  ,noz   ,icld  ,s0    ,inalb , &
       alvdf ,alndf ,alvdr ,alndr ,cosz  ,pl20  ,dpl   ,tl    , &
       ql    ,o3l   ,cld   ,clu   ,swinc ,dswclr,dswtop,ssclr , &
       ss    ,aslclr,asl   ,radvbl,radvdl,radnbl,radndl,radvbc, &
       radvdc,radnbc,radndc,clwp  ,fice  ,rei   ,taud  ,tsea    )
    !
    ! >>> inalb= 1    : input two  types surfc albedo (2 diffused)      
    !                   direct beam albedos are calculated by the subr. 
    ! >>> inalb= 2    : input four types surfc albedo (2 diff,2 direct) 
    ! >>> icld = 1    : old cloud emisivity (optical depth) setting      
    !             ccu :     0.05 *dp                                    
    !             css :     0.025*dp             for ice cloud t<253.0  
    !                       0.05 *dp             for ice cloud t>253.0  
    ! >>> icld = 2    : new cloud emisivity (optical depth) setting      
    !             ccu :     (0.16)*dp                                   
    !             css :      0.0                         t<-82.5c       
    !                       (2.0e-6*(t-tcrit)**2)*dp    -82.5<t<-10.0c  
    !                       (6.949e-3*(t-273)+.08)*dp   -10.0<t< 0.0c   
    !                       (0.08)*dp                   -10.0<t< 0.0c   
    ! >>> icld = 3    : ccm3 based cloud emisivity                       
    !
    !==========================================================================
    !   imax......Number of grid points on a gaussian latitude circle    
    !   kmax......Number of grid points at vertical   
    !   nls.......number of layers in the stratosphere.   
    !   dtc3......Coefficient for heating rate claculation dtc3 = 1.0e0
    !   noz.......Logical (true when no ozone computation)
    !   icld......Input two types of cloud emissivity
    !             =1 : old cloud emissivity setting
    !             =2 : new cloud emissivity setting
    !   s0........Solar constant  at proper sun-earth distance
    !   inalb.....Input two types of surface albedo
    !             =1 : two diffuse (beam albedos are calculated)
    !             =2 : two diffuse , and two beam albedos
    !                  avisd,anird, avisb,anirb 
    !   alvdf.....visible diffuse surface albedo  
    !   alndf.....near-ir diffuse surface albedo  
    !   alvdr.....visible diffuse surface albedo  
    !   alndr.....near-ir diffuse surface albedo   
    !   cosz......Cosine of zenith angle 
    !   pl20......Flip array of pressure at bottom of layers (mb)
    !             flip arrays (k=1 means top of atmosphere) 
    !             pl20(i,k)=gps(i)*sigml(kflip) where
    !                         gps   =  surface pressure   (mb)
    !                         sigml =  sigma coordinate at bottom of layer   
    !   dpl.......Flip array  of pressure difference bettween levels
    !             flip arrays (k=1 means top of atmosphere)     
    !   tl........Flip array of temperature in kelvin
    !   ql........Flip array of specific humidity in g/g     
    !   o3l.......Ozone mixing ratio (g/g) in 18 layers and in all latitude grids    
    !   cld.......Large scale cloud amount    
    !   clu.......cumulus cloud amount    
    !   swinc.....Solar flux at top of atmosphere  
    !   dswclr....Absorption in the clear atmosphere and at the ground 
    !   dswtop....Absorption in the cloudy atmosphere and at the ground 
    !   ssclr.....Absorption  at the ground in clear case  
    !   ss........Absorption at the ground in cloudy case     
    !   aslclr....Heating rate (clear case) (K/s) 
    !   asl.......Heating rate (cloudy case) (K/s)    
    !   radvbl....Downward Surface shortwave fluxe visible beam (clear) 
    !   radvdl....Downward Surface shortwave fluxe visible diffuse (clear)  
    !   radnbl....Downward Surface shortwave fluxe Near-IR beam (clear)
    !   radndl....Downward Surface shortwave fluxe Near-IR diffuse (clear) 
    !   radvbc....Downward Surface shortwave fluxe visible beam (cloudy) 
    !   radvdc....Downward Surface shortwave fluxe visible diffuse (cloudy)  
    !   radnbc....Downward Surface shortwave fluxe Near-IR beam (cloudy)
    !   radndc....Downward Surface shortwave fluxe Near-IR diffuse (cloudy) 
    !   clwp......   
    !   fice......Controle of change of fase of water  
    !   rei.......Determine rei as function of normalized pressure    
    !   taud......   
    !   tsea......effective surface radiative temperature ( tgeff )    
    !==========================================================================

    INTEGER, INTENT(in   ) :: ncols
    INTEGER, INTENT(in   ) :: kmax                 
    INTEGER, INTENT(in   ) :: nls                  
    REAL,    INTENT(in   ) :: dtc3
    LOGICAL, INTENT(in   ) :: noz
    INTEGER, INTENT(in   ) :: icld
    REAL,    INTENT(in   ) :: s0
    INTEGER, INTENT(in   ) :: inalb
    REAL,    INTENT(in   ) :: alvdf  (ncols)
    REAL,    INTENT(in   ) :: alndf  (ncols)
    REAL,    INTENT(inout) :: alvdr  (ncols)
    REAL,    INTENT(inout) :: alndr  (ncols)
    REAL,    INTENT(in   ) :: cosz   (ncols)
    REAL,    INTENT(in   ) :: pl20   (ncols,kmax)
    REAL,    INTENT(in   ) :: dpl    (ncols,kmax)
    REAL,    INTENT(in   ) :: tl     (ncols,kmax)
    REAL,    INTENT(in   ) :: ql     (ncols,kmax)
    REAL,    INTENT(in   ) :: o3l    (ncols,kmax)
    REAL,    INTENT(in   ) :: cld    (ncols,kmax)
    REAL,    INTENT(in   ) :: clu    (ncols,kmax)
    REAL,    INTENT(out  ) :: swinc  (ncols)
    REAL,    INTENT(out  ) :: dswclr (ncols)
    REAL,    INTENT(out  ) :: dswtop (ncols)
    REAL,    INTENT(out  ) :: ssclr  (ncols)
    REAL,    INTENT(out  ) :: ss     (ncols)
    REAL,    INTENT(out  ) :: aslclr (ncols,kmax)
    REAL,    INTENT(out  ) :: asl    (ncols,kmax)
    REAL,    INTENT(out  ) :: radvbl (ncols)
    REAL,    INTENT(out  ) :: radvdl (ncols)
    REAL,    INTENT(out  ) :: radnbl (ncols)
    REAL,    INTENT(out  ) :: radndl (ncols)
    REAL,    INTENT(out  ) :: radvbc (ncols)
    REAL,    INTENT(out  ) :: radvdc (ncols)
    REAL,    INTENT(out  ) :: radnbc (ncols)
    REAL,    INTENT(out  ) :: radndc (ncols)
    REAL,    INTENT(in   ) :: clwp   (ncols,kmax)
    REAL,    INTENT(in   ) :: fice   (ncols,kmax)
    REAL,    INTENT(in   ) :: rei    (ncols,kmax)
    REAL,    INTENT(out  ) :: taud   (ncols,kmax)
    REAL,    INTENT(in   ) :: tsea   (ncols)


    REAL                   :: sqrt3               
    REAL                   :: gg               
    REAL                   :: ggp               
    REAL                   :: ggsq               
    REAL                   :: athrd               
    REAL                   :: tthrd               
    REAL                   :: rcn1               
    REAL                   :: rcn2               
    REAL                   :: tcrit               
    REAL                   :: ecrit               
    INTEGER                :: im               
    INTEGER                :: np               
    INTEGER                :: npp1               
    INTEGER                :: lmp1               
    INTEGER                :: ls1               
    INTEGER                :: ls               
    INTEGER                :: nsol               
    INTEGER                :: nsolp1               
    INTEGER                :: nslmp1               
    INTEGER                :: nsolnp               
    INTEGER                :: ncld               
    INTEGER                :: ncldp1               
    INTEGER                :: nclmp1               
    INTEGER                :: ncldnp               
    LOGICAL                :: dooz               


    REAL                   :: scosz (ncols)           
    REAL                   :: cmu   (ncols)           
    REAL                   :: cosmag(ncols)           
    REAL                   :: dsclr (ncols)           
    REAL                   :: rvbl  (ncols)           
    REAL                   :: scosc (ncols)           
    REAL                   :: cmuc  (ncols)           
    REAL                   :: csmcld(ncols)           
    REAL                   :: dscld (ncols)           
    REAL                   :: rvbc  (ncols)           
    REAL                   :: rvdl  (ncols)           
    REAL                   :: rnbl  (ncols)           
    REAL                   :: rndl  (ncols)           
    REAL                   :: agv   (ncols)           
    REAL                   :: agn   (ncols)           
    REAL                   :: rvdc  (ncols)           
    REAL                   :: rnbc  (ncols)           
    REAL                   :: rndc  (ncols)           
    REAL                   :: agncd (ncols)           
    REAL                   :: rsurfv(ncols)           
    REAL                   :: rsurfn(ncols)           
    REAL                   :: sl    (ncols)           
    REAL                   :: sc    (ncols)           
    REAL                   :: ta    ((ncols*(kmax+1)))
    REAL                   :: wa    ((ncols*(kmax+1)))
    REAL                   :: oa    ((ncols*(kmax+1)))
    REAL                   :: pu    ((ncols*(kmax+2)))

    REAL                   :: aclr  ((ncols*(kmax+1)))
    REAL                   :: dp    ((ncols*(kmax+1)))
    REAL                   :: css   ((ncols*(kmax+1)))
    REAL                   :: acld  ((ncols*(kmax+1)))
    REAL                   :: dpc   ((ncols*(kmax+1)))
    REAL                   :: ccu   ((ncols*(kmax+1)))
    INTEGER                :: litx  ((ncols*(kmax+1)))
    INTEGER                :: listim((ncols*(kmax+2)))
    LOGICAL                :: bitx  ((ncols*(kmax+1)))
    LOGICAL                :: bitd  ((ncols*(kmax+2)))



    REAL                   :: dum(1)

    LOGICAL                :: bitn((ncols*(kmax+2)))


    REAL, PARAMETER        :: fac1=8.441874377
    REAL, PARAMETER        :: day =86400.0
    REAL, PARAMETER        :: pai =3.141592653589793
    REAL, PARAMETER        :: tice=273.16
    INTEGER                :: lm
    REAL                   :: fac
    REAL                   :: p1em9
    REAL                   :: p1em22
    REAL                   :: expcut
    INTEGER                :: i 
    INTEGER                :: k 
    INTEGER                :: il 
    INTEGER                :: nsol2 
    INTEGER                :: nsl2p1 
    INTEGER                :: nsollm
    INTEGER                :: nzercd 
    INTEGER                :: nlimwa 
    INTEGER                :: nrstwa 
    INTEGER                :: nwa1 
    INTEGER                :: l 
    INTEGER                :: l1


    dooz   = (.NOT. noz)
    lm     = kmax
    im     = ncols
    np     = (kmax+2)
    npp1   = np+1
    lmp1   = (kmax+1)
    ls1    = nls+1
    ls     = nls
    fac    = fac1  * dtc3 / day
    sqrt3  = SQRT(3.0)
    gg     = 0.85
    ggsq   = gg  * gg
    ggp    = gg  / (1.0 + gg) * 0.75
    rcn1   = 1.0 / 6.55
    rcn2   = 1.0 / 4.47238
    athrd  = 1.0 / 3.0
    tthrd  = 2.0 / 3.0
    tcrit  = tice - 82.5
    ecrit  = 0.0105125
    p1em9 = .1e-9
    p1em22= .1e-22
    acld = 0.0
    sc   = 0.0
    expcut=- LOG(1.0e53)
    CALL i8vint(1,1,listim,(ncols*(kmax+2)))
    !     
    !     set bits for daytime grid points
    !     
    dum(1)=0.01e0
    CALL r8btge(cosz,ncols,dum,1,bitx(1))
    CALL r8scnt(bitx,ncols,nsol)
    DO i = 1, im
       swinc(i)  = 0.0
       ss(i)     = 0.0
       ssclr(i)  = 0.0
       dswtop(i) = 0.0
       dswclr(i) = 0.0
       radvbl(i) = 0.0
       radvdl(i) = 0.0
       radnbl(i) = 0.0
       radndl(i) = 0.0
       radvbc(i) = 0.0
       radvdc(i) = 0.0
       radnbc(i) = 0.0
       radndc(i) = 0.0
    END DO
    DO k=1,kmax
       DO il = 1,ncols
          asl(il,k)    = 0.0
          aslclr(il,k) = 0.0
       END DO
    END DO

    IF (nsol == 0) RETURN
    nsolp1     = nsol   + 1
    nsol2      = nsol   + nsol
    nsl2p1     = nsol2  + 1
    nslmp1     = nsol   * lmp1
    nsollm     = nsol   * lm
    nsolnp     = nsol   * np
    nzercd     = nsol   * ls1
    nlimwa     = nsol   * ls
    nrstwa     = nslmp1 - nlimwa
    nwa1       = nlimwa + 1
    DO l = 1, lm
       l1 = l * im + 1
       CALL b8eq(bitx(1),bitx(l1),im)
    END DO
    DO i = 1, nsol
       pu(i) = 0.0
    END DO
    DO i = nsolp1, nsol2
       pu(i) = 0.5
    END DO
    ! CALL i8vcmp(listim,bitx,(ncols*(kmax+1)),litx,nslmp1)
    litx(1:COUNT(bitx(1:(ncols*(kmax+1))))) = PACK(listim(1:(ncols*(kmax+1))), bitx(1:(ncols*(kmax+1))))
    CALL r8vgat(pl20,(ncols*kmax),litx,pu(nsl2p1),nsollm)
    CALL r8vgat(dpl,(ncols*kmax),litx,dp(nsolp1),nsollm)
    CALL r8vgat(tl,(ncols*kmax),litx,ta(nsolp1),nsollm)
    CALL r8vgat(ql,(ncols*kmax),litx,wa(nsolp1),nsollm)
    CALL r8vgat(cld,(ncols*kmax),litx,css(nsolp1),nsollm)
    CALL r8vgat(clu,(ncols*kmax),litx,ccu(nsolp1),nsollm)
    IF (dooz) THEN
       CALL r8vgat(o3l,(ncols*kmax),litx,oa(nsolp1),nsollm)
       DO i = 1, nsol
          oa(i) = oa(nsol+i)
       END DO
       dum(1)=p1em9
       CALL vamax(dum,1,oa,nslmp1)
    END IF
    CALL r8vgat(alvdf,im,litx,agv,nsol)
    CALL r8vgat(alndf,im,litx,agn,nsol)
    CALL r8vgat(cosz ,im,litx,cmu,nsol)
    IF (inalb == 2) THEN
       CALL r8vgat(alvdr,im,litx,rsurfv,nsol)
       CALL r8vgat(alndr,im,litx,rsurfn,nsol)
    ELSE
       CALL rvacos(cmu,rvbl,nsol)
       DO i = 1, nsol
          rvdc(i)  =  -18.0 * (0.5 * pai - rvbl(i)) / pai
          rvbc(i)  =  EXP(rvdc(i))
       END DO
       DO i = 1, nsol
          rvdc(i)  = (agv(i) - 0.054313) / 0.945687
          rndc(i)  = (agn(i) - 0.054313) / 0.945687
          rsurfv(i) = rvdc(i)+(1.0-rvdc(i))*rvbc(i)
          rsurfn(i) = rndc(i)+(1.0-rndc(i))*rvbc(i)
       END DO
       DO i = 1, im
          alvdr(i) = 0.0
          alndr(i) = 0.0
       END DO
       CALL r8vsct(rsurfv,nsol,litx,alvdr,im)
       CALL r8vsct(rsurfn,nsol,litx,alndr,im)
    END IF
    DO i = 1, nsol
       dp(i) = pu(nsol+i)
       ta(i) = ta(nsol+i)
       wa(i) = wa(nsol+i)
    END DO
    DO i = 1, nslmp1
       dpc(i) = dp(i)
    END DO
    DO i = 1, nzercd
       css(i) = 0.0
       ccu(i) = 0.0
    END DO
    DO i = 1, nlimwa
       wa(i) = 3.0e-6
    END DO
    dum(1)=p1em22
    CALL vamax(dum,1,wa(nwa1),nrstwa)
    DO i = 1, nsol
       cosmag(i)  = 1224.0 * cmu(i) * cmu(i) + 1.0
    END DO
    CALL rvsqrt(cosmag,cosmag,nsol)
    DO i = 1, nsol
       cosmag(i)  = 35.0   / cosmag(i)
       scosz(i)   = s0     * cmu(i)
    END DO
    CALL r8vsct(scosz,nsol,litx,swinc,im)
    CALL setsw(ncols ,kmax  ,tice  ,icld  ,clwp  ,fice  ,rei   ,taud  , &
         tsea  ,scosz , cmu  ,cosmag,dsclr ,rvbl  ,scosc ,cmuc  , &
         csmcld,dscld ,rvbc  ,rvdl  ,rnbl  ,rndl  ,agv   ,agn   , &
         rvdc  ,rnbc  ,rndc  ,agncd ,rsurfv,rsurfn,sl    ,sc    , &
         ta    ,wa    ,oa    ,pu    ,aclr  ,dp    ,css   ,acld  , &
         dpc   ,ccu   ,litx  ,listim,bitd  ,sqrt3 ,gg    ,ggp   , &
         ggsq  ,athrd ,tthrd ,rcn1  ,rcn2  ,tcrit ,ecrit ,np    , &
         lmp1  ,nsol  ,nsolp1,nslmp1,nsolnp,ncld  ,ncldp1,nclmp1, &
         ncldnp,dooz     )

    CALL r8vsct(sl,nsol,litx,ssclr,im)
    CALL r8vsct(dsclr,nsol,litx,dswclr,im)
    IF (ncld /= 0) THEN
       CALL b8not(bitd,bitn,nslmp1)
       CALL r8vctr(aclr,nslmp1,bitn,acld,nslmp1)
       CALL r8vctr(rvbl,nsol,bitn,rvbc,nsol)
       CALL r8vctr(rvdl,nsol,bitn,rvdc,nsol)
       CALL r8vctr(rnbl,nsol,bitn,rnbc,nsol)
       CALL r8vctr(rndl,nsol,bitn,rndc,nsol)
       CALL r8vctr(sl,nsol,bitn,sc,nsol)
       CALL r8vctr(dsclr,nsol,bitn,dscld,nsol)
    END IF
    CALL r8vsct(sc,nsol,litx,ss,im)
    CALL r8vsct(dscld,nsol,litx,dswtop,im)
    CALL r8vsct(rvbc,nsol,litx,radvbc,im)
    CALL r8vsct(rvdc,nsol,litx,radvdc,im)
    CALL r8vsct(rnbc,nsol,litx,radnbc,im)
    CALL r8vsct(rndc,nsol,litx,radndc,im)
    CALL r8vsct(rvbl,nsol,litx,radvbl,im)
    CALL r8vsct(rvdl,nsol,litx,radvdl,im)
    CALL r8vsct(rnbl,nsol,litx,radnbl,im)
    CALL r8vsct(rndl,nsol,litx,radndl,im)
    CALL r8vsct(aclr(nsolp1),nsollm,litx,aslclr,(ncols*kmax))
    CALL r8vsct(acld(nsolp1),nsollm,litx,asl,(ncols*kmax))

    DO k=1,kmax
       DO i = 1, ncols
          IF (aslclr(i,k) < 1.e-22) aslclr(i,k)=0.
          aslclr(i,k) = aslclr(i,k) * fac / dpl(i,k)
          IF (asl(i,k) < 1.e-22) asl(i,k) = 0.
          asl(i,k)    = asl(i,k)    * fac / dpl(i,k)
       END DO
    END DO

  END SUBROUTINE swrad





  SUBROUTINE cldgn2 ( &
       covlp ,gps   ,sig   ,grh   ,omg   ,gtmp  ,css   ,ccu   , &
       cdin  ,cstc  ,ccon  ,cson  ,mxrdcc,lcnvl ,convc ,convt ,convb , &
       convts,convcs,convbs,ncols ,kmax  ,nls                  )

    ! parameters and input variables:                                     c
    !        covlp = 'maxi'         maximum overlap of convective cloud   c
    !                               or thick low cloud used in ir subr.   c
    !              = 'rand'         random  overlap of convective cloud   c
    !                               or thick low cloud used in ir subr.   c
    !        date  =  julian day of model forecast date                   c
    !        grh   =  relative humidity  (g/g)                            c
    !        omg   =  vertical velocity  (cb/sec)                         c
    !        gps   =  surface pressure   (mb)                             c
    !        sig   =  sigma coordinate at middle of layer                 c
    !        gtmp  =  layer temperature (k)                               c
    ! output variables:                                                   c
    !        css   =  ncols*kmax supersatuation cloud cover fraction      c
    !        ccu   =  ncols*kmax convective cloud cover fraction          c
    !
    ! values from subr-gwater:                                            c
    !       convc  =  ncols*jmax convective cloud cover in 3 hr. avrage   c
    !       convt  =  ncols*jmax convective cloud top  (sigma layer)      c
    !       convb  =  ncols*jmax convective cloud base (sigma layer)      c
    !       prcp1,prcp2,prcp3,prcpt,toplv,botlv: are used in subr "gwater"c
    !
    !==========================================================================
    !
    !
    !  :: ncols.....Number of grid points on a gaussian latitude circle
    !  :: jmax......Number of gaussian latitudes      
    !  :: kmax......Number of grid points at vertical
    !  :: nls..... .Number of layers in the stratosphere.
    !  :: cdin
    !  :: cstc......cstc=clow change necessary in order to properly mark inv 
    !               cloud height
    !  :: ccon......convc  =  ncols*jmax convective cloud cover in 3 hr. avrage 
    !  :: cson
    !  :: cp........Specific heat of air (j/kg/k)         
    !  :: gasr......Constant of dry air      (j/kg/k)   
    !  :: mxrdcc....use maximum random converage for radiative conv. clouds 
    !               constant logical mxrdcc = .true.  
    !  :: lcnvl.....the lowest layer index where non-convective clouds can
    !               occur (ben says this should be 2 or more)
    !               constant lcnvl = 2   
    !  :: convts
    !  :: convcs
    !  :: convbs
    !
    !
    INTEGER,          INTENT(in ) :: ncols
    INTEGER,          INTENT(in ) :: kmax
    INTEGER,          INTENT(in ) :: nls
    CHARACTER(len=4), INTENT(in ) :: covlp
    REAL,             INTENT(in ) :: gps (ncols)
    REAL,             INTENT(in ) :: sig (kmax)
    REAL,             INTENT(in ) :: grh (ncols,kmax)
    REAL,             INTENT(in ) :: omg (ncols,kmax)
    REAL,             INTENT(in ) :: gtmp(ncols,kmax)
    REAL,             INTENT(out) :: css (ncols,kmax)
    REAL,             INTENT(out) :: ccu (ncols,kmax)
    REAL,             INTENT(out) :: cdin(ncols,kmax)
    REAL,             INTENT(out) :: cstc(ncols,kmax)
    REAL,             INTENT(out) :: ccon(ncols,kmax)
    REAL,             INTENT(out) :: cson(ncols,kmax)

    LOGICAL,          INTENT(in ) :: mxrdcc              
    INTEGER,          INTENT(in ) :: lcnvl               
    REAL,             INTENT(in ) :: convc (ncols)       
    REAL,             INTENT(in ) :: convt (ncols)       
    REAL,             INTENT(in ) :: convb (ncols)       

    REAL,             INTENT(in ) :: convts(ncols)       
    REAL,             INTENT(in ) :: convcs(ncols)       
    REAL,             INTENT(in ) :: convbs(ncols)       


    REAL                          :: pll   (ncols,kmax)
    REAL                          :: conv  (ncols)
    REAL                          :: clow  (ncols)
    REAL                          :: cmid  (ncols)
    REAL                          :: chigh (ncols)
    INTEGER                       :: ktop  (ncols)
    INTEGER                       :: kbot  (ncols)
    INTEGER                       :: klow  (ncols)
    INTEGER                       :: kmid  (ncols)
    INTEGER                       :: khigh (ncols)
    REAL                          :: pt    (ncols)
    REAL                          :: cinv  (ncols)
    REAL                          :: delomg(ncols)
    REAL                          :: csat  (ncols,kmax)
    INTEGER                       :: ktops (ncols)
    INTEGER                       :: kbots (ncols)
    REAL                          :: convs (ncols)
    REAL                          :: convh (ncols)
    INTEGER                       :: invb  (ncols)
    REAL                          :: dthdpm(ncols)
    INTEGER                       :: i 
    INTEGER                       :: k
    INTEGER                       :: kl 
    INTEGER                       :: lon
    REAL                          :: zrth 
    REAL                          :: zrths 
    REAL                          :: arcp 
    REAL                          :: dthdp
    !
    !     dthdpm-----min (d(theta)/d(p))
    !     invb ------the base of inversion layer
    !     dthdpc-----criterion of (d(theta)/d(p))
    !     
    REAL, PARAMETER               :: dthdpc = -0.4e-1

    REAL, PARAMETER               :: f6p67= 6.67e0
    REAL, PARAMETER               :: f400p= 4.0e2
    REAL, PARAMETER               :: f700p= 7.0e2
    REAL, PARAMETER               :: f0p6 = 0.6e0
    REAL, PARAMETER               :: f0p2 = 0.2e0
    REAL, PARAMETER               :: f0p8 = 0.8e0
    REAL, PARAMETER               :: f5m5 = 5.0e-5
    REAL, PARAMETER               :: f1e4 = 1.0e+4


    DO k = 1, kmax
       DO i = 1, ncols
          css (i,k) = 0.0e0
          ccu (i,k) = 0.0e0
          csat(i,k) = 0.0e0
          cdin(i,k) = 0.0e0
          cstc(i,k) = 0.0e0
          ccon(i,k) = 0.0e0
          cson(i,k) = 0.0e0
       END DO
    END DO
    !
    !     the clouds generation scheme is based on j. slingo              c
    !     (1984 ecmwf workshop).  the scheme generates 4 type of clouds   c
    !     of convective, high, middle and low clouds.                     c
    !     
    DO kl = 1, kmax
       DO lon = 1,ncols
          pll(lon,kl) = gps(lon) * sig(kl)
       END DO
    END DO
    !
    !     initialization
    !
    DO lon = 1,ncols
       conv(lon)  = convc(lon)
       convh(lon) = convc(lon)
       clow(lon)  = 0.0
       cinv(lon)  = 0.0
       cmid(lon)  = 0.0
       chigh(lon) = 0.0
       ktop(lon)  = convt(lon)+0.5
       IF (ktop(lon).LT.1.OR.ktop(lon).GT.kmax) ktop(lon)=1
       kbot(lon)  = convb(lon)+0.5
       IF (kbot(lon).LT.1.OR.kbot(lon).GT.kmax) kbot(lon)=1
       klow(lon)  = 1
       kmid(lon)  = 1
       khigh(lon) = 1
       convs(lon) = convcs(lon)
       ktops(lon) = convts(lon)+0.5       
       IF (ktops(lon).LT.1.OR.ktops(lon).GT.kmax) ktops(lon)=1
       kbots(lon) = convbs(lon)+0.5       
       IF (kbots(lon).LT.1.OR.kbots(lon).GT.kmax) kbots(lon)=1
       !
       !     1. define convective cloud ***   done in subr-gwater
       !     cloud top and base are defined by kuo scheme: convt, convb
       !     cloud amount is calculated from precipitation rate : convc
       !     single layer clouds conputations start here, from bottom up
       !
       !     define high clouds due to strong convection
       !
       pt(lon) = gps(lon) * sig(ktop(lon))
       IF ((pt(lon) <= f400p).AND. (conv(lon) > 0.0)) THEN
          chigh(lon) = 2.*convh(lon)
          chigh(lon) = MIN(chigh(lon),1.0)
          khigh(lon) = ktop(lon) + 1
       END IF
       IF (ktop(lon)-kbot(lon) >= 1) THEN
          zrth=1./float(ktop(lon)-kbot(lon))
          conv(lon)=1.0-(1.0-conv(lon))**zrth
       END IF
       IF (ktops(lon)-kbots(lon) >= 1) THEN
          zrths=1./float(ktops(lon)-kbots(lon))
          convs(lon)=1.0-(1.0-convs(lon))**zrths
       END IF
    END DO
    !
    !     compute low stratus associated with inversions, based on ecwmf's
    !     scheme, with lower criterion of d(theta)/d(p)
    !
    arcp = gasr / cp

    DO lon = 1, ncols
       invb(lon) = MIN(kmax,kmax-nls)
       dthdpm(lon) = 0.0
    END DO

    DO kl = 2, kmax
       DO lon = 1, ncols
          IF (pll(lon,kl) > f700p) THEN
             dthdp = (gtmp(lon,kl-1)*(1000.0/pll(lon,kl-1))**arcp &
                  -gtmp(lon,kl)*(1000.0/pll(lon,kl))**arcp)/ &
                  (pll(lon,kl-1) - pll(lon,kl))
             IF (dthdp < 0.0) THEN
                invb(lon) = MIN(kl-1,invb(lon))
                IF(dthdp.LT.dthdpc) THEN
                   IF(dthdp.LT.dthdpm(lon)) THEN
                      dthdpm(lon)=dthdp
                      klow(lon)=kl
                   END IF
                END IF
             END IF
          END IF
       END DO
    END DO
    !
    !     klow change above necessary to mark inversion cloud height
    !
    DO lon = 1, ncols
       IF (dthdpm(lon) < dthdpc .AND. grh(lon,invb(lon)) > f0p6) THEN
          cinv(lon) = - f6p67 * (dthdpm(lon)-dthdpc)
          cinv(lon) = MAX(cinv(lon),0.0)
          cinv(lon) = MIN(cinv(lon),1.0)
          IF (grh(lon,invb(lon)) > f0p8) &
               cinv(lon) = cinv(lon)* &
               (1.0-(f0p8 - grh(lon,invb(lon)))/f0p2)
       END IF
       clow(lon)=cinv(lon)
       IF (conv(lon) <= 0.) THEN
          cdin(lon,klow(lon))=cinv(lon)
       END IF
    END DO
    !
    !     clow change necessary in order to properly mark inv cloud height
    !
    !     main loop for cloud amount determination
    !     
    DO kl = lcnvl+1, MIN(kmax,kmax-nls)
       DO lon = 1, ncols
          !
          !     general define cloud due to saturation
          !
          csat(lon,kl)=(grh(lon,kl) - 0.9) / .1
          csat(lon,kl)=(MAX(csat(lon,kl), 0.0)) ** 2
          IF (pll(lon,kl) < 700.) THEN
             IF (omg(lon,kl) >= f5m5) THEN
                csat(lon,kl)=0.0
             ELSE IF (omg(lon,kl) >= -f5m5) THEN
                delomg(lon) = (omg(lon,kl)+f5m5)*f1e4
                csat(lon,kl)=csat(lon,kl)*  &
                     (1.0 - delomg(lon) * delomg(lon))
             END IF
          END IF
          csat(lon,kl)=MIN(csat(lon,kl), 1.0)
          cstc(lon,kl)=csat(lon,kl)
       END DO
    END DO
    DO lon = 1, ncols
       DO kl = 1, kmax
          IF (cdin(lon,kl) > 0.) THEN
             css(lon,kmax+1-kl) = cdin(lon,kl)
          ELSE
             css(lon,kmax+1-kl) = csat(lon,kl)
          END IF
       END DO
    END DO
    !
    !     convective cloud is maximum overlaping in ir subr.
    !
    IF (covlp == 'MAXI') THEN
       DO lon = 1, ncols
          DO kl = kbot(lon), ktop(lon)
             ccu(lon,kmax-kl+1) = conv(lon)
          END DO
       END DO
       !
       !     convective cloud is random overlaping in ir subr.
       !
    ELSE IF (covlp == 'RAND') THEN

       DO lon = 1, ncols
          DO kl = kbots(lon), ktops(lon)
             IF ((conv(lon) <= 0.) .AND. (cdin(lon,kl) >= 0.)) THEN
                ccon(lon,kl)=convs(lon)
                cson(lon,kl)=convs(lon)
             END IF
          END DO
       END DO

       DO lon = 1, ncols
          DO kl = 1, kmax
             IF ((kl >= kbot(lon)) .AND. (kl <= ktop(lon))) THEN
                ccon(lon,kl)=ccon(lon,kl)+conv(lon)
             ELSE
                ccon(lon,kl)=ccon(lon,kl)
             END IF
             ccon(lon,kl)=MIN(ccon(lon,kl),1.)
             css(lon,kmax-kl+1) = MIN(1.0,css(lon,kmax-kl+1))
          END DO
       END DO

       DO lon = 1, ncols
          ccon(lon,khigh(lon))=ccon(lon,khigh(lon))+chigh(lon)
       END DO

       DO kl = 1, kmax
          DO lon = 1, ncols
             IF(mxrdcc)THEN
                css(lon,kmax-kl+1) =  &
                     (1.-ccon(lon,kl))*css(lon,kmax-kl+1) + &
                     ccon(lon,kl)
                css(lon,kmax-kl+1) = MIN(1.0,css(lon,kmax-kl+1))
             END IF
          END DO
       END DO

    END IF
  END SUBROUTINE cldgn2






  SUBROUTINE cldgen (covlp ,gps   ,sig   ,grh   ,omg   ,gtmp  ,css   , &
       ccu   ,cdin  ,cstc  ,ccon  ,cson  ,mxrdcc,lcnvl ,lthncl, &
       convc ,convt ,convb ,ncols ,kmax  ,nls            )

    !==========================================================================
    ! cldgen :perform clouds generation scheme based on j. slingo
    !         (1984 ecmwf workshop); the scheme generates 4 type of clouds
    !         of convective, high, middle and low clouds.
    !==========================================================================  
    ! parameters and input variables:                                 
    !        covlp = 'maxi'         maximum overlap of convective cloud   
    !                               or thick low cloud used in ir subr.   
    !              = 'rand'         random  overlap of convective cloud   
    !                               or thick low cloud used in ir subr.   
    !        date  =  julian day of model forecast date                   
    !        jlat  =  current latitude number in process                  
    !        grh   =  relative humidity  (g/g)                            
    !        omg   =  vertical velocity  (cb/sec)                         
    !        gps   =  surface pressure   (mb)                             
    !        sig   =  sigma coordinate at middle of layer                 
    !        gtmp  =  layer temperature (k)                               
    !     output variables:                                               
    !        css   =  ncols*kmax supersatuation cloud cover fraction       
    !        ccu   =  ncols*kmax convective cloud cover fraction           
    !---------------------------------------------------------------------
    ! values from subr-gwater                       
    !       convc  =  ncols*jmax convective cloud cover in 3 hr. avrage    
    !       convt  =  ncols*jmax convective cloud top  (sigma layer)       
    !       convb  =  ncols*jmax convective cloud base (sigma layer)       
    !       prcp1,prcp2,prcp3,prcpt,toplv,botlv: are used in subr "gwater"
    !==========================================================================
    !
    !   ncols......Number of grid points on a gaussian latitude circle
    !   kmax......Number of grid points at vertical
    !   nls..... .Number of layers in the stratosphere.
    !   cdin
    !   cstc......cstc=clow change necessary in order to properly mark inv 
    !             cloud height
    !   ccon......convc  =  ncols*jmax convective cloud cover in 3 hr. avrage 
    !   cson
    !   cp........Specific heat of air (j/kg/k)       
    !   gasr......Constant of dry air      (j/kg/k)      
    !   mxrdcc....use maximum random converage for radiative conv. clouds 
    !             constant logical mxrdcc = .true.    
    !   lcnvl.....the lowest layer index where non-convective clouds can
    !             occur (ben says this should be 2 or more)
    !             constant lcnvl = 2      
    !   lthncl....Minimum depth in mb of non-zero low level cloud 
    !             consta lthncl=80          
    !==========================================================================
    INTEGER,          INTENT(IN   ) :: ncols 
    INTEGER,          INTENT(in ) :: kmax
    INTEGER,          INTENT(in ) :: nls

    CHARACTER(len=4), INTENT(in   ) :: covlp
    REAL,             INTENT(in   ) :: gps (ncols) 
    REAL,             INTENT(in   ) :: sig (kmax)
    REAL,             INTENT(in   ) :: grh (ncols,kmax)
    REAL,             INTENT(in   ) :: omg (ncols,kmax)
    REAL,             INTENT(in   ) :: gtmp(ncols,kmax)
    REAL,             INTENT(out  ) :: css (ncols,kmax)
    REAL,             INTENT(out  ) :: ccu (ncols,kmax)
    REAL,             INTENT(out  ) :: cdin(ncols,kmax)
    REAL,             INTENT(out  ) :: cstc(ncols,kmax)
    REAL,             INTENT(out  ) :: ccon(ncols,kmax)
    REAL,             INTENT(out  ) :: cson(ncols,kmax)

    LOGICAL,          INTENT(in ) :: mxrdcc 
    INTEGER,          INTENT(in ) :: lcnvl 
    INTEGER,          INTENT(in ) :: lthncl 
    REAL,             INTENT(in ) :: convc(ncols)      
    REAL,             INTENT(in ) :: convt(ncols)      
    REAL,             INTENT(in ) :: convb(ncols)      


    !
    !     dthdpm-----min (d(theta)/d(p))
    !     invb ------the base of inversion layer
    !     dthdpc-----criterion of (d(theta)/d(p))
    !     
    REAL,    PARAMETER :: dthdpc = -0.4e-1
    REAL    :: pll   (ncols,kmax)
    REAL    :: conv  (ncols)
    REAL    :: clow  (ncols)
    REAL    :: cmid  (ncols)
    REAL    :: chigh (ncols)
    INTEGER :: ktop  (ncols)
    INTEGER :: kbot  (ncols)
    INTEGER :: klow  (ncols)
    INTEGER :: kmid  (ncols)
    INTEGER :: khigh (ncols)
    REAL    :: pt    (ncols)
    REAL    :: cx    (ncols)
    REAL    :: cinv  (ncols)
    REAL    :: delomg(ncols)
    REAL    :: csat  (ncols,kmax)
    REAL    :: dthdpm(ncols)
    INTEGER :: invb  (ncols)

    REAL, PARAMETER :: f700p= 7.0e2
    REAL, PARAMETER :: f400p= 4.0e2
    REAL, PARAMETER :: f6p67= 6.67e0
    REAL, PARAMETER :: f0p9 = 0.9e0
    REAL, PARAMETER :: f0p8 = 0.8e0
    REAL, PARAMETER :: f0p4 = 0.4e0
    REAL, PARAMETER :: f0p3 = 0.3e0
    REAL, PARAMETER :: f0p2 = 0.2e0
    REAL, PARAMETER :: f0p6 = 0.6e0
    REAL, PARAMETER :: f1e4 = 1.0e+4
    REAL, PARAMETER :: f5m5 = 5.0e-5

    INTEGER :: i 
    INTEGER :: k 
    INTEGER :: kl 
    INTEGER :: lon 
    REAL    :: arcp 
    REAL    :: dthdp 
    REAL    :: thklow


    DO k = 1, kmax
       DO i = 1, ncols
          css(i,k) = 0.0
          ccu(i,k) = 0.0
          csat(i,k) = 0.0
          cdin(i,k) = 0.0
          cstc(i,k) = 0.0
          ccon(i,k) = 0.0
          cson(i,k) = 0.0
       END DO
    END DO
    !
    !     the clouds generation scheme is based on j. slingo              
    !     (1984 ecmwf workshop).  the scheme generates 4 type of clouds   
    !     of convective, high, middle and low clouds.                     
    !     
    DO kl = 1, kmax
       DO lon = 1,ncols
          pll(lon,kl) = gps(lon) * sig(kl)
       END DO
    END DO
    !
    !     initialization
    !
    DO  lon = 1,ncols
       conv(lon)  = convc(lon)
       clow(lon)  = 0.0
       cinv(lon)  = 0.0
       cmid(lon)  = 0.0
       chigh(lon) = 0.0
       ktop(lon)  = convt(lon)+0.5
       IF (ktop(lon).LT.1.OR.ktop(lon).GT.kmax) ktop(lon)=1
       kbot(lon)  = convb(lon)+0.5
       IF (kbot(lon).LT.1.OR.kbot(lon).GT.kmax) kbot(lon)=1
       klow(lon)  = 1
       kmid(lon)  = 1
       khigh(lon) = 1
       !
       !     1. define convective cloud
       !     done in subr-gwater
       !     cloud top and base are defined by kuo scheme: convt, convb 
       !     cloud amount is calculated from precipitation rate : convc
       !     *** single layer clouds conputations start here, from bottom up
       !
       !     define high clouds due to strong convection
       !
       pt(lon) = gps(lon) * sig(ktop(lon))
       IF ((pt(lon).LE.f400p).AND.&
            (conv(lon).GE.f0p4)) THEN
          chigh(lon) = 2.0 * (conv(lon) - f0p3)
          chigh(lon) = MIN(chigh(lon),1.0)
          khigh(lon) = ktop(lon) + 1
          ccon(lon,khigh(lon))=chigh(lon)
       END IF
    END DO
    !
    !     compute low stratus associated with inversions, based on ecwmf's
    !     scheme, with lower criterion of d(theta)/d(p)
    !
    arcp = gasr / cp

    DO lon=1,ncols
       invb(lon) =  MIN(kmax, kmax-nls)
       dthdpm(lon) = 0.0
    END DO

    DO kl=2,kmax
       DO lon=1,ncols
          IF (pll(lon,kl) .GT. f700p) THEN
             dthdp = (gtmp(lon,kl-1)*(1000.0/pll(lon,kl-1))**arcp&
                  -gtmp(lon,kl)*(1000.0/pll(lon,kl))**arcp)/&
                  (pll(lon,kl-1) - pll(lon,kl))
             IF(dthdp.LT.0.0) THEN
                invb(lon) = MIN(kl-1,invb(lon))
                IF(dthdp.LT.dthdpc) THEN
                   IF(dthdp.LT.dthdpm(lon)) THEN
                      dthdpm(lon)=dthdp
                      klow(lon)=kl
                   ENDIF
                ENDIF
             ENDIF
          ENDIF
       END DO
    END DO
    !
    !     klow change above necessary to mark inversion cloud height
    !
    DO lon=1,ncols
       IF(dthdpm(lon).LT.dthdpc.AND.grh(lon,invb(lon)).GT.f0p6)THEN
          cinv(lon) = - f6p67 * (dthdpm(lon)-dthdpc)
          cinv(lon) = MAX(cinv(lon),0.0)
          cinv(lon) = MIN(cinv(lon),1.0)
          IF (grh(lon,invb(lon)) .LT. f0p8)&
               cinv(lon) = cinv(lon)*&
               (1.0-(f0p8 - grh(lon,invb(lon)))/f0p2)
       ENDIF
       clow(lon)=cinv(lon)
       cdin(lon,klow(lon))=cinv(lon)
    END DO
    !
    !     clow change necessary in order to properly mark inv cloud height
    !
    !     main loop for cloud amount determination
    !     
    DO kl = lcnvl+1, MIN(kmax, kmax-nls)
       DO lon = 1,ncols
          !
          !     general define cloud due to saturation
          !
          IF (pll(lon,kl) .GT. f400p) THEN
             cx(lon) = (grh(lon,kl) - f0p8) / f0p2
          ELSE
             cx(lon) = (grh(lon,kl) - f0p9) / 0.1
          END IF
          cx(lon) = (MAX(cx(lon), 0.0)) ** 2
          cx(lon) =  MIN(cx(lon), 1.0)
          !     
          !     start vertical process from bottom to top
          !     
          IF (pll(lon,kl) .GT. f700p) THEN
             !     
             !     2. define low cloud ***
             !     low cloud is defined one layer thick ranging from layer 3 to 700mb
             !     there are two type possible generating mechanisms. due boundary
             !     t inversion type and associated with vertical motion.
             !
             !     define low super satuated clouds but adjusted by vertical motion
             !
             IF (omg(lon,kl) .GE. f5m5) THEN
                cx(lon) = 0.0
             ELSE IF (omg(lon,kl) .GE. -f5m5) THEN
                delomg(lon) = (omg(lon,kl)+f5m5)*f1e4
                cx(lon) = cx(lon) * (1.0 - delomg(lon) * delomg(lon))
             END IF
             IF (cx(lon) .GT. clow(lon)) THEN
                klow(lon) = kl
                clow(lon) = cx(lon)
             END IF
          ELSE IF (pll(lon,kl) .GT. f400p) THEN
             !
             !     3. define middle cloud ***
             !     middle cloud is defined one layer thick between 700 and 400 mb.
             !
             !     define middle clouds only in supersaturate type
             !
             IF (cx(lon) .GT. cmid(lon)) THEN
                kmid(lon) = kl
                cmid(lon) = cx(lon)
             END IF
          ELSE
             !
             !     4. define high cloud
             !     high cloud is defined only one layer thick from 400 mb and up.
             !
             !     define high clouds due to satuation
             !     
             IF (cx(lon) .GT. chigh(lon)) THEN
                khigh(lon) = kl
                chigh(lon) = cx(lon)
             END IF
             !
             !     end of vertical computation
             !
          END IF
       END DO
    END DO
    DO lon = 1,ncols
       css(lon,kmax-khigh(lon)+1) = chigh(lon)
       cstc(lon,khigh(lon))=chigh(lon)
       css(lon,kmax-kmid(lon)+1) = cmid(lon)
       cstc(lon,kmid(lon))=cmid(lon)
       !
       !     for very thin low cloud adding its thickness
       !     pressure thickness of low cloud layer
       !
       IF(klow(lon).GE.lcnvl) THEN
          thklow=0.5*(pll(lon,klow(lon)-1)-pll(lon,klow(lon)+1))
          IF(thklow.LE.REAL(lthncl)) THEN
             css(lon,kmax-klow(lon)) = clow(lon)
             cstc(lon,klow(lon)+1)=clow(lon)
          ENDIF
          css(lon,kmax-klow(lon)+1) = clow(lon)
          cstc(lon,klow(lon))=clow(lon)
       ENDIF
    END DO
    !
    !     convective cloud is maximum overlaping in ir subr.
    !
    IF (covlp .EQ. 'MAXI') THEN
       DO lon = 1,ncols
          DO kl = kbot(lon), ktop(lon)
             ccu(lon,kmax-kl+1) = conv(lon)
          END DO
       END DO
       !
       !     convective cloud is random overlaping in ir subr.
       !
    ELSE IF (covlp .EQ. 'RAND') THEN
       DO lon = 1,ncols
          DO kl = kbot(lon), ktop(lon)
             css(lon,kmax-kl+1) = MIN(1.0,css(lon,kmax-kl+1))
             IF(mxrdcc)THEN
                css(lon,kmax-kl+1) = MAX(conv(lon),css(lon,kmax-kl+1))
                ccon(lon,kl)=conv(lon)
             END IF
          END DO
       END DO
    END IF
  END SUBROUTINE cldgen



  ! getoz  :interpolates climatological ozone data into a given latitude
  !         and model julian date.



  SUBROUTINE getoz (ncols,colrad,date  ,o3l   ,sl    ,kmax   ,nfprt ,nferr)
    !     
    ! input parameters and variables:                              
    !     date  =  model julian date                                
    !     colrad=  0-3.14 from np to sp in radians                   
    !     ozone =  ozone mixing ratio in 18 sigma layers in 5 degree 
    !     latitude interval (data)                          
    ! output variables:                                             
    !     o3l   =  18 layers ozone mixing ratio in given lat and date
    !
    !==========================================================================
    ! :: kmax.....Number of grid points at vertical
    ! :: sl.......sigma coordinate at middle of layer    
    ! :: pai......constant pi=3.1415926     
    ! :: yrl......length of year in days      
    ! :: nfprt....unidade de escrita standard print out unit    
    ! :: nferr....error print out unit    
    !==========================================================================
    !
    INTEGER, INTENT(IN   ) :: ncols
    INTEGER, INTENT(IN   ) :: kmax
    REAL,    INTENT(in   ) :: colrad(ncols)
    REAL,    INTENT(inout) :: date
    REAL,    INTENT(out  ) :: o3l(ncols,kmax)
    REAL,    INTENT(in   ) :: sl (kmax)
    !TO    REAL,    INTENT(IN   ) :: yrl       
    INTEGER, INTENT(IN   ) :: nfprt     
    INTEGER, INTENT(IN   ) :: nferr     

    REAL :: a1   (nlm_getoz)
    REAL :: a2   (nlm_getoz)
    REAL :: a3   (nlm_getoz)
    REAL :: a4   (nlm_getoz)
    REAL :: b1   (nlm_getoz)
    REAL :: b2   (nlm_getoz)
    REAL :: b3   (nlm_getoz)
    REAL :: b4   (nlm_getoz)
    REAL :: do3a (nlm_getoz)
    REAL :: do3b (nlm_getoz)
    REAL :: ozo3l(ncols,nlm_getoz)
    !TO    REAL :: ozo3l(18)

    REAL, PARAMETER :: rlag = 14.8125e0 

    INTEGER :: l
    INTEGER :: la   (ncols)
    INTEGER :: ll   (ncols) 
    INTEGER :: kmx 
    INTEGER :: imon 
    INTEGER :: isea 
    INTEGER :: k 
    INTEGER :: i 
    INTEGER :: kk    (ncols,kmax)
    REAL    :: theta 
    REAL    :: flat 
    REAL    :: rang 
    REAL    :: rsin1(ncols) 
    REAL    :: rcos1(ncols) 
    REAL    :: rcos2(ncols) 
    REAL    :: rate (ncols) 
    REAL    :: aa 
    REAL    :: bb
    LOGICAL :: notfound(kMax)

    kmx=nlm_getoz
    !
    !     find closest place in the data according to input slat.
    !
    IF(date.GT.year_getoz) date=date-year_getoz

    imon=date/mon_getoz + 1

    IF(imon.LT.1)imon=1

    isea=imon/3 + 1

    IF(isea.EQ.5) isea=1
    IF(isea.GT.5) THEN
       WRITE(nfprt,"('0 ERROR IN ISEA - TERMINATION IN SUBROUTINE GETOZ')")
       WRITE(nferr,"('0 ERROR IN ISEA - TERMINATION IN SUBROUTINE GETOZ')")
       STOP 9954
    END IF
    DO i=1,ncols
       theta = 0.5e0*1.8e2-(1.8e2/pai)*colrad(i)
       flat  = 0.2e0*theta
       la(i)    = 19.501e0-flat
       ll(i)    = 19.001e0-flat

       !
       !     find sin and cos coefficients for time interpolation.
       !
       rang=2.0e0*pai*(date-rlag)/year_getoz
       rsin1(i)=SIN(rang)
       rcos1(i)=COS(rang)
       rcos2(i)=COS(2.0e0*rang)
       rate(i)=REAL(19-ll(i))-flat
       !
       !     ozone interpolation in latitude and time
       !
    END DO
    DO k=1,kmx
       DO i=1,ncols
          a1(k) =2.5e-1*(ozone(k,la(i),1)+ozone(k,la(i),2)+ &
               ozone(k,la(i),3)+ozone(k,la(i),4))
          a2(k) =0.5e0*(ozone(k,la(i),2)-ozone(k,la(i),4))
          a3(k) =0.5e0*(ozone(k,la(i),1)-ozone(k,la(i),3))
          a4(k) =2.5e-1*(ozone(k,la(i),1)+ozone(k,la(i),3)- &
               ozone(k,la(i),2)-ozone(k,la(i),4))
          b1(k) =2.5e-1*(ozone(k,ll(i),1)+ozone(k,ll(i),2)+ &
               ozone(k,ll(i),3)+ozone(k,ll(i),4))
          b2(k) =0.5e0*(ozone(k,ll(i),2)-ozone(k,ll(i),4))
          b3(k) =0.5e0*(ozone(k,ll(i),1)-ozone(k,ll(i),3))
          b4(k) =2.5e-1*(ozone(k,ll(i),1)+ozone(k,ll(i),3)- &
               ozone(k,ll(i),2)-ozone(k,ll(i),4))
          do3a(k)=a1(k)+rsin1(i)*a2(k)+rcos1(i)*a3(k)+rcos2(i)*a4(k)
          do3b(k)=b1(k)+rsin1(i)*b2(k)+rcos1(i)*b3(k)+rcos2(i)*b4(k)
          ozo3l(i,k)=do3a(k)+rate(i)*(do3b(k)-do3a(k))
          ozo3l(i,k)=1.0e-04*ozo3l(i,k)
       END DO
    END DO
    IF(inter_getoz)THEN
       DO l=1,kmax
          notfound(l) = sl(l) > ozsig(1)
          IF (notfound(l)) THEN
             kk(1,l)=kmx
          ELSE
             kk(1,l)=2
          END IF
       END DO
       DO l=1,kmax
          IF (notfound(l)) THEN
             DO k=2,kmx
                IF(sl(l).GT.ozsig(k-1).AND.sl(l).LE.ozsig(k))THEN
                   kk(1,l)=k
                   EXIT
                END IF
             END DO
          END IF
       END DO
       DO l = 1, kmax
          DO i= 2, ncols
             kk(i,l) = kk(1,l)
          END DO
       END DO
    END IF
    IF(inter_getoz)THEN
       DO l=1,kmax
          DO i=1,ncols
             aa=(ozo3l(i,kk(i,l))-ozo3l(i,kk(i,l)-1))/(ozsig(kk(i,l))-ozsig(kk(i,l)-1))
             bb=ozo3l(i,kk(i,l)-1)-aa*ozsig(kk(i,l)-1)
             o3l(i,kmax+1-l)=bb+aa*sl(l)
          END DO
       END DO
    END IF
    IF(.NOT.inter_getoz)THEN
       DO l=1,nlm_getoz
          DO i=1,ncols
             o3l(i,l)=ozo3l(i,l)
          END DO
       END DO
    ENDIF
  END SUBROUTINE getoz



  ! radtim :calculates the astronomical parameters: solar inclination,
  !         correction factor to local time, factor relating to the distance
  !         between earth and sun, and the julian day.



  SUBROUTINE radtim (id    ,delta ,ratio ,etime ,tod   ,xday  ,nfprt , &
       nferr ,yrl)
    !
    !==========================================================================  
    !
    !==========================================================================
    !  id(1)....hour(00/12)
    !  id(2)....month
    !  id(3)....day of month
    !  id(4)....year
    !  delta....solar inclination
    !  ratio....factor relating to the distance between the earth and the sun
    !  etime....correction factor to local time
    !  tod......model forecast time of day in seconds 
    !  xday.....is julian day - 1 with fraction of day 
    !  pai......constant pi=3.1415926 
    !  nfprt....unidade de escrita standard print out unit
    !  nferr....error print out unit
    !  yrl......length of year in days
    !  monl.....length of each month in days
    !==========================================================================
    INTEGER, INTENT(in ) :: id(4)
    REAL,    INTENT(out) :: delta
    REAL,    INTENT(out) :: ratio
    REAL,    INTENT(out) :: etime
    REAL,    INTENT(in ) :: tod
    REAL,    INTENT(out) :: xday
    INTEGER, INTENT(in ) :: nfprt
    INTEGER, INTENT(in ) :: nferr
    REAL,    INTENT(in ) :: yrl

    REAL,    PARAMETER :: day0=-1.0
    REAL,    PARAMETER :: f3600=3.6e3
    REAL          :: psi

    !     
    !     id is now assumed to be the current date and hour
    !  
    xday=id(1)*f3600
    xday=xday+MOD(tod,f3600)
    xday=monday(id(2))+id(3)+xday/86400.0

    IF (yrl == 365.25e0) THEN
       xday=xday-MOD(id(4)+3,4)*.25
       IF(MOD(id(4),4).EQ.0.AND.id(2).GT.2)xday=xday+1.0e0
    END IF

    xday= MOD(xday-1.0e0,yrl)

    IF (xday > day0) THEN
       psi=2.0e0*pai*xday/yrl 
       delta=0.006918e0-0.399912e0*COS(   psi)+0.070257e0*SIN(psi) &
            -0.006758e0*COS(2.0e0*psi)+0.000907e0*SIN(2.0e0*psi) &
            -0.002697e0*COS(3.0e0*psi)+0.001480e0*SIN(3.0e0*psi)
       ratio=1.000110e0+0.034221e0*COS(   psi)+0.001280e0*SIN(psi) &
            +0.000719e0*COS(2.0e0*psi)+0.000077e0*SIN(2.0e0*psi)
       etime=0.000075e0+0.001868e0*COS(   psi)-0.032077e0*SIN(psi) &
            -0.014615e0*COS(2.0e0*psi)-0.040849e0*SIN(2.0e0*psi)
    ELSE
       WRITE(nfprt,20)id,tod,xday
       WRITE(nferr,20)id,tod,xday
       STOP 2020
    END IF

20  FORMAT(' BAD DATE IN RADTIM.  ID=',4I5,' TOD=',G16.8,' XDAY=', &
         G16.8)
  END SUBROUTINE radtim






  SUBROUTINE rqvirt(pstar ,qin   ,t     ,qout  ,relhum,sl    ,ncols , &
       kmax  )
    !
    !==========================================================================
    ! rqvirt :converts in place the current model virtual temperature to
    !         thermodynamic temperature for radiation calculation; also
    !         extrapolates moisture up into model dry layers using exponential
    !         decrease up to a minimum value.
    !         This code requires moisture defined in all layers
    !==========================================================================
    ! 
    !     input  - sfc pres (cb)      - pstar
    !               - moisture        - qin - levh lyrs only
    !               - temperature     - t   - model virtual temperature
    !     output - levs moisture lyrs - qextp
    !               - thermodynamic temperature back into t
    !               - relative humidity relhum
    !
    !==========================================================================  
    !  ncols......Number of grid points on a gaussian latitude circle
    !  kmax.......Number of grid points at vertical
    !  pstar......sfc pres (cb)  
    !  qin........moisture        - qin - levh lyrs only 
    !  t..........temperature     - t   - model virtual temperature  
    !  qout.......extrapolates moisture up into model dry layers using 
    !             exponential  decrease up to a minimum value.  
    !  relhum.....relative humidity relhum
    !  sl.........sig  = sigma coordinate at middle of layer                     
    !  delq.......constant delq = 0.608e0
    !  qmin.......constant qmin = 1.0e-12 
    !  hl.........heat of evaporation of water     (j/kg)     
    !  gasr.......gas constant of dry air        (j/kg/k)   
    !  rmwmd......fracao molar da agua e do ar seco  
    !  rmwmdi.....fracao molar 
    !  e0c........   
    !  tbase......constant tbase =  273.15e00
    !==========================================================================
    INTEGER, INTENT(IN   ) :: ncols
    INTEGER, INTENT(IN   ) :: kmax
    REAL,    INTENT(in   ) :: pstar (ncols)
    REAL,    INTENT(in   ) :: qin   (ncols,kmax) 
    REAL,    INTENT(inout) :: t     (ncols,kmax)
    REAL,    INTENT(out  ) :: qout  (ncols,kmax)
    REAL,    INTENT(out  ) :: relhum(ncols,kmax)
    REAL,    INTENT(in   ) :: sl    (kmax)

    REAL    :: qsat(ncols,kmax)
    REAL    :: prs (ncols,kmax)
    REAL    :: rrlrv 
    REAL    :: const 
    REAL    :: fac
    INTEGER :: k1 
    INTEGER :: k 
    INTEGER :: i 
    !
    !     input - sfc pres (cb) - pstar
    !              - moisture      - qin - levh lyrs only
    !              - temperature   - t   - model virtual temperature
    !     output - levs moisture lyrs - qextp
    !               - thermodynamic temperature back into t
    !               - relative humidity relhum
    !
    rrlrv = -hl/(rmwmdi*gasr)
    const = e0c*EXP(-rrlrv/tbase)
    !     
    !     convert mdl virtual temp to thermodynmic temp
    !
    WHERE (qin > 0.0)
       t = t / (1.0+delq*qin)
    END WHERE
    !
    !     get lyr pressure and then saturated moisture
    !
    DO k1 = 1, MOD(kmax,4)
       prs(:,k1) = pstar(:) * sl(k1)
    END DO
    DO k = k1, kmax, 4
       prs(:,k) = pstar(:) * sl(k)
       prs(:,k+1) = pstar(:) * sl(k+1)
       prs(:,k+2) = pstar(:) * sl(k+2)
       prs(:,k+3) = pstar(:) * sl(k+3)
    END DO
    DO k = 1, kmax
       DO i = 1, ncols
          fac = const*EXP(rrlrv/t(i,k))
          qsat(i,k)=rmwmd* fac/(prs(i,k)*10.0- (1.0-rmwmd)*fac)
       END DO
    END DO
    !
    !     limit moisture to  rh le 1. but ge .0
    !
    DO k = 1, kmax
       DO i = 1, ncols
          qout(i,k) = qin(i,k)
          relhum(i,k) = qin(i,k) / qsat(i,k)
          IF (relhum(i,k) <= 0.0) THEN
             qout(i,k) = qmin
             relhum(i,k) = qmin / qsat(i,k)
          END IF
          IF (relhum(i,k) > 1.0) THEN
             qout(i,k) = qsat(i,k)
             relhum(i,k) = 1.0
          END IF
       END DO
    END DO
  END SUBROUTINE rqvirt



  ! spmrad :calculates the cooling rate due to long wave radiation, heating
  !         rate due to short wave radiation, downward longwave radiation at
  !         the bottom, and the following relating to downward surface
  !         fluxes: visible beam cloudy skies, visible diffuse cloudy skies,
  !         near-infrared beam cloudy skies, and near-infrared diffuse
  !         cloudy skies.



  SUBROUTINE spmrad ( &
       id    , jlat  , colrad, gps   , gtmp  , gwv   , gtg   , grh   ,&
       omg   , clr   , htr   , avisd , anird , avisb , anirb , dlwbot,&
       ulwtop, dswtop, sig   , sigml , rvisd , rnird , rvisb , rnirb ,&
       inalb , trint , swint , ultclr, rsclr , dlwclr, htrc  , rvisdc,&
       rnirdc, rvisbc, rnirbc, yvisdc, ynirdc, yvisbc, ynirbc, icld  ,&
       cosz  , yvisd , ynird , yvisb , ynirb , yswtop, xvisdc, xnirdc,&
       xvisbc, xnirbc, xvisd , xnird , xvisb , xnirb , cld3  , rs    ,&
       ifday , tod   , idate , cldtd , cldin , cstcin, cldcon, cldson,&
       clwd  , emisd , taud  , tsea  , yrl   , convts, convcs,&
       convbs, mxrdcc, lcnvl , lthncl, convc , convt , convb , first ,&
       nfprt , nferr , ifprt , dodia , ndavl , co2val, delt  , nfin0 ,&
       nfin1 , nfcnv0, nls   , nlcs  , ncols , jmax  , kmax  , lonrad,&
       cos2d , intcosz)
    !
    !
    !
    !----------------------------------------------------------------------c
    !-- input parameters --------------------------------------------------c
    !----------------------------------------------------------------------c
    !     id.......date of current data
    !     id(1)....hour(00/12)
    !     id(2)....month
    !     id(3)....day of month
    !     id(4)....year
    !     jlat.....do loop count in latitudinal direction
    !              jlat=1 is for a furthest north gaussian latitude
    !     ncols....no. of grids on a gaussian latitude
    !              i=1 is at greenich
    !     ncols....ncols+(0,1 or 2)
    !     kmax.....no. of sigma levels
    !     gps......surface pressure in mb
    !     gtmp.....temperature in kelvin
    !     gwv......specific humidity in g/g
    !     gtg......ground surface temperature in kelvin
    !     avisd....visible diffuse surface albedo
    !     anird....near-ir diffuse surface albedo
    !     sinlat...sin latitude
    !     sigml....sigma coordinate at bottom of layer
    !              sigml(1)=1.0
    !     sig......sigma coordinate at middle of layer
    !     trint....ir subr. call interval in hours
    !     swint....sw subr. call interval in hours
    !              swint has to be less than or equal to trint
    !                              and mod(trint,swint)=0
    !     ifday....model forecast day
    !     tod......model forecast time of day in seconds
    !----------------------------------------------------------------------c
    !-- output parameters -------------------------------------------------c
    !----------------------------------------------------------------------c
    !     visible = 0.0 to 0.7 mu  near-ir = 0.7 to 4.0 mu
    !
    !     clr......cooling rate due to long wave radiation in deg/sec
    !     htr......heating rate due to shrt wave radiation in deg/sec
    !     dlwbot...downward longwave radiation at the bottom in w/m**2
    !
    !     the following refer to downward surface fluxes
    !     rvisb....visible beam cloudy skies
    !     rvisd....visible diffuse cloudy skies
    !     rnirb....near-ir beam cloudy skies
    !     rnird....near-ir diffuse cloudy skies
    !----------------------------------------------------------------------c
    !-- in-subroutine parameters ------------------------------------------c
    !----------------------------------------------------------------------c
    !     ptop.....pressure at top of model( for radiation only )
    !     cosz.....cosine of solar zenith angle
    !     solcon...solar constant at mean sun-earth distance
    !     swinc....solar input at top of atmosphere
    !     o3.......layer ozone mixing ratio in g/g
    !              interpolated from climatological value
    !     cld......supersaturation cloud fraction
    !     clu......convective cloud fraction
    !               above two cloud fraction should be given either as
    !               climatological value or using diagnostic relation
    !               between cloud fraction and relative humidity etc.
    !               cloud amount in ir/sw subr. is max(cld,clu)
    !     ulwtop...long wave flux at top of atmosphere in w/m**2
    !     rs.......net surface ir radiation in w/m**2
    !----------------------------------------------------------------------c
    !.. for  gtmp,gwv,clr,htr,      k=kmax means top     layer
    !..      sig,sigml,o3,cld,clu   k=1    means surface layer
    !.. for the other variables     k=1    means top     layer
    !
    !.. for  gtmp,gwv,gps           the size of first dimension is 'ncols '
    !.. for the other variables                                    'ncols'
    !
    !==========================================================================
    !    imx.......=ncols+1 or ncols+2   :this dimension instead of ncols
    !              is used in order to avoid bank conflict of memory
    !              access in fft computation and make it efficient. the
    !              choice of 1 or 2 depends on the number of banks and
    !              the declared type of grid variable (real*4,real*8)
    !              to be fourier transformed.
    !              cyber machine has the symptom.
    !              cray machine has no bank conflict, but the argument
    !              'imx' in subr. fft991 cannot be replaced by ncols 
    !    ncols......Number of grid points on a gaussian latitude circle  
    !    jmax......Number of gaussian latitudes  
    !    kmax......Number of sigma levels  
    !    nls..... .Number of layers in the stratosphere.   
    !    nlcs......nlcs =   30  
    !    ndavl.....ndavl=  100 
    !    colrad....colatitude  colrad=0-3.14 from np to sp in radians    
    !    grh.......grh   =  relative humidity  (g/g)  
    !    omg.......omg   =  vertical velocity  (cb/sec)   
    !    clr.......cooling rate due to long wave radiation in deg/sec   
    !    htr.......heating rate due to shrt wave radiation in deg/sec   
    !    avisd.....visible diffuse surface albedo
    !    anird.....near-ir diffuse surface albedo
    !    avisb.....visible beam surface albedo
    !    anirb.....near-ir beam surface albedo
    !    dlwbot....downward longwave radiation at the bottom in w/m**2
    !    ulwtop....long wave flux at top of atmosphere in w/m**2
    !    dswtop....swinc....solar input at top of atmosphere
    !    sig.......sigma coordinate at middle of layer  
    !    sigml.....sigma coordinate at bottom of layer
    !              sigml(1)=1.0 
    !    rvisb.....visible beam cloudy skies (refer to downward surface fluxes)
    !    rvisd.....visible diffuse cloudy skies (refer to downward surface fluxes)
    !    rnirb.....near-ir beam cloudy skies (refer to downward surface fluxes)
    !    rnird.....near-ir diffuse cloudy skies (refer to downward surface fluxes)
    !    inalb.....inalb Input two types of surface albedo 
    !              >>> inalb= 1 : input two  types surfc albedo (2 diffused)
    !                  direct beam albedos are calculated by the subr.
    !              >>> inalb= 2 : input four types surfc albedo (2 diff,2 direct)

    !    trint....ir subr. call interval in hours  trint=3.0e0
    !             long  wave radiation call interval in hours 
    !    swint....short wave radiation call interval in hours swint=1.0e0,
    !    ultclr...Upward lonwave flux (clear) at the top (W/m2)
    !    rsclr....Net surface longwave flux (clear) (W/m2) 
    !    dlwclr...Downward longwave (clear) At the bottom (W/m2)
    !    htrc.....Heating rate due to shortwave (clear) (K/s)   
    !    rvisdc...Visible diffuse clear sky (Refer to downward surface 
    !             shortwave fluxe)
    !    rnirdc...Near-IR diffuse clear skies (Refer to downward surface 
    !             shortwave fluxe)
    !    rvisbc...Visible beam clear sky (Refer to downward surface 
    !             shortwave fluxe)
    !    rnirbc...Near-IR beam clear skies (Refer to downward surface 
    !             shortwave fluxe)
    !    yvisdc...Downward Surface shortwave fluxe visible diffuse (clear)
    !    ynirdc...Downward Surface shortwave fluxe Near-IR diffuse (clear)
    !    yvisbc...Downward Surface shortwave fluxe visible beam (clear) 
    !    ynirbc...Downward Surface shortwave fluxe Near-IR beam (clear)
    !    icld.....>>> icld = 1    : old cloud emisivity (optical depth) setting      
    !         ccu :  0.05 *dp         
    !         css :  0.025*dp       for ice cloud t<253.0  
    !     0.05 *dp       for ice cloud t>253.0  
    !  >>> icld = 2    : new cloud emisivity (optical depth) setting      
    !         ccu :  (0.16)*dp         
    !         css :   0.0         t<-82.5c       
    !     (2.0e-6*(t-tcrit)**2)*dp    -82.5<t<-10.0c  
    !     (6.949e-3*(t-273)+.08)*dp   -10.0<t< 0.0c   
    !     (0.08)*dp       -10.0<t< 0.0c   
    !  >>> icld = 3    : ccm3 based cloud emisivity         
    !    
    !    cosz.....cosine of solar zenith angle  
    !    yvisd....Downward Surface shortwave fluxe visible diffuse (cloudy) 
    !    ynird....Downward Surface shortwave fluxe Near-IR diffuse (cloudy)  
    !    yvisb....Downward Surface shortwave fluxe visible beam (cloudy)  
    !    ynirb....Downward Surface shortwave fluxe Near-IR beam (cloudy) 
    !    yswtop...swinc....solar input at top of atmosphere
    !    xvisdc...Downward Surface shortwave fluxe visible diffuse (clear)
    !    xnirdc...Downward Surface shortwave fluxe Near-IR diffuse (clear)
    !    xvisbc...Downward Surface shortwave fluxe visible beam (clear) 
    !    xnirbc...Downward Surface shortwave fluxe Near-IR beam (clear)
    !    xvisd....Downward Surface shortwave fluxe visible diffuse (cloudy) 
    !    xnird....Downward Surface shortwave fluxe Near-IR diffuse (cloudy)  
    !    xvisb....Downward Surface shortwave fluxe visible beam (cloudy) 
    !    xnirb....Downward Surface shortwave fluxe Near-IR beam (cloudy) 
    !    cld3.....Total saturation cloud amount   
    !    rs.......net surface ir radiation in w/m**2    
    !    tod......model forecast time of day in seconds
    !    idate(4)..idate(1)=initial hour of
    !   idate(2)=day of month.
    !   idate(3)=month of year.
    !   idate(4)=year.
    !    cldtd.....Large scale cloud amount  
    !    cldin.....clow change necessary in order to properly mark inv 
    !              cloud height 
    !    cstcin
    !    cldcon....convc  =  ncols*jmax convective cloud cover in 3 hr. avrage
    !    cldson
    !    clwd  
    !    emisd.....emis(i,kflip) = 1.- EXP(-1.66*rkabs(i,k)*clwp(i,k))  
    !    taud......clwp1(i,kflip)=0.70*(tauxcl(i,k)+tauxci(i,k))
    !              clwp1(i,kflip)=1.*(tauxcl(i,k)+tauxci(i,k))
    !              taud(i,k)=clwp1(i,kflip)
    !    tsea......effective surface radiative temperature ( tgeff )  
    !    yrl.......length of year in days
    !    monl(12)..length of each month in days
    !    cp........Specific heat of air           (j/kg/k)   
    !    gasr......gas constant of dry air        (j/kg/k)   
    !    grav......gravity constant               (m/s**2)   
    !    solcon....solar constant at mean sun-earth distance(w/m**2)   
    !    co2val....co2val is wgne standard value in ppm "co2val = /345.0/   
    !    delt......time interval in sec (fixed throuh the integration)   
    !    nfin0.....input  file at time level t-dt   
    !    nfin1.....input  file at time level t   
    !    nfcnv0....initial information on convective clouds for int. radiation   
    !       
    !       
    !       
    !       
    !       
    !       
    !       
    !       
    !    dodia.....Variable logical for search for combined field components.   
    !    nfprt....standard print out unit
    !             0 no print, 1 less detail, 2 more detail, 3 most detail   
    !    nferr....error print out unit
    !             0 no print, 1 less detail, 2 more detail, 3 most detail 
    !    ifprt....print control:
    !             0 no print, 1 less detail, 2 more detail, 3 most detail 
    !    first....control logical variable .true. or .false.    
    !    mxrdcc...use maximum random converage for radiative conv. clouds
    !             constant logical mxrdcc = .true.   
    !    lcnvl....the lowest layer index where non-convective clouds can
    !             occur (ben says this should be 2 or more)
    !             constant lcnvl = 2   
    !    lthncl...Minimum depth in mb of non-zero low level cloud
    !             constant lthncl=80   
    !    convc....ncols*jmax convective cloud cover in 3 hr. avrage 
    !    convt....ncols*jmax convective cloud top  (sigma layer) 
    !    convb....ncols*jmax convective cloud base (sigma layer) 
    !    convts 
    !    convcs 
    !    convbs 
    !==========================================================================
    INTEGER, INTENT(IN   ) :: ncols  
    INTEGER, INTENT(IN   ) :: jmax   
    INTEGER, INTENT(IN   ) :: kmax   
    INTEGER, INTENT(IN   ) :: nls    
    INTEGER, INTENT(IN   ) :: nlcs   


    INTEGER, INTENT(IN   ) :: ndavl 
    INTEGER, INTENT(in   ) :: id(4)
    INTEGER, INTENT(in   ) :: jlat 
    REAL,    INTENT(in   ) :: colrad(ncols)
    REAL,    INTENT(in   ) :: lonrad(ncols)
    REAL,    INTENT(in   ) :: gps   (ncols)  
    REAL,    INTENT(in   ) :: gtmp  (ncols,kmax)
    REAL,    INTENT(in   ) :: gwv   (ncols,kmax)   
    REAL,    INTENT(in   ) :: gtg   (ncols)   
    REAL,    INTENT(in   ) :: grh   (ncols,kmax)  
    REAL,    INTENT(in   ) :: omg   (ncols,kmax) 
    REAL,    INTENT(out  ) :: clr   (ncols,kmax) 
    REAL,    INTENT(out  ) :: htr   (ncols,kmax)
    REAL,    INTENT(in   ) :: avisd (ncols)
    REAL,    INTENT(in   ) :: anird (ncols)
    REAL,    INTENT(inout) :: avisb (ncols)
    REAL,    INTENT(inout) :: anirb (ncols)
    REAL,    INTENT(out  ) :: dlwbot(ncols)
    REAL,    INTENT(out  ) :: ulwtop(ncols)
    REAL,    INTENT(out  ) :: dswtop(ncols)
    REAL,    INTENT(in   ) :: sig   (kmax)
    REAL,    INTENT(in   ) :: sigml (kmax)
    REAL,    INTENT(out  ) :: rvisd (ncols)
    REAL,    INTENT(out  ) :: rnird (ncols)   
    REAL,    INTENT(out  ) :: rvisb (ncols)
    REAL,    INTENT(out  ) :: rnirb (ncols)
    INTEGER, INTENT(in   ) :: inalb 
    REAL,    INTENT(in   ) :: trint 
    REAL,    INTENT(in   ) :: swint 
    REAL,    INTENT(out  ) :: ultclr(ncols)
    REAL,    INTENT(out  ) :: rsclr (ncols)
    REAL,    INTENT(out  ) :: dlwclr(ncols)
    REAL,    INTENT(out  ) :: htrc  (ncols,kmax)
    REAL,    INTENT(out  ) :: rvisdc(ncols)
    REAL,    INTENT(out  ) :: rnirdc(ncols)
    REAL,    INTENT(out  ) :: rvisbc(ncols)
    REAL,    INTENT(out  ) :: rnirbc(ncols)
    REAL,    INTENT(out  ) :: yvisdc(ncols)
    REAL,    INTENT(out  ) :: ynirdc(ncols)
    REAL,    INTENT(out  ) :: yvisbc(ncols)
    REAL,    INTENT(out  ) :: ynirbc(ncols)
    INTEGER, INTENT(in   ) :: icld
    REAL,    INTENT(out  ) :: cosz  (ncols)
    REAL,    INTENT(out  ) :: yvisd (ncols)
    REAL,    INTENT(out  ) :: ynird (ncols)
    REAL,    INTENT(out  ) :: yvisb (ncols)
    REAL,    INTENT(out  ) :: ynirb (ncols)
    REAL,    INTENT(out  ) :: yswtop(ncols)
    REAL,    INTENT(out  ) :: xvisdc(ncols)
    REAL,    INTENT(out  ) :: xnirdc(ncols)
    REAL,    INTENT(out  ) :: xvisbc(ncols)
    REAL,    INTENT(out  ) :: xnirbc(ncols)
    REAL,    INTENT(out  ) :: xvisd (ncols)
    REAL,    INTENT(out  ) :: xnird (ncols)
    REAL,    INTENT(out  ) :: xvisb (ncols)
    REAL,    INTENT(out  ) :: xnirb (ncols)
    REAL,    INTENT(out  ) :: cld3  (ncols)
    REAL,    INTENT(out  ) :: rs    (ncols)
    INTEGER, INTENT(in   ) :: ifday
    REAL,    INTENT(in   ) :: tod
    INTEGER, INTENT(in   ) :: idate(4)
    REAL,    INTENT(out  ) :: cldtd (ncols,kmax)
    REAL,    INTENT(out  ) :: cldin (ncols,kmax)
    REAL,    INTENT(out  ) :: cstcin(ncols,kmax)
    REAL,    INTENT(out  ) :: cldcon(ncols,kmax)
    REAL,    INTENT(out  ) :: cldson(ncols,kmax)
    REAL,    INTENT(out  ) :: clwd  (ncols,kmax)
    REAL,    INTENT(out  ) :: emisd (ncols,kmax)
    REAL,    INTENT(out  ) :: taud  (ncols,kmax)
    REAL,    INTENT(in   ) :: tsea  (ncols)
    REAL,    INTENT(in   ) :: yrl
    REAL,    INTENT(in   ) :: co2val                     
    REAL,    INTENT(in   ) :: delt                       
    INTEGER, INTENT(in   ) :: nfin0                      
    INTEGER, INTENT(in   ) :: nfin1                      
    INTEGER, INTENT(in   ) :: nfcnv0                     
    LOGICAL, INTENT(in   ) :: dodia(ndavl)               
    INTEGER, INTENT(in   ) :: nfprt                      
    INTEGER, INTENT(in   ) :: nferr                      
    INTEGER, INTENT(in   ) :: ifprt(100)                 
    LOGICAL, INTENT(in   ) :: first                      
    LOGICAL, INTENT(in   ) :: mxrdcc                     
    INTEGER, INTENT(in   ) :: lcnvl                      
    INTEGER, INTENT(in   ) :: lthncl                     
    REAL,    INTENT(in   ) :: convc (ncols)        
    REAL,    INTENT(in   ) :: convt (ncols)        
    REAL,    INTENT(in   ) :: convb (ncols)        
    REAL,    INTENT(in   ) :: convts(ncols)        
    REAL,    INTENT(in   ) :: convcs(ncols)        
    REAL,    INTENT(in   ) :: convbs(ncols)        
    REAL   , INTENT(IN   ) :: cos2d (ncols)    
    LOGICAL, INTENT(IN   ) :: intcosz
    REAL :: swinc (ncols)
    REAL :: cos2  (ncols)
    REAL :: zswtop(ncols)
    REAL :: cos1  (ncols)
    REAL :: dswclr(ncols)
    REAL :: ssclr (ncols)
    REAL :: ss    (ncols)
    REAL :: o3l18 (ncols,kmax)
    !
    !     arrays temporarily for flipping sw and lw i/o
    !
    REAL :: pl20    (ncols,kmax)
    REAL :: dpl     (ncols,kmax)
    REAL :: tl      (ncols,kmax)
    REAL :: ql      (ncols,kmax)
    REAL :: o3l     (ncols,kmax)
    REAL :: cld1    (ncols,kmax)
    REAL :: clu1    (ncols,kmax)
    REAL :: asclr   (ncols,kmax)
    REAL :: asl     (ncols,kmax)
    REAL :: pl      (ncols,kmax)
    INTEGER :: idatex(4)
    REAL :: cdin    (ncols,kmax)
    REAL :: cstc    (ncols,kmax)
    REAL :: ccon    (ncols,kmax)
    REAL :: cson    (ncols,kmax)
    REAL :: zi      (ncols,kmax+1)
    REAL :: pw      (ncols)
    REAL :: hl1     (ncols)
    REAL :: rhl     (ncols)
    REAL :: emziohl (ncols,kmax+1)
    REAL :: clwp    (ncols,kmax)
    REAL :: rei     (ncols,kmax)
    REAL :: fice    (ncols,kmax)
    REAL :: rel     (ncols,kmax)
    REAL :: sigs    (kmax)
    !
    !     locations for available diagnostics in this subroutine
    !     ozone mixing ratio                                  ndo3
    !    INTEGER         , PARAMETER :: ndo3 = 71
    !
    CHARACTER(len=4), PARAMETER :: covlp='RAND'    
    LOGICAL         , PARAMETER :: noz  = .FALSE.
    REAL            , PARAMETER :: dtc3 = 1.0e0
    REAL    :: delta
    REAL    :: ratio
    REAL    :: etime
    REAL    :: date
    REAL    :: s0
    REAL    :: sindel
    REAL    :: cosdel
    REAL    :: deltax
    REAL    :: ratiox
    REAL    :: etimex
    REAL    :: datex
    REAL    :: s0x
    REAL    :: sindlx
    REAL    :: cosdlx
    REAL    :: todx


    INTEGER :: ifdayx 
    INTEGER :: jhr 
    INTEGER :: jmon 
    INTEGER :: jday 
    INTEGER :: jyr 
    INTEGER :: ncount 
    INTEGER :: i
    INTEGER :: k 
    REAL    :: kflip
    REAL    :: coslat (ncols)
    REAL    :: sinlat (ncols)
    REAL    :: coslatx(ncols) 
    REAL    :: sinlatx(ncols) 
    REAL    :: cosmax 
    REAL    :: frh 
    REAL    :: frhx
    REAL    :: atime 
    REAL    :: atime1 
    REAL    :: rgrav 
    REAL    :: pptop 
    REAL    :: clwc0 
    REAL    :: rliq
    REAL    :: reimax 
    REAL    :: rirnge 
    REAL    :: pirnge 
    REAL    :: picemn 
    REAL    :: pnrml 
    REAL    :: weight

    ! Initialization local variables
    pw=0.0
    rgrav=0.0
    IF(ABS( MOD((tod-delt)/3.6e3+0.03125e0,swint)).GT.0.0625e0 &
         .AND..NOT.first)RETURN
    !
    !-- computation of astronomical parameters -----------------------------
    !-----------------------------------------------------------------------
    !.. delta ;solar inclination
    !.. etime ;correction factor to local time
    !.. ratio ;factor relating to the distance between the earth and the sun
    !.. date;julian day
    !
    CALL radtim (id    ,delta ,ratio ,etime ,tod   ,date  ,nfprt , &
         nferr, yrl)

    IF(jlat.EQ.1) THEN
       IF(ifprt(87).GE.2)WRITE(nfprt,100) id,date
       IF(ifprt(87).GE.2)WRITE(nfprt,101) delta,ratio,etime
    ENDIF

    ifdayx=ifday
    todx=tod+swint*3.6e3

    IF(todx.GE.86400.)THEN
       todx= MOD(todx,86400.)
       ifdayx=ifdayx+1
    END IF

    CALL tmstmp2(idate ,ifdayx,todx  ,jhr   ,jday  ,jmon  ,jyr   )

    idatex(1)=jhr
    idatex(2)=jmon
    idatex(3)=jday
    idatex(4)=jyr

    CALL radtim(idatex,deltax,ratiox,etimex,todx  ,datex ,nfprt , &
         nferr , yrl)

    s0    =solcon*ratio
    s0x   =solcon*ratiox
    sindel=SIN(delta)
    cosdel=COS(delta)
    sindlx=SIN(deltax)
    cosdlx=COS(deltax)
    DO i=1,ncols
       coslat(i)  = cosdel*SIN(colrad(i))
       sinlat(i)  = sindel*COS(colrad(i))
       coslatx(i) = cosdlx*SIN(colrad(i))
       sinlatx(i) = sindlx*COS(colrad(i))
    END DO
    cosmax=0.0e0
    ncount=0
    frh=( MOD(tod+0.03125,3.6e3)-0.03125)/3.6e3
    frhx=( MOD(todx+0.03125,3.6e3)-0.03125)/3.6e3
    DO i=1,ncols
       atime =etime+pai12*(12.0-id(1)-lonrad(i)*fim24-frh)
       atime1=etimex+pai12*(12.0-idatex(1)-lonrad(i)*fim24-frhx)
       cosz(i)=sinlat(i)  + coslat(i)  * COS(atime )
       cos1(i)=sinlatx(i) + coslatx(i) * COS(atime1)
       IF(cosz(i).GT.0.0e0) THEN
          !  cosmax =cosmax+cosz(i)
          ncount =ncount+1
       END IF
    END DO

    IF(ncount.EQ.0) ncount=1

    IF(intcosz)THEN
       !cos2=cos2/float(ncount)!!!!mudanca forcada 
       cos2=cos2d 
    ELSE  
       cos2=cosz
    END IF

    !
    !.. assign cloud amount
    !..    cld  ;large scale
    !..    clu  ;cumulus
    !-----------------------------------------------------------------------
    !-----------------------------------------------------------------------
    !.. interpolate ozone amount from climatological value
    !..    oz   ;ozon mixing ratio in g/g
    !
    CALL getoz (ncols,colrad,date  ,o3l18 ,sig   ,kmax   ,nfprt, nferr)

    IF(icld.EQ.1) &  
         CALL cldgen (covlp ,gps   ,sig   ,grh   ,omg   ,gtmp  ,cld1  , &
         clu1  ,cdin  ,cstc  ,ccon  ,cson  ,mxrdcc,lcnvl ,lthncl, &
         convc ,convt ,convb ,ncols ,kmax  ,nls     )

    IF(icld.EQ.3) &
         CALL cldgn2 ( &
         covlp ,gps   ,sig   ,grh   ,omg   ,gtmp  ,cld1  ,clu1  , &
         cdin  ,cstc  ,ccon  ,cson  ,mxrdcc,lcnvl ,convc ,convt ,convb , &
         convts,convcs,convbs,ncols ,kmax  ,nls            )
    !     
    !     compute cloud cover diagnostic
    !     
    DO i=1,ncols
       cld3(i) = 1.0e0
       IF(icld.EQ.3)pw(i)=0.0
    END DO

    DO k=1,kmax
       DO i=1,ncols
          cld3(i) = cld3(i)*(1.0e0-cld1(i,k))
       END DO
    END DO

    DO i=1,ncols
       cld3(i) = 1.0e0-cld3(i)
    END DO

    DO k=1,kmax
       kflip=kmax+1-k
       DO i=1,ncols
          cldtd(i,k)=0.0
          cldtd(i,k)=cld1(i,kflip)
       END DO
    END DO
    DO k=1,kmax
       DO i=1,ncols
          cldin(i,k)=0.0
          cstcin(i,k)=0.0
          cldcon(i,k)=0.0
          cldson(i,k)=0.0
          clwd(i,k)=0.0
          cldin(i,k)=cdin(i,k)
          cstcin(i,k)=cstc(i,k)
          cldcon(i,k)=ccon(i,k)
          cldson(i,k)=cson(i,k)
       END DO
    END DO
    DO k=1,kmax
       DO i=1,ncols
          o3l(i,k)=o3l18(i,k)
       END DO
    END DO
    !
    !     save ozone mixing ratio if requested
    !
    IF(dodia(ndo3))THEN
       DO k=1,kmax
          kflip=kmax+1-k
          DO i = 1,ncols
             tl(i,k)=o3l18(i,kflip)
          END DO
       END DO
       CALL updia(tl,ndo3,jlat)
    END IF
    !     
    !     prepare pressure input and flip arrays for short and long wave
    !     
    IF(icld.EQ.3)THEN
       DO k=1,kmax-1
          sigs(k)=0.0
          sigs(k)=sigml(k)-sigml(k+1)
       END DO
       sigs(kmax)=sigml(kmax)
       rgrav=1./grav
    ENDIF
    DO k=1,kmax
       kflip=kmax+1-k
       DO i = 1,ncols
          tl(i,k)=gtmp(i,kflip)
          ql(i,k)=gwv (i,kflip)
          pl20(i,k)=gps(i)*sigml(kflip)
          pl  (i,k)=gps(i)*sig  (kflip)
          IF(icld.EQ.3)pw(i) = pw(i) + sigs(k)*gwv(i,k)
       END DO
    END DO
    pptop=0.5e0
    DO i = 1,ncols
       dpl(i,1)=pl20(i,1)-pptop
       IF(icld.EQ.3)pw(i)=100.*pw(i)*gps(i)*rgrav
    END DO
    DO k=2,kmax
       DO i = 1,ncols
          dpl(i,k)=pl20(i,k)-pl20(i,k-1)
       END DO
    END DO
    IF(icld.EQ.3)THEN
       DO i=1,ncols
          zi(i,1)=0.0
       END DO
       DO k=2,kmax
          DO i=1,ncols
             zi(i,k)=zi(i,k-1)+(gasr/grav)*gtmp(i,k-1)* &
                  LOG(pl20(i,kmax+2-k)/pl20(i,kmax+1-k))
          END DO
       END DO
       !
       !     need to estimate the height of the model top
       !     
       DO i=1,ncols
          zi(i,kmax+1)=zi(i,kmax)+(gasr/grav)*gtmp(i,kmax)* &
               LOG(pl20(i,1)/pptop)
       END DO
       !
       !     now to compute the cloud liquid water path
       !     set reference liquid water concentration
       !     
       clwc0 = 0.21
       !
       !     diagnose liquid water scale height from precipitable water
       !     
       DO i=1,ncols
          hl1(i)  = 700.0*LOG(MAX(pw(i)+1.0,1.0))
          rhl(i) = 1.0/hl1(i)
       END DO
       DO k=1,(kmax+1)
          DO i=1,ncols
             emziohl(i,k) = EXP(-zi(i,k)*rhl(i))
          END DO
       END DO

       DO k=1,kmax
          DO i=1,ncols
             clwp(i,k) = clwc0*hl1(i)*(emziohl(i,k) - emziohl(i,k+1))
             clwd(i,k)=clwp(i,k)
          END DO
       END DO

       DO k=1,kmax
          DO i=1,ncols
             rliq = 10.0
             rel(i,k) = rliq
             !     
             !     determine rei as function of normalized pressure
             !     
             reimax   = 30.0
             rirnge   = 20.0
             pirnge   = 0.4
             picemn   = 0.4
             pnrml    = sig(k)
             weight   = MAX(MIN((pnrml-picemn)/pirnge,1.0),0.)
             rei(i,k) = reimax - rirnge*weight
             !     
             !     define fractional amount of cloud that is ice
             !     if warmer than -10 degrees c then water phase
             !     
             IF(gtmp(i,k).GT.263.16) fice(i,k) = 0.0
             !
             !     if colder than -10 degrees c but warmer than -30 c mixed phase
             !     
             IF (gtmp(i,k).LE.263.16.AND.gtmp(i,k).GE.243.16) THEN
                fice(i,k) =(263.16-gtmp(i,k)) / 20.0
             END IF
             !     
             !     if colder than -30 degrees c then ice phase
             !     
             IF (gtmp(i,k).LT.243.16) fice(i,k) = 1.0
          END DO
       END DO
    ENDIF
    !
    !     shortwave radiation
    !
    IF(first.AND.ifday.EQ.0.AND.tod.EQ.0.0) THEN
       CALL swrad(ncols ,kmax  ,nls   ,dtc3  ,noz   ,icld  ,s0    ,inalb , &
            avisd ,anird ,avisb ,anirb ,cos2  ,pl20  ,dpl   ,tl    , &
            ql    ,o3l   ,cld1  ,clu1  ,swinc ,dswclr,zswtop,ssclr , &
            ss    ,asclr ,asl   ,xvisbc,xvisdc,xnirbc,xnirdc,xvisb , &
            xvisd ,xnirb ,xnird ,clwp  ,fice  ,rei   ,taud  ,tsea    )

       IF(jlat.EQ.jmax/2+1.AND.ifprt(87).GE.1)WRITE(nfprt,70)icld
    END IF

    IF(first.AND.(nfcnv0.EQ.0.OR.(nfcnv0.NE.0.AND.nfin0.EQ. &
         nfin1)))THEN
       CALL swrad(ncols ,kmax  ,nls   ,dtc3  ,noz   ,icld  ,s0    ,inalb , &
            avisd ,anird ,avisb ,anirb ,cosz  ,pl20  ,dpl   ,tl    , &
            ql    ,o3l   ,cld1  ,clu1  ,swinc ,dswclr,zswtop,ssclr , &
            ss    ,asclr ,asl   ,rvisbc,rvisdc,rnirbc,rnirdc,rvisb , &
            rvisd ,rnirb ,rnird ,clwp  ,fice  ,rei   ,taud  ,tsea    )

       DO i=1,ncols
          dswtop(i)=swinc (i)
       END DO

       IF(jlat.EQ.jmax/2+1.AND.ifprt(87).GE.1) WRITE(nfprt,765)ifday,tod

    END IF

    CALL swrad(ncols ,kmax  ,nls   ,dtc3  ,noz   ,icld  ,s0x   ,inalb , &
         avisd ,anird ,avisb ,anirb ,cos1  ,pl20  ,dpl   ,tl    , &
         ql    ,o3l   ,cld1  ,clu1  ,swinc ,dswclr,zswtop,ssclr , &
         ss    ,asclr ,asl   ,yvisbc,yvisdc,ynirbc,ynirdc,yvisb , &
         yvisd ,ynirb ,ynird ,clwp  ,fice  ,rei   ,taud  ,tsea    )

    DO k=1,kmax
       DO i=1,ncols
          htr(i,k)=asl(i,kmax+1-k)
          htrc(i,k)=asclr(i,kmax+1-k)
       END DO
    END DO

    DO i=1,ncols
       yswtop(i)=swinc (i)
    END DO

    IF(jlat.EQ.jmax/2+1.AND.ifprt(87).GE.2)WRITE(nfprt,765)ifday,tod
    !
    !     longwave radiation
    !
    IF(ABS( MOD((tod-delt)/3.6e3+0.03125e0,trint)).LE.0.0625e0 &
         .OR.first)THEN

       CALL lwrad( dtc3  ,noz   ,icld  ,gtg   ,pl20  ,pl    ,tl    ,ql    , &
            o3l   ,cld1  ,clu1  ,ultclr,ulwtop,asclr ,asl   ,rsclr , &
            rs    ,dlwclr,dlwbot,clwp  ,fice  ,rei   ,emisd ,co2val, &
            ncols ,kmax  ,nls   ,nlcs                                   ) 



       DO k=1,kmax
          DO i = 1,ncols
             clr(i,k)=asl(i,kmax+1-k)
          END DO
       END DO
    ENDIF

70  FORMAT(' SWRAD COMPUTED AT ZENITH WITH ICLD=',I2)
100 FORMAT(' RADTIM CALLED AT ID=',3I3,I5,',JULDAY=',G16.8)
101 FORMAT(' DELTA=',E12.5,' RATIO=',E12.5,' ETIME=',E12.5)
765 FORMAT(' SHORT WAVE RADIATION CALLED AT DAY=',I8,' TIME=',G13.6)
766 FORMAT(' LONG WAVE RADIATION CALLED AT DAY=',I8,' TIME=',G13.6)
  END SUBROUTINE spmrad
END MODULE Radiation
